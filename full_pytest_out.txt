Warning - Certain functionality
             requires requests_html, which is not installed.

             Install using:
             pip install requests_html

             After installation, you may have to restart your Python session.
...2025-09-25 15:07:44,424 - app.analytics.backtest.backtester - ERROR - 回测执行失败: invalid value encountered in scalar divide
F2025-09-25 15:07:44,577 - app.analytics.backtest.backtester - ERROR - 回测执行失败: invalid value encountered in scalar divide
F2025-09-25 15:07:44,738 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/admin/clear-cache "HTTP/1.1 200 OK"
.2025-09-25 15:07:44,751 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/admin/clear-cache "HTTP/1.1 500 Internal Server Error"
.2025-09-25 15:07:44,761 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/admin/clear-cache "HTTP/1.1 500 Internal Server Error"
.2025-09-25 15:07:44,771 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/admin/clear-cache "HTTP/1.1 200 OK"
.2025-09-25 15:07:44,780 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/admin/clear-cache "HTTP/1.1 200 OK"
.2025-09-25 15:07:44,795 - app.infrastructure.cache.redis_manager - INFO - Redis connection established successfully
2025-09-25 15:07:44,797 - app.infrastructure.cache.redis_manager - INFO - Batch deleted 2 keys matching pattern: stock:info:000001*
2025-09-25 15:07:44,797 - app.infrastructure.cache.cache_service - INFO - Invalidated 2 cache entries for pattern: stock:info:000001*
2025-09-25 15:07:44,799 - app.infrastructure.cache.cache_service - INFO - Invalidated 0 cache entries for pattern: stock:daily:000001*
2025-09-25 15:07:44,800 - app.infrastructure.cache.cache_service - INFO - Invalidated 0 cache entries for pattern: stock:metrics:000001*
2025-09-25 15:07:44,800 - app.infrastructure.cache.cache_service - INFO - Invalidated cache for stock: 000001
.2025-09-25 15:07:44,806 - app.infrastructure.cache.redis_manager - INFO - Batch deleted 1 keys matching pattern: stock:info:test:expiration:001*
2025-09-25 15:07:44,806 - app.infrastructure.cache.cache_service - INFO - Invalidated 1 cache entries for pattern: stock:info:test:expiration:001*
2025-09-25 15:07:44,806 - app.infrastructure.cache.cache_service - INFO - Invalidated 0 cache entries for pattern: stock:daily:test:expiration:001*
2025-09-25 15:07:44,806 - app.infrastructure.cache.cache_service - INFO - Invalidated 0 cache entries for pattern: stock:metrics:test:expiration:001*
2025-09-25 15:07:44,806 - app.infrastructure.cache.cache_service - INFO - Invalidated cache for stock: test:expiration:001
.2025-09-25 15:07:44,819 - app.infrastructure.cache.redis_manager - INFO - Batch deleted 2 keys matching pattern: stock:info:stock:info:000001*
2025-09-25 15:07:44,819 - app.infrastructure.cache.cache_service - INFO - Invalidated 2 cache entries for pattern: stock:info:stock:info:000001*
2025-09-25 15:07:44,819 - app.infrastructure.cache.cache_service - INFO - Invalidated 0 cache entries for pattern: stock:daily:stock:info:000001*
2025-09-25 15:07:44,819 - app.infrastructure.cache.cache_service - INFO - Invalidated 0 cache entries for pattern: stock:metrics:stock:info:000001*
2025-09-25 15:07:44,819 - app.infrastructure.cache.cache_service - INFO - Invalidated cache for stock: stock:info:000001
2025-09-25 15:07:44,820 - app.infrastructure.cache.redis_manager - INFO - Batch deleted 2 keys matching pattern: stock:info:stock:info:000002*
2025-09-25 15:07:44,820 - app.infrastructure.cache.cache_service - INFO - Invalidated 2 cache entries for pattern: stock:info:stock:info:000002*
2025-09-25 15:07:44,820 - app.infrastructure.cache.cache_service - INFO - Invalidated 0 cache entries for pattern: stock:daily:stock:info:000002*
2025-09-25 15:07:44,820 - app.infrastructure.cache.cache_service - INFO - Invalidated 0 cache entries for pattern: stock:metrics:stock:info:000002*
2025-09-25 15:07:44,820 - app.infrastructure.cache.cache_service - INFO - Invalidated cache for stock: stock:info:000002
2025-09-25 15:07:44,820 - app.infrastructure.cache.redis_manager - INFO - Batch deleted 1 keys matching pattern: stock:info:stock:data:000001*
2025-09-25 15:07:44,820 - app.infrastructure.cache.cache_service - INFO - Invalidated 1 cache entries for pattern: stock:info:stock:data:000001*
2025-09-25 15:07:44,821 - app.infrastructure.cache.cache_service - INFO - Invalidated 0 cache entries for pattern: stock:daily:stock:data:000001*
2025-09-25 15:07:44,821 - app.infrastructure.cache.cache_service - INFO - Invalidated 0 cache entries for pattern: stock:metrics:stock:data:000001*
2025-09-25 15:07:44,821 - app.infrastructure.cache.cache_service - INFO - Invalidated cache for stock: stock:data:000001
2025-09-25 15:07:44,821 - app.infrastructure.cache.redis_manager - INFO - Batch deleted 1 keys matching pattern: stock:info:other:data:001*
2025-09-25 15:07:44,821 - app.infrastructure.cache.cache_service - INFO - Invalidated 1 cache entries for pattern: stock:info:other:data:001*
2025-09-25 15:07:44,821 - app.infrastructure.cache.cache_service - INFO - Invalidated 0 cache entries for pattern: stock:daily:other:data:001*
2025-09-25 15:07:44,821 - app.infrastructure.cache.cache_service - INFO - Invalidated 0 cache entries for pattern: stock:metrics:other:data:001*
2025-09-25 15:07:44,821 - app.infrastructure.cache.cache_service - INFO - Invalidated cache for stock: other:data:001
.2025-09-25 15:07:44,827 - app.infrastructure.cache.cache_warming - DEBUG - A股缓存检查结果: True, force=True
2025-09-25 15:07:44,829 - app.infrastructure.cache.cache_warming - DEBUG - 从数据库查询到 0 只A股
2025-09-25 15:07:44,829 - app.infrastructure.cache.cache_warming - DEBUG - A股缓存设置结果: True
2025-09-25 15:07:44,829 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached A-share list with 0 stocks
2025-09-25 15:07:44,829 - app.infrastructure.cache.cache_warming - DEBUG - 美股缓存检查结果: True, force=True
2025-09-25 15:07:44,830 - app.infrastructure.cache.cache_warming - DEBUG - 从数据库查询到 0 只美股
2025-09-25 15:07:44,830 - app.infrastructure.cache.cache_warming - DEBUG - 美股缓存设置结果: True
2025-09-25 15:07:44,830 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached US stock list with 0 stocks
2025-09-25 15:07:44,830 - app.infrastructure.cache.cache_warming - INFO - 股票列表预热完成: 2 个列表
.2025-09-25 15:07:44,840 - app.infrastructure.cache.cache_warming - DEBUG - A股缓存检查结果: True, force=True
2025-09-25 15:07:44,843 - app.infrastructure.cache.cache_warming - DEBUG - 从数据库查询到 0 只A股
2025-09-25 15:07:44,844 - app.infrastructure.cache.cache_warming - DEBUG - A股缓存设置结果: True
2025-09-25 15:07:44,844 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached A-share list with 0 stocks
2025-09-25 15:07:44,844 - app.infrastructure.cache.cache_warming - DEBUG - 美股缓存检查结果: True, force=True
2025-09-25 15:07:44,844 - app.infrastructure.cache.cache_warming - DEBUG - 从数据库查询到 0 只美股
2025-09-25 15:07:44,844 - app.infrastructure.cache.cache_warming - DEBUG - 美股缓存设置结果: True
2025-09-25 15:07:44,844 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached US stock list with 0 stocks
2025-09-25 15:07:44,844 - app.infrastructure.cache.cache_warming - INFO - 股票列表预热完成: 2 个列表
.2025-09-25 15:07:44,850 - app.infrastructure.cache.cache_warming - DEBUG - A股缓存检查结果: True, force=True
2025-09-25 15:07:44,853 - app.infrastructure.cache.cache_warming - DEBUG - 从数据库查询到 0 只A股
2025-09-25 15:07:44,853 - app.infrastructure.cache.cache_warming - DEBUG - A股缓存设置结果: True
2025-09-25 15:07:44,853 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached A-share list with 0 stocks
2025-09-25 15:07:44,853 - app.infrastructure.cache.cache_warming - DEBUG - 美股缓存检查结果: True, force=True
2025-09-25 15:07:44,854 - app.infrastructure.cache.cache_warming - DEBUG - 从数据库查询到 0 只美股
2025-09-25 15:07:44,854 - app.infrastructure.cache.cache_warming - DEBUG - 美股缓存设置结果: True
2025-09-25 15:07:44,854 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached US stock list with 0 stocks
2025-09-25 15:07:44,854 - app.infrastructure.cache.cache_warming - INFO - 股票列表预热完成: 2 个列表
2025-09-25 15:07:44,856 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached stock info for 000001.SZ
2025-09-25 15:07:44,857 - app.infrastructure.cache.cache_warming - ERROR - Failed to update 000001.SZ: float() argument must be a string or a real number, not 'Mock'
2025-09-25 15:07:44,858 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached stock info for 000002.SZ
2025-09-25 15:07:44,858 - app.infrastructure.cache.cache_warming - ERROR - Failed to update 000002.SZ: float() argument must be a string or a real number, not 'Mock'
.2025-09-25 15:07:44,877 - app.infrastructure.cache.cache_warming - DEBUG - A股缓存检查结果: True, force=True
2025-09-25 15:07:44,879 - app.infrastructure.cache.cache_warming - DEBUG - 从数据库查询到 0 只A股
2025-09-25 15:07:44,879 - app.infrastructure.cache.cache_warming - DEBUG - A股缓存设置结果: True
2025-09-25 15:07:44,879 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached A-share list with 0 stocks
2025-09-25 15:07:44,879 - app.infrastructure.cache.cache_warming - DEBUG - 美股缓存检查结果: True, force=True
2025-09-25 15:07:44,880 - app.infrastructure.cache.cache_warming - DEBUG - 从数据库查询到 0 只美股
2025-09-25 15:07:44,880 - app.infrastructure.cache.cache_warming - DEBUG - 美股缓存设置结果: True
2025-09-25 15:07:44,880 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached US stock list with 0 stocks
2025-09-25 15:07:44,880 - app.infrastructure.cache.cache_warming - INFO - 股票列表预热完成: 2 个列表
.2025-09-25 15:07:44,897 - app.infrastructure.monitoring.performance_monitor - INFO - 统计信息已重置: cache=None, endpoint=None
.2025-09-25 15:07:44,901 - app.infrastructure.monitoring.performance_monitor - INFO - 统计信息已重置: cache=None, endpoint=None
.2025-09-25 15:07:44,903 - app.infrastructure.monitoring.performance_monitor - INFO - 统计信息已重置: cache=None, endpoint=None
.2025-09-25 15:07:45,052 - app.infrastructure.cache.cache_warming - DEBUG - A股缓存检查结果: True, force=True
2025-09-25 15:07:45,060 - app.infrastructure.cache.cache_warming - DEBUG - 从数据库查询到 0 只A股
2025-09-25 15:07:45,182 - app.infrastructure.cache.cache_warming - DEBUG - A股缓存设置结果: True
2025-09-25 15:07:45,182 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached A-share list with 0 stocks
2025-09-25 15:07:45,182 - app.infrastructure.cache.cache_warming - DEBUG - 美股缓存检查结果: True, force=True
2025-09-25 15:07:45,182 - app.infrastructure.cache.cache_warming - DEBUG - 从数据库查询到 0 只美股
2025-09-25 15:07:45,183 - app.infrastructure.cache.cache_warming - DEBUG - 美股缓存设置结果: True
2025-09-25 15:07:45,183 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached US stock list with 0 stocks
2025-09-25 15:07:45,183 - app.infrastructure.cache.cache_warming - INFO - 股票列表预热完成: 2 个列表
2025-09-25 15:07:45,183 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已停止
.100个并发缓存操作完成时间: 0.01秒
.......2025-09-25 15:07:45,282 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Could not find a valid code column for bj. Skipping.
2025-09-25 15:07:45,283 - app.data.fetchers.stock_fetchers.a_share_fetcher - ERROR - Failed to fetch ETF list from Akshare: '代码'
2025-09-25 15:07:45,288 - app.data.fetchers.stock_fetchers.a_share_fetcher - INFO - Successfully upserted 3 stocks and ETFs into the database.
.2025-09-25 15:07:45,317 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching S&P 500 tickers...
2025-09-25 15:07:45,317 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 2 S&P 500 tickers.
2025-09-25 15:07:45,317 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching NASDAQ tickers...
2025-09-25 15:07:45,317 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 2 NASDAQ tickers.
2025-09-25 15:07:45,317 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching Dow Jones tickers...
2025-09-25 15:07:45,317 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 1 Dow Jones tickers.
2025-09-25 15:07:45,317 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching other US (NYSE/AMEX/etc.) tickers...
2025-09-25 15:07:45,317 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 1 other US (NYSE/AMEX/etc.) tickers.
2025-09-25 15:07:45,317 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Total unique symbols fetched from yahoo_fin: 6
2025-09-25 15:07:45,317 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Total qualified symbols after filtering: 6
2025-09-25 15:07:45,320 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully upserted 6 US stock entries into DB.
2025-09-25 15:07:45,320 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Starting to update US stock names from yfinance...
2025-09-25 15:07:45,322 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Found 6 US stocks to update names
2025-09-25 15:07:48,018 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully updated 6 US stock names from yfinance
.2025-09-25 15:07:48,135 - app.data.managers.database_writer - WARNING - Fundamental data quality issues for MSFT: 校验报告: 数据无效, 质量评分: 0.40, 错误: 3 个, 警告: 0 个, 执行时间: 0.000 秒
2025-09-25 15:07:48,136 - app.data.managers.database_writer - ERROR - Validation error: 必填字段 'code' 缺失
2025-09-25 15:07:48,136 - app.data.managers.database_writer - ERROR - Validation error: 必填字段 'date' 缺失
2025-09-25 15:07:48,136 - app.data.managers.database_writer - ERROR - Validation error: 必填字段 'close' 缺失
2025-09-25 15:07:48,372 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:48,379 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:07:48,379 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:07:48,381 - app.data.managers.database_writer - INFO - Successfully upserted fundamental data for MSFT.
2025-09-25 15:07:48,473 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:48,475 - app.data.quality.quality_manager - INFO - 开始处理数据质量，数据量: 1
2025-09-25 15:07:48,476 - app.infrastructure.logging_service - INFO - [pipeline] 开始处理 1 条 A_share 数据
2025-09-25 15:07:48,478 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 1 条记录
2025-09-25 15:07:48,478 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:07:49,480 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量处理完成
2025-09-25 15:07:49,488 - app.data.quality.quality_manager - INFO - 数据质量处理完成，耗时: 1.00秒
2025-09-25 15:07:49,644 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:49,645 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:07:49,646 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:07:49,745 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:49,748 - app.data.quality.quality_manager - INFO - 开始处理数据质量，数据量: 1
2025-09-25 15:07:49,748 - app.infrastructure.logging_service - INFO - [pipeline] 开始处理 1 条 A_share 数据
2025-09-25 15:07:49,749 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 1 条记录
2025-09-25 15:07:49,750 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:07:50,756 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量处理完成
2025-09-25 15:07:50,758 - app.data.quality.quality_manager - INFO - 数据质量处理完成，耗时: 1.01秒
2025-09-25 15:07:50,892 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:50,896 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:07:50,896 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:07:50,988 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:50,990 - app.data.managers.database_admin - INFO - Cleared 1 fundamental data records.
2025-09-25 15:07:50,990 - app.data.managers.database_admin - INFO - Cleared 1 corporate action records.
2025-09-25 15:07:50,991 - app.data.managers.database_admin - INFO - Cleared 1 annual earning records.
.2025-09-25 15:07:51,035 - app.data.quality.quality_manager - INFO - 开始处理数据质量，数据量: 2
2025-09-25 15:07:51,035 - app.infrastructure.logging_service - INFO - [pipeline] 开始处理 2 条 A_share 数据
2025-09-25 15:07:51,037 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 2 条记录
2025-09-25 15:07:51,037 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.04MB
2025-09-25 15:07:51,037 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 2 条，去重后 1 条
2025-09-25 15:07:52,042 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量处理完成
2025-09-25 15:07:52,048 - app.data.quality.quality_manager - INFO - 数据质量处理完成，耗时: 1.01秒
2025-09-25 15:07:52,049 - app.data.managers.database_writer - INFO - Data quality summary for TEST.SH: 去重报告: 处理了 2 条记录, 发现 2 个重复, 移除了 1 个重复记录, 执行时间: 0.00 秒
2025-09-25 15:07:52,283 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:52,290 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:07:52,290 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:07:52,375 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:07:52,420 - app.data.quality.quality_manager - INFO - 开始处理数据质量，数据量: 2
2025-09-25 15:07:52,420 - app.infrastructure.logging_service - INFO - [pipeline] 开始处理 2 条 A_share 数据
2025-09-25 15:07:52,421 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 2 条记录
2025-09-25 15:07:52,421 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:07:52,421 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 2 条，去重后 1 条
2025-09-25 15:07:53,425 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量处理完成
2025-09-25 15:07:53,426 - app.data.quality.quality_manager - INFO - 数据质量处理完成，耗时: 1.01秒
2025-09-25 15:07:53,426 - app.data.managers.database_writer - INFO - Data quality summary for TEST.SH: 去重报告: 处理了 2 条记录, 发现 2 个重复, 移除了 1 个重复记录, 执行时间: 0.00 秒
2025-09-25 15:07:53,503 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:53,505 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:07:53,505 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:07:53,574 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:53,577 - app.data.quality.quality_manager - INFO - 开始处理数据质量，数据量: 2
2025-09-25 15:07:53,577 - app.infrastructure.logging_service - INFO - [pipeline] 开始处理 2 条 A_share 数据
2025-09-25 15:07:53,578 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 2 条记录
2025-09-25 15:07:53,578 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:07:53,578 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 2 条，去重后 1 条
2025-09-25 15:07:54,586 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量处理完成
2025-09-25 15:07:54,599 - app.data.quality.quality_manager - INFO - 数据质量处理完成，耗时: 1.01秒
2025-09-25 15:07:54,600 - app.data.managers.database_writer - INFO - Data quality summary for TEST.SH: 去重报告: 处理了 2 条记录, 发现 2 个重复, 移除了 1 个重复记录, 执行时间: 0.00 秒
2025-09-25 15:07:54,781 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:54,783 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:07:54,784 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:07:54,872 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:07:54,919 - app.data.quality.quality_manager - INFO - 开始处理数据质量，数据量: 2
2025-09-25 15:07:54,919 - app.infrastructure.logging_service - INFO - [pipeline] 开始处理 2 条 A_share 数据
2025-09-25 15:07:54,921 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 2 条记录
2025-09-25 15:07:54,921 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:07:54,922 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 2 条，去重后 1 条
2025-09-25 15:07:55,927 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量处理完成
2025-09-25 15:07:55,929 - app.data.quality.quality_manager - INFO - 数据质量处理完成，耗时: 1.01秒
2025-09-25 15:07:56,065 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:56,067 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:07:56,067 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:07:56,156 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:56,159 - app.data.quality.quality_manager - INFO - 开始处理数据质量，数据量: 2
2025-09-25 15:07:56,159 - app.infrastructure.logging_service - INFO - [pipeline] 开始处理 2 条 A_share 数据
2025-09-25 15:07:56,160 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 2 条记录
2025-09-25 15:07:56,160 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:07:56,160 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 2 条，去重后 1 条
2025-09-25 15:07:57,166 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量处理完成
2025-09-25 15:07:57,170 - app.data.quality.quality_manager - INFO - 数据质量处理完成，耗时: 1.01秒
2025-09-25 15:07:57,368 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:57,372 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:07:57,373 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:07:57,466 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:07:57,498 - app.data.managers.database_writer - WARNING - Fundamental data quality issues for MSFT: 校验报告: 数据无效, 质量评分: 0.40, 错误: 3 个, 警告: 0 个, 执行时间: 0.000 秒
2025-09-25 15:07:57,498 - app.data.managers.database_writer - ERROR - Validation error: 必填字段 'code' 缺失
2025-09-25 15:07:57,498 - app.data.managers.database_writer - ERROR - Validation error: 必填字段 'date' 缺失
2025-09-25 15:07:57,498 - app.data.managers.database_writer - ERROR - Validation error: 必填字段 'close' 缺失
2025-09-25 15:07:57,568 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:57,570 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:07:57,571 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:07:57,572 - app.data.managers.database_writer - INFO - Successfully upserted fundamental data for MSFT.
2025-09-25 15:07:57,631 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:57,633 - app.data.managers.database_writer - WARNING - Fundamental data quality issues for MSFT: 校验报告: 数据无效, 质量评分: 0.40, 错误: 3 个, 警告: 0 个, 执行时间: 0.000 秒
2025-09-25 15:07:57,633 - app.data.managers.database_writer - ERROR - Validation error: 必填字段 'code' 缺失
2025-09-25 15:07:57,633 - app.data.managers.database_writer - ERROR - Validation error: 必填字段 'date' 缺失
2025-09-25 15:07:57,633 - app.data.managers.database_writer - ERROR - Validation error: 必填字段 'close' 缺失
2025-09-25 15:07:57,700 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:57,701 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:07:57,701 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:07:57,702 - app.data.managers.database_writer - INFO - Successfully upserted fundamental data for MSFT.
2025-09-25 15:07:57,767 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:07:57,793 - app.data.quality.quality_manager - INFO - 开始处理数据质量，数据量: 2
2025-09-25 15:07:57,793 - app.infrastructure.logging_service - INFO - [pipeline] 开始处理 2 条 A_share 数据
2025-09-25 15:07:57,794 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 2 条记录
2025-09-25 15:07:57,794 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:07:57,794 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 2 条，去重后 1 条
2025-09-25 15:07:58,814 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量处理完成
2025-09-25 15:07:58,821 - app.data.quality.quality_manager - INFO - 数据质量处理完成，耗时: 1.02秒
2025-09-25 15:07:58,988 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:58,991 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:07:58,991 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:07:59,073 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:07:59,075 - app.data.quality.quality_manager - INFO - 开始处理数据质量，数据量: 2
2025-09-25 15:07:59,075 - app.infrastructure.logging_service - INFO - [pipeline] 开始处理 2 条 A_share 数据
2025-09-25 15:07:59,076 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 2 条记录
2025-09-25 15:07:59,076 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:07:59,076 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 2 条，去重后 1 条
2025-09-25 15:08:00,081 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量处理完成
2025-09-25 15:08:00,084 - app.data.quality.quality_manager - INFO - 数据质量处理完成，耗时: 1.01秒
2025-09-25 15:08:00,207 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:00,209 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:08:00,209 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:08:00,298 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:00,343 - app.data.managers.data_manager - INFO - Querying DB for TEST.SH from 2023-01-01 to 2023-01-02
2025-09-25 15:08:00,347 - app.data.managers.data_manager - INFO - Found 2 records in DB for TEST.SH.
.2025-09-25 15:08:00,378 - app.data.managers.data_manager - INFO - Querying DB for TEST.SH from 2010-09-29 to 2025-09-25
2025-09-25 15:08:00,381 - app.data.managers.data_manager - INFO - DB data for TEST.SH is missing or stale. Fetching from API.
2025-09-25 15:08:00,381 - app.data.managers.data_manager - INFO - Storing 2 records for TEST.SH into the database.
2025-09-25 15:08:00,382 - app.data.quality.quality_manager - INFO - 开始处理数据质量，数据量: 2
2025-09-25 15:08:00,382 - app.infrastructure.logging_service - INFO - [pipeline] 开始处理 2 条 A_share 数据
2025-09-25 15:08:00,397 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 2 条记录
2025-09-25 15:08:00,397 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:08:00,397 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 2 条，去重后 1 条
2025-09-25 15:08:01,405 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量处理完成
2025-09-25 15:08:01,432 - app.data.quality.quality_manager - INFO - 数据质量处理完成，耗时: 1.02秒
2025-09-25 15:08:01,433 - app.data.managers.database_writer - INFO - Data quality summary for TEST.SH: 去重报告: 处理了 2 条记录, 发现 2 个重复, 移除了 1 个重复记录, 执行时间: 0.00 秒
2025-09-25 15:08:01,583 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:01,594 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:08:01,594 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:08:01,687 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:01,687 - app.data.managers.data_manager - INFO - Successfully stored data in DB.
F2025-09-25 15:08:01,988 - app.data.managers.data_manager - INFO - Querying DB for TEST.SH from 2010-09-29 to 2025-09-25
2025-09-25 15:08:01,990 - app.data.managers.data_manager - INFO - Found 2 records in DB for TEST.SH.
2025-09-25 15:08:01,990 - app.data.managers.data_manager - INFO - DB data for TEST.SH is up-to-date. Returning from DB.
.2025-09-25 15:08:02,022 - app.data.managers.data_manager - INFO - Querying DB for TEST.SH from 2010-09-29 to 2025-09-25
2025-09-25 15:08:02,027 - app.data.managers.data_manager - INFO - Found 2 records in DB for TEST.SH.
2025-09-25 15:08:02,028 - app.data.managers.data_manager - INFO - DB data for TEST.SH is missing or stale. Fetching from API.
2025-09-25 15:08:02,029 - app.data.managers.data_manager - INFO - Storing 2 records for TEST.SH into the database.
2025-09-25 15:08:02,030 - app.data.quality.quality_manager - INFO - 开始处理数据质量，数据量: 2
2025-09-25 15:08:02,030 - app.infrastructure.logging_service - INFO - [pipeline] 开始处理 2 条 A_share 数据
2025-09-25 15:08:02,032 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 2 条记录
2025-09-25 15:08:02,032 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:08:02,032 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 2 条，去重后 1 条
2025-09-25 15:08:03,036 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量处理完成
2025-09-25 15:08:03,147 - app.data.quality.quality_manager - INFO - 数据质量处理完成，耗时: 1.01秒
2025-09-25 15:08:03,147 - app.data.managers.database_writer - INFO - Data quality summary for TEST.SH: 去重报告: 处理了 2 条记录, 发现 2 个重复, 移除了 1 个重复记录, 执行时间: 0.00 秒
2025-09-25 15:08:03,431 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:03,496 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:08:03,497 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:08:03,655 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:03,655 - app.data.managers.data_manager - INFO - Successfully stored data in DB.
.2025-09-25 15:08:03,691 - app.data.managers.data_manager - INFO - Querying DB for AAPL from 2010-09-29 to 2025-09-25
2025-09-25 15:08:03,703 - app.data.managers.data_manager - INFO - DB data for AAPL is missing or stale. Fetching from API.
2025-09-25 15:08:03,703 - app.data.managers.data_manager - INFO - Storing 2 records for AAPL into the database.
2025-09-25 15:08:03,705 - app.data.quality.quality_manager - INFO - 开始处理数据质量，数据量: 2
2025-09-25 15:08:03,705 - app.infrastructure.logging_service - INFO - [pipeline] 开始处理 2 条 A_share 数据
2025-09-25 15:08:03,708 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 2 条记录
2025-09-25 15:08:03,708 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:08:03,708 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 2 条，去重后 1 条
2025-09-25 15:08:04,715 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量处理完成
2025-09-25 15:08:04,725 - app.data.quality.quality_manager - INFO - 数据质量处理完成，耗时: 1.01秒
2025-09-25 15:08:04,725 - app.data.managers.database_writer - INFO - Data quality summary for AAPL: 去重报告: 处理了 2 条记录, 发现 2 个重复, 移除了 1 个重复记录, 执行时间: 0.00 秒
2025-09-25 15:08:04,830 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:04,843 - app.infrastructure.logging_service - INFO - 清理了 0 条过期日志
2025-09-25 15:08:04,843 - app.data.quality.quality_manager - INFO - 资源清理完成
2025-09-25 15:08:04,970 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:04,971 - app.data.managers.data_manager - INFO - Successfully stored data in DB.
.......2025-09-25 15:08:05,048 - app.jobs.update_daily_metrics - INFO - Fetching A-share fundamentals for 000001.SZ
..2025-09-25 15:08:05,057 - app.jobs.update_daily_metrics - INFO - Starting metrics update for A_share
2025-09-25 15:08:05,057 - app.jobs.update_daily_metrics - INFO - Found 3 stocks for A_share
2025-09-25 15:08:05,057 - app.jobs.update_daily_metrics - INFO - Using batch fetch for A-share data to avoid frequency limits
2025-09-25 15:08:05,058 - app.jobs.update_daily_metrics - ERROR - Batch fetch failed, falling back to individual fetch: The truth value of a DataFrame is ambiguous. Use a.empty, a.bool(), a.item(), a.any() or a.all().
2025-09-25 15:08:05,060 - app.jobs.update_daily_metrics - INFO - Successfully updated 3 stocks for A_share
.2025-09-25 15:08:05,067 - app.jobs.update_daily_metrics - INFO - Starting metrics update for A_share
2025-09-25 15:08:05,067 - app.jobs.update_daily_metrics - INFO - Found 3 stocks for A_share
2025-09-25 15:08:05,067 - app.jobs.update_daily_metrics - INFO - Using batch fetch for A-share data to avoid frequency limits
2025-09-25 15:08:05,067 - app.jobs.update_daily_metrics - ERROR - Batch fetch failed, falling back to individual fetch: The truth value of a DataFrame is ambiguous. Use a.empty, a.bool(), a.item(), a.any() or a.all().
2025-09-25 15:08:05,067 - app.jobs.update_daily_metrics - WARNING - No data available for 000001.SZ
2025-09-25 15:08:05,067 - app.jobs.update_daily_metrics - WARNING - Too many total failures (1), stopping A-share fallback update
2025-09-25 15:08:05,068 - app.jobs.update_daily_metrics - INFO - Successfully updated 0 stocks for A_share
.2025-09-25 15:08:05,074 - app.jobs.update_daily_metrics - INFO - Starting metrics update for A_share
2025-09-25 15:08:05,075 - app.jobs.update_daily_metrics - INFO - Found 3 stocks for A_share
2025-09-25 15:08:05,075 - app.jobs.update_daily_metrics - INFO - Using batch fetch for A-share data to avoid frequency limits
2025-09-25 15:08:05,075 - app.jobs.update_daily_metrics - ERROR - Batch fetch failed, falling back to individual fetch: The truth value of a DataFrame is ambiguous. Use a.empty, a.bool(), a.item(), a.any() or a.all().
2025-09-25 15:08:05,079 - app.jobs.update_daily_metrics - INFO - Successfully updated 3 stocks for A_share
.2025-09-25 15:08:05,086 - app.jobs.update_daily_metrics - INFO - Starting metrics update for A_share
2025-09-25 15:08:05,086 - app.jobs.update_daily_metrics - INFO - Found 3 stocks for A_share
2025-09-25 15:08:05,086 - app.jobs.update_daily_metrics - INFO - Using batch fetch for A-share data to avoid frequency limits
2025-09-25 15:08:05,086 - app.jobs.update_daily_metrics - ERROR - Batch fetch failed, falling back to individual fetch: API Error
2025-09-25 15:08:05,086 - app.jobs.update_daily_metrics - ERROR - Failed to update 000001.SZ: API Error
2025-09-25 15:08:05,087 - app.jobs.update_daily_metrics - WARNING - Too many total failures (1), stopping A-share fallback update
2025-09-25 15:08:05,087 - app.jobs.update_daily_metrics - INFO - Successfully updated 0 stocks for A_share
..2025-09-25 15:08:05,117 - app.main - INFO - 正在启动应用...
2025-09-25 15:08:05,117 - app.main - INFO - 检测到测试环境，跳过数据库/缓存/调度器等重型初始化。
2025-09-25 15:08:05,121 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=test_client_001, token=None
2025-09-25 15:08:05,122 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
正在连接...
❌ 测试失败:
F2025-09-25 15:08:05,167 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=test_client_connection, token=None
2025-09-25 15:08:05,167 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
测试连接...
❌ 连接测试失败:
F2025-09-25 15:08:05,204 - backend.tests.integration.test_websocket_error - INFO - 测试: 发送无效JSON
2025-09-25 15:08:05,205 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=test_invalid_json, token=None
2025-09-25 15:08:05,205 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,205 - backend.tests.integration.test_websocket_error - ERROR - 无效JSON测试失败:
F2025-09-25 15:08:05,262 - backend.tests.integration.test_websocket_error - INFO - 测试: 发送无效消息类型
2025-09-25 15:08:05,263 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=test_invalid_type, token=None
2025-09-25 15:08:05,263 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,265 - backend.tests.integration.test_websocket_error - ERROR - 无效消息类型测试失败:
F2025-09-25 15:08:05,342 - backend.tests.integration.test_websocket_error - INFO - 测试: 发送格式错误的订阅消息
2025-09-25 15:08:05,343 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=test_malformed_subscribe, token=None
2025-09-25 15:08:05,344 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,344 - backend.tests.integration.test_websocket_error - ERROR - 格式错误订阅测试失败:
F2025-09-25 15:08:05,382 - backend.tests.integration.test_websocket_error - INFO - 测试: 快速连接和断开
2025-09-25 15:08:05,383 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=rapid_test_0, token=None
2025-09-25 15:08:05,384 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,384 - backend.tests.integration.test_websocket_error - WARNING - 快速连接 0 失败:
2025-09-25 15:08:05,385 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=rapid_test_1, token=None
2025-09-25 15:08:05,385 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,387 - backend.tests.integration.test_websocket_error - WARNING - 快速连接 1 失败:
2025-09-25 15:08:05,388 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=rapid_test_2, token=None
2025-09-25 15:08:05,388 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,388 - backend.tests.integration.test_websocket_error - WARNING - 快速连接 2 失败:
.2025-09-25 15:08:05,390 - backend.tests.integration.test_websocket_error - INFO - 测试: 发送大消息
2025-09-25 15:08:05,391 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=test_large_message, token=None
2025-09-25 15:08:05,391 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,392 - backend.tests.integration.test_websocket_error - ERROR - 大消息测试失败:
F2025-09-25 15:08:05,424 - backend.tests.integration.test_websocket_error - INFO - 测试: 并发订阅相同主题
2025-09-25 15:08:05,425 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=concurrent_test_1, token=None
2025-09-25 15:08:05,425 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,426 - backend.tests.integration.test_websocket_error - ERROR - 并发订阅测试失败:
F2025-09-25 15:08:05,459 - backend.tests.integration.test_websocket_error - INFO - 测试: 不带客户端ID的连接
2025-09-25 15:08:05,460 - backend.tests.integration.test_websocket_error - INFO - 预期的连接失败:
.2025-09-25 15:08:05,466 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=test_client, token=None
2025-09-25 15:08:05,466 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
🔍 测试单个WebSocket连接...
❌ 单连接测试失败:
F2025-09-25 15:08:05,517 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=lifecycle_test_0, token=None
2025-09-25 15:08:05,518 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
🔍 测试多个WebSocket连接...
❌ 多连接测试失败:
F2025-09-25 15:08:05,575 - backend.tests.integration.test_websocket_stress - INFO - 测试: 多个并发连接
2025-09-25 15:08:05,585 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=stress_client_0, token=None
2025-09-25 15:08:05,586 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,587 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=stress_client_1, token=None
2025-09-25 15:08:05,587 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,588 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=stress_client_2, token=None
2025-09-25 15:08:05,588 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,589 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=stress_client_3, token=None
2025-09-25 15:08:05,589 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,589 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=stress_client_4, token=None
2025-09-25 15:08:05,589 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,591 - backend.tests.integration.test_websocket_stress - ERROR - 客户端 stress_client_4 连接失败:
2025-09-25 15:08:05,591 - backend.tests.integration.test_websocket_stress - ERROR - 客户端 stress_client_3 连接失败:
2025-09-25 15:08:05,592 - backend.tests.integration.test_websocket_stress - ERROR - 客户端 stress_client_1 连接失败:
2025-09-25 15:08:05,592 - backend.tests.integration.test_websocket_stress - ERROR - 客户端 stress_client_2 连接失败:
2025-09-25 15:08:05,592 - backend.tests.integration.test_websocket_stress - ERROR - 客户端 stress_client_0 连接失败:
2025-09-25 15:08:05,592 - backend.tests.integration.test_websocket_stress - INFO - 成功建立 0/5 个连接
F2025-09-25 15:08:05,606 - backend.tests.integration.test_websocket_stress - INFO - 测试: 消息突发发送
2025-09-25 15:08:05,607 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=burst_test_client, token=None
2025-09-25 15:08:05,607 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,608 - backend.tests.integration.test_websocket_stress - ERROR - 消息突发测试失败:
F2025-09-25 15:08:05,645 - backend.tests.integration.test_websocket_stress - INFO - 测试: 连接生命周期
2025-09-25 15:08:05,647 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=lifecycle_test_0, token=None
2025-09-25 15:08:05,647 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,648 - backend.tests.integration.test_websocket_stress - WARNING - 周期 0 失败:
2025-09-25 15:08:05,649 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=lifecycle_test_1, token=None
2025-09-25 15:08:05,649 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,650 - backend.tests.integration.test_websocket_stress - WARNING - 周期 1 失败:
2025-09-25 15:08:05,651 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=lifecycle_test_2, token=None
2025-09-25 15:08:05,651 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,652 - backend.tests.integration.test_websocket_stress - WARNING - 周期 2 失败:
.2025-09-25 15:08:05,654 - backend.tests.integration.test_websocket_stress - INFO - 测试: 并发操作
2025-09-25 15:08:05,655 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=concurrent_client_0, token=None
2025-09-25 15:08:05,655 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,656 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=concurrent_client_1, token=None
2025-09-25 15:08:05,656 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,656 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=concurrent_client_2, token=None
2025-09-25 15:08:05,656 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,657 - backend.tests.integration.test_websocket_stress - WARNING - concurrent_client_1 任务失败:
2025-09-25 15:08:05,657 - backend.tests.integration.test_websocket_stress - WARNING - concurrent_client_0 任务失败:
2025-09-25 15:08:05,658 - backend.tests.integration.test_websocket_stress - WARNING - concurrent_client_2 任务失败:
2025-09-25 15:08:05,658 - backend.tests.integration.test_websocket_stress - INFO - 并发操作结果: 0/3 成功
F2025-09-25 15:08:05,664 - backend.tests.integration.test_websocket_stress - INFO - 测试: 长时间运行的连接
2025-09-25 15:08:05,665 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=long_running_client, token=None
2025-09-25 15:08:05,665 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
2025-09-25 15:08:05,666 - backend.tests.integration.test_websocket_stress - ERROR - 长连接测试失败:
F2025-09-25 15:08:05,700 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=test_subscription_client, token=None
2025-09-25 15:08:05,700 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空
=== WebSocket订阅测试开始 ===
❌ 订阅测试失败:
F2025-09-25 15:08:05,730 - app.api.v1.websocket - INFO - WebSocket连接请求: client_id=test_ping_client, token=None
2025-09-25 15:08:05,730 - app.api.v1.websocket - ERROR - WebSocket服务未初始化 - connection_manager为空

=== Ping测试开始 ===
❌ Ping测试失败:
F2025-09-25 15:08:05,775 - httpx - INFO - HTTP Request: POST http://testserver/api/analytics/strategies "HTTP/1.1 200 OK"
.2025-09-25 15:08:05,788 - httpx - INFO - HTTP Request: POST http://testserver/api/analytics/strategies "HTTP/1.1 422 Unprocessable Entity"
.2025-09-25 15:08:05,798 - httpx - INFO - HTTP Request: GET http://testserver/api/analytics/strategies?user_id=1 "HTTP/1.1 200 OK"
.2025-09-25 15:08:05,829 - httpx - INFO - HTTP Request: GET http://testserver/api/analytics/strategies/1 "HTTP/1.1 200 OK"
.2025-09-25 15:08:05,840 - httpx - INFO - HTTP Request: GET http://testserver/api/analytics/strategies/999 "HTTP/1.1 404 Not Found"
.2025-09-25 15:08:05,855 - httpx - INFO - HTTP Request: PUT http://testserver/api/analytics/strategies/1 "HTTP/1.1 200 OK"
.2025-09-25 15:08:05,872 - httpx - INFO - HTTP Request: DELETE http://testserver/api/analytics/strategies/1 "HTTP/1.1 200 OK"
.2025-09-25 15:08:05,884 - httpx - INFO - HTTP Request: GET http://testserver/api/analytics/backtest/results?user_id=1 "HTTP/1.1 200 OK"
.2025-09-25 15:08:05,903 - httpx - INFO - HTTP Request: GET http://testserver/api/analytics/backtest/results/1 "HTTP/1.1 200 OK"
.2025-09-25 15:08:05,918 - httpx - INFO - HTTP Request: GET http://testserver/api/analytics/backtest/results/999 "HTTP/1.1 404 Not Found"
.2025-09-25 15:08:05,933 - httpx - INFO - HTTP Request: POST http://testserver/api/analytics/strategies/1/backtest "HTTP/1.1 200 OK"
.2025-09-25 15:08:05,945 - httpx - INFO - HTTP Request: POST http://testserver/api/analytics/strategies/999/backtest "HTTP/1.1 404 Not Found"
.2025-09-25 15:08:05,967 - httpx - INFO - HTTP Request: POST http://testserver/api/analytics/strategies/1/backtest "HTTP/1.1 422 Unprocessable Entity"
..........2025-09-25 15:08:05,997 - app.analytics.backtest.backtester - WARNING - current_date is not a datetime object, skipping trade execution.
F2025-09-25 15:08:06,006 - app.analytics.backtest.backtester - WARNING - current_date is not a datetime object, skipping trade execution.
F......2025-09-25 15:08:06,041 - app.api.v1.a_industries - INFO - Fetching industry overview: window=20D, provider=em
2025-09-25 15:08:06,041 - app.data.fetchers.a_industries_fetcher - INFO - Building industry overview with window=20D, provider=em
2025-09-25 15:08:06,041 - app.data.fetchers.a_industries_fetcher - INFO - Fetching industry list from Eastmoney (attempt 1/3)
2025-09-25 15:08:06,042 - app.data.fetchers.a_industries_fetcher - INFO - Fetching Eastmoney hist for industry: '电子元件' until 20250925
2025-09-25 15:08:06,046 - app.data.fetchers.a_industries_fetcher - INFO - Successfully built overview for 1 industries.
2025-09-25 15:08:06,046 - app.api.v1.a_industries - INFO - Industry overview fetched: count=1
2025-09-25 15:08:06,049 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/a-industries/overview?window=20D "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,062 - app.api.v1.a_industries - INFO - Fetching industry overview: window=5D, provider=ths
2025-09-25 15:08:06,062 - app.data.fetchers.a_industries_fetcher - INFO - Building industry overview with window=5D, provider=ths
2025-09-25 15:08:06,062 - app.data.fetchers.a_industries_fetcher - INFO - Fetching industry list from THS
2025-09-25 15:08:06,063 - app.data.fetchers.a_industries_fetcher - INFO - Fetching Eastmoney hist for industry: '汽车整车' until 20250925
0it [00:00, ?it/s]                  2025-09-25 15:08:06,228 - app.data.fetchers.a_industries_fetcher - INFO - Successfully built overview for 1 industries.
2025-09-25 15:08:06,228 - app.api.v1.a_industries - INFO - Industry overview fetched: count=1
2025-09-25 15:08:06,231 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/a-industries/overview?window=5D&provider=ths "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,261 - app.api.v1.backtest - INFO - Received single grid backtest request for AAPL
2025-09-25 15:08:06,264 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,277 - app.api.v1.backtest - INFO - Received single grid backtest request for INVALID
2025-09-25 15:08:06,278 - app.api.v1.backtest - ERROR - ValueError during backtest for INVALID: Invalid configuration parameters
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/backtest.py", line 31, in run_grid_backtest_api
    result = backtester.run_grid_backtest(db=db, config=config)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
ValueError: Invalid configuration parameters
2025-09-25 15:08:06,283 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 400 Bad Request"
.2025-09-25 15:08:06,296 - app.api.v1.backtest - INFO - Received single grid backtest request for AAPL
2025-09-25 15:08:06,296 - app.api.v1.backtest - ERROR - An unexpected error occurred during backtest for AAPL: Database connection failed
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/backtest.py", line 31, in run_grid_backtest_api
    result = backtester.run_grid_backtest(db=db, config=config)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
Exception: Database connection failed
2025-09-25 15:08:06,299 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 500 Internal Server Error"
.2025-09-25 15:08:06,315 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 422 Unprocessable Entity"
.2025-09-25 15:08:06,335 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 422 Unprocessable Entity"
.2025-09-25 15:08:06,347 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 422 Unprocessable Entity"
.2025-09-25 15:08:06,359 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 422 Unprocessable Entity"
.2025-09-25 15:08:06,368 - app.api.v1.backtest - INFO - Received single grid backtest request for AAPL
2025-09-25 15:08:06,371 - httpx - INFO - HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,383 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/commodities/ag2412 "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,400 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/commodities/invalid_symbol "HTTP/1.1 404 Not Found"
.2025-09-25 15:08:06,427 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/commodities/list "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,435 - app.api.v1.commodities - ERROR - Failed to create commodity list: Akshare down
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/commodities.py", line 26, in get_commodity_list
    df = await run_in_threadpool(ak.futures_display_main_sina)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 2234, in _execute_mock_call
    raise effect
Exception: Akshare down
2025-09-25 15:08:06,438 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/commodities/list "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,462 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/commodities/list "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,470 - app.api.v1.commodities - ERROR - Failed to create commodity list: Akshare down
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/commodities.py", line 26, in get_commodity_list
    df = await run_in_threadpool(ak.futures_display_main_sina)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 2234, in _execute_mock_call
    raise effect
Exception: Akshare down
2025-09-25 15:08:06,472 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/commodities/list "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,484 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/crypto/top "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,491 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/crypto/top "HTTP/1.1 404 Not Found"
.2025-09-25 15:08:06,501 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/crypto/BTC/history "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,510 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/crypto/NONEXISTENT/history "HTTP/1.1 404 Not Found"
....Error fetching crypto data: Network Error
...........Error fetching crypto OHLCV data: Network Error
..2025-09-25 15:08:06,614 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/futures/rb2410 "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,647 - app.api.v1.futures - ERROR - Failed to fetch futures data for invalid_symbol. Attempted: INVALID_SYMBOL=F, INVALID_SYMBOL, INVALID_SYMBOL.SHF, INVALID_SYMBOL.INE, INVALID_SYMBOL.DCE, INVALID_SYMBOL.ZCE, INVALID_SYMBOL.CFX
2025-09-25 15:08:06,651 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/futures/invalid_symbol "HTTP/1.1 404 Not Found"
.2025-09-25 15:08:06,662 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/futures/list "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,673 - app.api.v1.futures - ERROR - Failed to fetch futures list from Akshare: Akshare down
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/futures.py", line 24, in get_futures_list
    futures_df = await run_in_threadpool(ak.futures_display_main_sina)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 2234, in _execute_mock_call
    raise effect
Exception: Akshare down
2025-09-25 15:08:06,676 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/futures/list "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,687 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/options/expirations/SPY "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,694 - app.api.v1.options - ERROR - Failed to fetch expiration dates for INVALID: Not found
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/options.py", line 20, in get_option_expirations
    expirations = await run_in_threadpool(
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 2234, in _execute_mock_call
    raise effect
Exception: Not found
2025-09-25 15:08:06,697 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/options/expirations/INVALID "HTTP/1.1 404 Not Found"
.2025-09-25 15:08:06,724 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/options/chain/SPY?expiration_date=2025-12-19 "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,731 - app.api.v1.options - ERROR - Failed to fetch option chain for SPY on 2025-12-19: Fetch failed
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/options.py", line 41, in get_option_chain_for_date
    chain = await run_in_threadpool(
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 2234, in _execute_mock_call
    raise effect
Exception: Fetch failed
2025-09-25 15:08:06,735 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/options/chain/SPY?expiration_date=2025-12-19 "HTTP/1.1 500 Internal Server Error"
.2025-09-25 15:08:06,758 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/options/SPY251219C00600000 "HTTP/1.1 200 OK"
.2025-09-25 15:08:06,767 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/options/UNKNOWN_CONTRACT "HTTP/1.1 200 OK"
..2025-09-25 15:08:06,775 - app.data.fetchers.stock_fetchers.a_share_fetcher - ERROR - Baostock login failed: Login failed
..2025-09-25 15:08:06,778 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Baostock network error (attempt 1/2). Retrying in 1s...
2025-09-25 15:08:07,784 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Baostock network error (attempt 2/2). Retrying in 1s...
2025-09-25 15:08:08,787 - app.data.fetchers.stock_fetchers.a_share_fetcher - ERROR - Failed to execute Baostock query after 2 retries.
.2025-09-25 15:08:08,838 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Baostock data/field mismatch for mock_query_func: columns passed. Attempting to build DataFrame manually.
2025-09-25 15:08:08,838 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Using first 2 fields out of 3 available: ['year', 'netProfit']
..2025-09-25 15:08:08,871 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Baostock network error (attempt 1/2). Retrying in 1s...
2025-09-25 15:08:08,872 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Baostock network error (attempt 2/2). Retrying in 1s...
2025-09-25 15:08:08,872 - app.data.fetchers.stock_fetchers.a_share_fetcher - ERROR - Failed to execute Baostock query after 2 retries.
..2025-09-25 15:08:08,884 - app.data.fetchers.stock_fetchers.a_share_fetcher - ERROR - Circuit breaker for 000001.SH: Too many consecutive quarterly failures. Aborting year loop.
.2025-09-25 15:08:08,902 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Could not parse netProfit 'invalid' for 000001.sh 2024Q1
2025-09-25 15:08:08,902 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Could not parse netProfit 'invalid' for 000001.sh 2024Q2
2025-09-25 15:08:08,903 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Could not parse netProfit 'invalid' for 000001.sh 2024Q3
2025-09-25 15:08:08,903 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Could not parse netProfit 'invalid' for 000001.sh 2024Q4
2025-09-25 15:08:08,903 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Could not parse netProfit 'invalid' for 000001.sh 2025Q1
2025-09-25 15:08:08,903 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Could not parse netProfit 'invalid' for 000001.sh 2025Q2
2025-09-25 15:08:08,905 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Could not parse netProfit 'invalid' for 000001.sh 2025Q3
2025-09-25 15:08:08,905 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Could not parse netProfit 'invalid' for 000001.sh 2025Q4
..  0%|          | 0/2 [00:00<?, ?it/s] 50%|█████     | 1/2 [00:00<00:00,  5.61it/s]100%|██████████| 2/2 [00:00<00:00,  4.01it/s]                                             2025-09-25 15:08:09,817 - app.data.fetchers.stock_fetchers.a_share_fetcher - INFO - Successfully fetched and processed 2 ETFs.
2025-09-25 15:08:09,834 - app.data.fetchers.stock_fetchers.a_share_fetcher - INFO - Successfully upserted 289 stocks and ETFs into the database.
.2025-09-25 15:08:09,839 - app.data.fetchers.stock_fetchers.a_share_fetcher - ERROR - Failed to fetch stock list for market sh from Akshare: SH market error
  0%|          | 0/2 [00:00<?, ?it/s] 50%|█████     | 1/2 [00:00<00:00,  5.36it/s]100%|██████████| 2/2 [00:00<00:00,  6.74it/s]                                             2025-09-25 15:08:10,313 - app.data.fetchers.stock_fetchers.a_share_fetcher - INFO - Successfully fetched and processed 1 ETFs.
2025-09-25 15:08:10,327 - app.data.fetchers.stock_fetchers.a_share_fetcher - INFO - Successfully upserted 285 stocks and ETFs into the database.
.  0%|          | 0/2 [00:00<?, ?it/s] 50%|█████     | 1/2 [00:00<00:00,  7.33it/s]100%|██████████| 2/2 [00:00<00:00,  5.74it/s]                                             2025-09-25 15:08:10,801 - app.data.fetchers.stock_fetchers.a_share_fetcher - INFO - Successfully fetched and processed 1 ETFs.
2025-09-25 15:08:10,821 - app.data.fetchers.stock_fetchers.a_share_fetcher - INFO - Successfully upserted 286 stocks and ETFs into the database.
.2025-09-25 15:08:10,828 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Could not find a valid code column for sh. Skipping.
2025-09-25 15:08:10,828 - app.data.fetchers.stock_fetchers.a_share_fetcher - WARNING - Could not find a valid code column for sz. Skipping.
  0%|          | 0/2 [00:00<?, ?it/s] 50%|█████     | 1/2 [00:00<00:00,  8.87it/s]100%|██████████| 2/2 [00:00<00:00,  6.65it/s]                                             2025-09-25 15:08:11,235 - app.data.fetchers.stock_fetchers.a_share_fetcher - INFO - Successfully fetched and processed 3 ETFs.
2025-09-25 15:08:11,252 - app.data.fetchers.stock_fetchers.a_share_fetcher - INFO - Successfully upserted 286 stocks and ETFs into the database.
.2025-09-25 15:08:11,260 - app.data.fetchers.stock_fetchers.a_share_fetcher - ERROR - Failed to fetch stock list for market sh from Akshare: SH market error
2025-09-25 15:08:11,261 - app.data.fetchers.stock_fetchers.a_share_fetcher - ERROR - Failed to fetch stock list for market sz from Akshare: SZ market error
  0%|          | 0/2 [00:00<?, ?it/s] 50%|█████     | 1/2 [00:00<00:00,  7.75it/s]100%|██████████| 2/2 [00:00<00:00,  8.70it/s]                                             2025-09-25 15:08:11,626 - app.data.fetchers.stock_fetchers.a_share_fetcher - ERROR - Failed to fetch ETF list from Akshare: ETF market error
2025-09-25 15:08:11,645 - app.data.fetchers.stock_fetchers.a_share_fetcher - INFO - Successfully upserted 283 stocks and ETFs into the database.
....2025-09-25 15:08:11,667 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching yfinance data for ticker: AAPL, interval: 1d, start: 2023-01-01, end: 2023-01-05
2025-09-25 15:08:11,667 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully fetched 5 rows from yfinance for AAPL. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume', 'Adj Close']
2025-09-25 15:08:11,679 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
.2025-09-25 15:08:11,693 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching yfinance data for ticker: UNKNOWN, interval: 1d, start: 2023-01-01, end: 2023-01-05
2025-09-25 15:08:11,694 - app.data.fetchers.stock_fetchers.us_stock_fetcher - WARNING - yfinance returned empty or None DataFrame for UNKNOWN
.2025-09-25 15:08:11,711 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching yfinance data for ticker: AAPL, interval: 1d, start: 2023-01-01, end: 2023-01-03
2025-09-25 15:08:11,712 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully fetched 3 rows from yfinance for AAPL. Original Columns: [('Date', ''), ('Open', ''), ('High', ''), ('Low', ''), ('Close', ''), ('Volume', ''), ('Adj Close', '')]
2025-09-25 15:08:11,733 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
.2025-09-25 15:08:11,751 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching yfinance data for ticker: AAPL, interval: weekly, start: 2023-01-01, end: 2023-01-21
2025-09-25 15:08:11,753 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully fetched 3 rows from yfinance for AAPL. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume', 'Adj Close']
2025-09-25 15:08:11,769 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
.2025-09-25 15:08:11,780 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching yfinance data for ticker: AAPL, interval: monthly, start: 2023-01-01, end: 2023-03-31
2025-09-25 15:08:11,781 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully fetched 3 rows from yfinance for AAPL. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume', 'Adj Close']
2025-09-25 15:08:11,790 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
.2025-09-25 15:08:11,801 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching yfinance data for ticker: AAPL, interval: invalid, start: 2023-01-01, end: 2023-01-03
2025-09-25 15:08:11,802 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully fetched 3 rows from yfinance for AAPL. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume', 'Adj Close']
2025-09-25 15:08:11,823 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
.2025-09-25 15:08:11,834 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching yfinance data for ticker: AAPL, interval: 1d, start: 2023-01-01, end: 2023-01-03
2025-09-25 15:08:11,834 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully fetched 3 rows from yfinance for AAPL. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
2025-09-25 15:08:11,843 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
.2025-09-25 15:08:11,860 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching yfinance data for ticker: AAPL, interval: 1d, start: 2023-01-01, end: 2023-01-03
2025-09-25 15:08:11,860 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully fetched 3 rows from yfinance for AAPL. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume', 'Adj Close']
2025-09-25 15:08:11,872 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
.2025-09-25 15:08:11,890 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching yfinance data for ticker: AAPL.SS, interval: 1d, start: 2023-01-01, end: 2023-01-03
2025-09-25 15:08:11,890 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully fetched 3 rows from yfinance for AAPL.SS. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume', 'Adj Close']
2025-09-25 15:08:11,900 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Final DataFrame columns for AAPL.SS: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
.2025-09-25 15:08:11,907 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching S&P 500 tickers...
2025-09-25 15:08:11,907 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 3 S&P 500 tickers.
2025-09-25 15:08:11,907 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching NASDAQ tickers...
2025-09-25 15:08:11,907 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 4 NASDAQ tickers.
2025-09-25 15:08:11,907 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching Dow Jones tickers...
2025-09-25 15:08:11,908 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 4 Dow Jones tickers.
2025-09-25 15:08:11,908 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching other US (NYSE/AMEX/etc.) tickers...
2025-09-25 15:08:11,908 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 2 other US (NYSE/AMEX/etc.) tickers.
2025-09-25 15:08:11,908 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Total unique symbols fetched from yahoo_fin: 7
2025-09-25 15:08:11,908 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Total qualified symbols after filtering: 7
2025-09-25 15:08:11,909 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully upserted 7 US stock entries into DB.
2025-09-25 15:08:11,909 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Starting to update US stock names from yfinance...
2025-09-25 15:08:11,911 - app.data.fetchers.stock_fetchers.us_stock_fetcher - ERROR - Error updating US stock names from yfinance: object of type 'Mock' has no len()
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/data/fetchers/stock_fetchers/us_stock_fetcher.py", line 648, in update_stock_names_from_yfinance
    logger.info(f"Found {len(us_stocks)} US stocks to update names")
TypeError: object of type 'Mock' has no len()
.2025-09-25 15:08:11,924 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching S&P 500 tickers...
2025-09-25 15:08:11,924 - app.data.fetchers.stock_fetchers.us_stock_fetcher - ERROR - Error fetching S&P 500 tickers: S&P 500 error
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/data/fetchers/stock_fetchers/us_stock_fetcher.py", line 437, in update_us_stock_list
    sp500_tickers = si.tickers_sp500()
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
Exception: S&P 500 error
.2025-09-25 15:08:11,928 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching S&P 500 tickers...
2025-09-25 15:08:11,929 - app.data.fetchers.stock_fetchers.us_stock_fetcher - ERROR - Error fetching S&P 500 tickers: S&P 500 error
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/data/fetchers/stock_fetchers/us_stock_fetcher.py", line 437, in update_us_stock_list
    sp500_tickers = si.tickers_sp500()
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
Exception: S&P 500 error
.2025-09-25 15:08:11,934 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching S&P 500 tickers...
2025-09-25 15:08:11,934 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 0 S&P 500 tickers.
2025-09-25 15:08:11,934 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching S&P 500 (Alpha Vantage fallback) tickers...
2025-09-25 15:08:11,935 - app.data.fetchers.stock_fetchers.us_stock_fetcher - WARNING - Alpha Vantage API key not configured, falling back to yfinance
2025-09-25 15:08:11,935 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 0 S&P 500 (Alpha Vantage fallback) tickers.
2025-09-25 15:08:11,935 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching NASDAQ tickers...
2025-09-25 15:08:11,935 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 0 NASDAQ tickers.
2025-09-25 15:08:11,935 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching Dow Jones tickers...
2025-09-25 15:08:11,935 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 0 Dow Jones tickers.
2025-09-25 15:08:11,935 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching other US (NYSE/AMEX/etc.) tickers...
2025-09-25 15:08:11,936 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 0 other US (NYSE/AMEX/etc.) tickers.
2025-09-25 15:08:11,936 - app.data.fetchers.stock_fetchers.us_stock_fetcher - WARNING - No stocks fetched from yahoo_fin, using yfinance fallback
2025-09-25 15:08:11,936 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching yfinance fallback tickers...
2025-09-25 15:08:11,936 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Using comprehensive US stock list as yfinance fallback
2025-09-25 15:08:11,936 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - yfinance fallback fetched 129 US stock tickers.
2025-09-25 15:08:11,936 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 129 yfinance fallback tickers.
2025-09-25 15:08:11,936 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Total unique symbols fetched from yahoo_fin: 129
2025-09-25 15:08:11,936 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Total qualified symbols after filtering: 129
2025-09-25 15:08:11,942 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully upserted 129 US stock entries into DB.
2025-09-25 15:08:11,942 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Starting to update US stock names from yfinance...
2025-09-25 15:08:11,943 - app.data.fetchers.stock_fetchers.us_stock_fetcher - ERROR - Error updating US stock names from yfinance: object of type 'Mock' has no len()
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/data/fetchers/stock_fetchers/us_stock_fetcher.py", line 648, in update_stock_names_from_yfinance
    logger.info(f"Found {len(us_stocks)} US stocks to update names")
TypeError: object of type 'Mock' has no len()
.2025-09-25 15:08:11,946 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching S&P 500 tickers...
2025-09-25 15:08:11,946 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 3 S&P 500 tickers.
2025-09-25 15:08:11,946 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching NASDAQ tickers...
2025-09-25 15:08:11,946 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 4 NASDAQ tickers.
2025-09-25 15:08:11,946 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching Dow Jones tickers...
2025-09-25 15:08:11,946 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 4 Dow Jones tickers.
2025-09-25 15:08:11,946 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetching other US (NYSE/AMEX/etc.) tickers...
2025-09-25 15:08:11,946 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Fetched 3 other US (NYSE/AMEX/etc.) tickers.
2025-09-25 15:08:11,946 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Total unique symbols fetched from yahoo_fin: 7
2025-09-25 15:08:11,946 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Total qualified symbols after filtering: 7
2025-09-25 15:08:11,948 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Successfully upserted 7 US stock entries into DB.
2025-09-25 15:08:11,948 - app.data.fetchers.stock_fetchers.us_stock_fetcher - INFO - Starting to update US stock names from yfinance...
2025-09-25 15:08:11,949 - app.data.fetchers.stock_fetchers.us_stock_fetcher - ERROR - Error updating US stock names from yfinance: object of type 'Mock' has no len()
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/data/fetchers/stock_fetchers/us_stock_fetcher.py", line 648, in update_stock_names_from_yfinance
    logger.info(f"Found {len(us_stocks)} US stocks to update names")
TypeError: object of type 'Mock' has no len()
.2025-09-25 15:08:11,955 - app.data.managers.data_manager - INFO - Stock list for A_share is empty. Attempting to refresh.
..2025-09-25 15:08:11,962 - app.data.managers.data_manager - INFO - Stock list for US_stock is empty. Attempting to refresh.
.2025-09-25 15:08:11,965 - app.data.managers.data_manager - INFO - Stock list for unknown_market is empty. Attempting to refresh.
.2025-09-25 15:08:11,969 - app.data.managers.data_manager - INFO - Stock list for A_share is empty. Attempting to refresh.
2025-09-25 15:08:11,969 - app.data.managers.data_manager - ERROR - Failed to update stock list for A_share: Update failed
.2025-09-25 15:08:11,976 - app.data.managers.data_manager - INFO - Force updating stock list for A_share from source.
2025-09-25 15:08:11,977 - app.data.managers.data_manager - INFO - Successfully forced update for A_share.
.2025-09-25 15:08:11,979 - app.data.managers.data_manager - INFO - Force updating stock list for US_stock from source.
2025-09-25 15:08:11,979 - app.data.managers.data_manager - INFO - Successfully forced update for US_stock.
.2025-09-25 15:08:11,981 - app.data.managers.data_manager - INFO - Force updating stock list for unknown_market from source.
2025-09-25 15:08:11,981 - app.data.managers.data_manager - INFO - Successfully forced update for unknown_market.
.2025-09-25 15:08:11,983 - app.data.managers.data_manager - INFO - Force updating stock list for A_share from source.
2025-09-25 15:08:11,984 - app.data.managers.data_manager - ERROR - Failed to force update stock list for A_share: Update failed
.2025-09-25 15:08:11,986 - app.data.managers.data_manager - INFO - Force updating stock list for US_stock from source.
2025-09-25 15:08:11,986 - app.data.managers.data_manager - ERROR - Failed to force update stock list for US_stock: Update failed
..........2025-09-25 15:08:12,026 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 4 条，去重后 2 条
..................2025-09-25 15:08:12,464 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:12,542 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:12,547 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 28 条，去重后 22 条
2025-09-25 15:08:12,547 - app.infrastructure.logging_service - INFO - [validation] 处理了 28 条记录
2025-09-25 15:08:12,620 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:12,713 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:12,786 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:12,870 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:12,874 - app.infrastructure.logging_service - INFO - [quality_check] 数据质量检查完成
2025-09-25 15:08:13,073 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:13,242 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:13,258 - app.data.quality.deduplication_service - INFO - 批量去重完成: 原始数据 28 条，去重后 22 条
2025-09-25 15:08:13,258 - app.infrastructure.logging_service - INFO - [pipeline] 数据质量管道执行完成
2025-09-25 15:08:13,393 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:13,574 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:13,663 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:13,763 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:13,847 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:13,950 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:14,056 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:14,164 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:14,169 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 28 条记录
2025-09-25 15:08:14,169 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:08:15,306 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:15,406 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.........................2025-09-25 15:08:15,602 - app.infrastructure.cache.cache_service - INFO - Cleared cache pattern: stock:*, deleted: 2
..2025-09-25 15:08:15,619 - app.infrastructure.cache.cache_service - ERROR - Failed to set cache for key health_check_test: object bool can't be used in 'await' expression
.2025-09-25 15:08:15,626 - app.infrastructure.cache.cache_service - ERROR - Failed to set cache for key health_check_test: object bool can't be used in 'await' expression
.......2025-09-25 15:08:15,649 - app.infrastructure.cache.cache_warming - ERROR - 预热股票信息失败: object bool can't be used in 'await' expression
2025-09-25 15:08:15,653 - app.infrastructure.cache.cache_warming - ERROR - 预热股票信息失败: object bool can't be used in 'await' expression
2025-09-25 15:08:15,655 - app.infrastructure.cache.cache_warming - ERROR - 预热股票信息失败: object bool can't be used in 'await' expression
2025-09-25 15:08:15,656 - app.infrastructure.cache.cache_warming - ERROR - 预热股票信息失败: object bool can't be used in 'await' expression
2025-09-25 15:08:15,657 - app.infrastructure.cache.cache_warming - ERROR - 预热股票信息失败: object bool can't be used in 'await' expression
2025-09-25 15:08:15,659 - app.infrastructure.cache.cache_warming - ERROR - 预热股票信息失败: object bool can't be used in 'await' expression
2025-09-25 15:08:15,660 - app.infrastructure.cache.cache_warming - ERROR - 预热股票信息失败: object bool can't be used in 'await' expression
2025-09-25 15:08:15,661 - app.infrastructure.cache.cache_warming - ERROR - 预热股票信息失败: object bool can't be used in 'await' expression
2025-09-25 15:08:15,662 - app.infrastructure.cache.cache_warming - ERROR - 预热股票信息失败: object bool can't be used in 'await' expression
2025-09-25 15:08:15,664 - app.infrastructure.cache.cache_warming - ERROR - 预热股票信息失败: object bool can't be used in 'await' expression
..2025-09-25 15:08:15,680 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached stock info for 000001.SZ
2025-09-25 15:08:15,680 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached daily data for 000001.SZ
2025-09-25 15:08:15,680 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached stock info for 000002.SZ
2025-09-25 15:08:15,681 - app.infrastructure.cache.cache_warming - DEBUG - Successfully cached daily data for 000002.SZ
...................2025-09-25 15:08:15,717 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已启动
.2025-09-25 15:08:15,722 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已启动
.2025-09-25 15:08:15,726 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已启动
.2025-09-25 15:08:15,727 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已启动
.2025-09-25 15:08:15,729 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已启动
.2025-09-25 15:08:15,730 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已启动
.2025-09-25 15:08:15,732 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已启动
.2025-09-25 15:08:15,733 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已启动
.2025-09-25 15:08:15,735 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已启动
2025-09-25 15:08:16,740 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已停止
.2025-09-25 15:08:16,743 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已启动
.....2025-09-25 15:08:16,973 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已启动
.2025-09-25 15:08:16,975 - app.infrastructure.monitoring.performance_monitor - INFO - 性能监控已启动
....2025-09-25 15:08:17,112 - app.infrastructure.performance.performance_optimization_service - WARNING - 内存使用率过高: 40.6%
.....2025-09-25 15:08:17,156 - backend.tests.unit.app.infrastructure.performance.test_performance_optimization_service - ERROR - 函数 test_function_with_error 执行失败: 测试异常
.2025-09-25 15:08:17,261 - backend.tests.unit.app.infrastructure.performance.test_performance_optimization_service - INFO - 函数 test_function 执行完成: 耗时 0.10s, 内存变化 -0.09MB
.2025-09-25 15:08:17,360 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:17,457 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:17,460 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_deduplicate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:08:17,565 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:17,665 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:17,669 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 10 条记录
2025-09-25 15:08:17,669 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 2, 处理 5 条记录
2025-09-25 15:08:17,669 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:08:17,775 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:17,884 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:18,020 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:18,135 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:18,274 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:18,379 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:18,496 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:18,500 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 5 条记录
2025-09-25 15:08:18,500 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.02MB
2025-09-25 15:08:18,501 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 5 条记录
2025-09-25 15:08:18,502 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 -0.01MB
2025-09-25 15:08:18,503 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 5 条记录
2025-09-25 15:08:18,504 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 -0.02MB
2025-09-25 15:08:18,588 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:18,759 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:18,763 - app.infrastructure.performance.performance_optimization_service - ERROR - 批量校验失败: 模拟错误
2025-09-25 15:08:18,763 - app.infrastructure.performance.performance_optimization_service - ERROR - 批量校验失败: 模拟错误
2025-09-25 15:08:18,763 - app.infrastructure.performance.performance_optimization_service - ERROR - 批量校验失败: 模拟错误
2025-09-25 15:08:18,764 - app.infrastructure.performance.performance_optimization_service - ERROR - 批量校验失败: 模拟错误
2025-09-25 15:08:18,764 - app.infrastructure.performance.performance_optimization_service - ERROR - 批量校验失败: 模拟错误
2025-09-25 15:08:18,764 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 5 条记录
2025-09-25 15:08:18,764 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:08:18,859 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:19,006 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:20,178 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:20,339 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:20,449 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:20,551 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:20,665 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:20,779 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:20,788 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.31MB
2025-09-25 15:08:20,880 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:20,969 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:21,220 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:21,364 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:21,369 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:08:21,370 - app.infrastructure.performance.performance_optimization_service - INFO - 完成批次 1, 处理 10 条记录
2025-09-25 15:08:21,370 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:08:21,372 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.05MB
2025-09-25 15:08:21,475 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:21,607 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
2025-09-25 15:08:21,611 - app.infrastructure.performance.performance_optimization_service - INFO - 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
2025-09-25 15:08:21,727 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
.2025-09-25 15:08:21,841 - app.infrastructure.performance.performance_optimization_service - INFO - 资源清理完成
....2025-09-25 15:08:21,910 - httpx - INFO - HTTP Request: GET http://testserver/ "HTTP/1.1 200 OK"
.2025-09-25 15:08:21,923 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
.2025-09-25 15:08:21,931 - app.websocket.connection_manager - INFO - 客户端 test_client_001 连接成功，用户ID: None
.2025-09-25 15:08:21,939 - app.websocket.connection_manager - INFO - 客户端 test_client_001 连接成功，用户ID: None
2025-09-25 15:08:21,941 - app.websocket.connection_manager - INFO - 客户端 test_client_001 连接已断开
.2025-09-25 15:08:21,950 - app.websocket.connection_manager - INFO - 客户端 test_client_001 连接成功，用户ID: None
..2025-09-25 15:08:21,959 - app.websocket.connection_manager - INFO - 客户端 test_client_001 连接成功，用户ID: None
2025-09-25 15:08:21,960 - app.websocket.connection_manager - INFO - 客户端 test_client_001 订阅主题 stock.AAPL.1m
.2025-09-25 15:08:21,977 - app.websocket.connection_manager - INFO - 客户端 test_client_001 连接成功，用户ID: None
2025-09-25 15:08:21,984 - app.websocket.connection_manager - INFO - 客户端 test_client_001 订阅主题 stock.AAPL.1m
2025-09-25 15:08:21,984 - app.websocket.connection_manager - INFO - 客户端 test_client_001 取消订阅主题 stock.AAPL.1m
.2025-09-25 15:08:21,990 - app.websocket.connection_manager - INFO - 客户端 subscriber_0 连接成功，用户ID: None
2025-09-25 15:08:21,992 - app.websocket.connection_manager - INFO - 客户端 subscriber_0 订阅主题 stock.AAPL.1m
2025-09-25 15:08:21,994 - app.websocket.connection_manager - INFO - 客户端 subscriber_1 连接成功，用户ID: None
2025-09-25 15:08:21,995 - app.websocket.connection_manager - INFO - 客户端 subscriber_1 订阅主题 stock.AAPL.1m
.2025-09-25 15:08:22,002 - app.websocket.connection_manager - INFO - 客户端 client_0 连接成功，用户ID: None
2025-09-25 15:08:22,003 - app.websocket.connection_manager - INFO - 客户端 client_0 订阅主题 stock.AAPL.1m
2025-09-25 15:08:22,009 - app.websocket.connection_manager - INFO - 客户端 client_1 连接成功，用户ID: None
2025-09-25 15:08:22,010 - app.websocket.connection_manager - INFO - 客户端 client_1 订阅主题 stock.AAPL.1m
2025-09-25 15:08:22,013 - app.websocket.connection_manager - INFO - 客户端 client_2 连接成功，用户ID: None
2025-09-25 15:08:22,014 - app.websocket.connection_manager - INFO - 客户端 client_2 订阅主题 stock.AAPL.1m
.2025-09-25 15:08:22,020 - app.websocket.connection_manager - INFO - 客户端 test_client_001 连接成功，用户ID: None
2025-09-25 15:08:22,021 - app.websocket.connection_manager - INFO - 客户端 test_client_001 订阅主题 stock.AAPL.1m
2025-09-25 15:08:22,021 - app.websocket.connection_manager - INFO - 客户端 test_client_001 订阅主题 stock.GOOGL.1m
2025-09-25 15:08:22,021 - app.websocket.connection_manager - INFO - 客户端 test_client_001 订阅主题 crypto.BTC.1m
2025-09-25 15:08:22,022 - app.websocket.connection_manager - INFO - 客户端 test_client_001 连接已断开
...2025-09-25 15:08:22,027 - app.main - INFO - 测试环境下应用关闭。

ERROR: Coverage failure: total of 52 is less than fail-under=80

=================================== FAILURES ===================================
________ TestErrorHandlingIntegration.test_invalid_strategy_definition _________

self = <test_strategy_backtest_integration.TestErrorHandlingIntegration object at 0x139a397e0>

    def test_invalid_strategy_definition(self):
        """测试无效策略定义的处理"""
        invalid_strategy = {
            "version": "1.0",
            "symbols": ["TEST"],
            "interval": "invalid_interval",  # 无效的时间间隔
            "conditions": [],
            "actions": [],
        }

        backtest_engine = BacktestEngine(initial_capital=100000)

        # 创建测试数据
        dates = pd.date_range("2023-01-01", periods=20, freq="D")
        test_data = pd.DataFrame(
            {
                "open": np.random.uniform(100, 200, 20),
                "high": np.random.uniform(100, 200, 20),
                "low": np.random.uniform(100, 200, 20),
                "close": np.random.uniform(100, 200, 20),
                "volume": np.random.uniform(100000, 500000, 20),
            },
            index=dates,
        )

        # 应该正确处理无效策略
>       results = backtest_engine.run_backtest(
            data=test_data, strategy_definition=invalid_strategy
        )

backend/tests/integration/analytics/test_strategy_backtest_integration.py:282:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
backend/app/analytics/backtest/backtester.py:98: in run_backtest
    performance = self._calculate_performance_metrics()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.analytics.backtest.backtester.BacktestEngine object at 0x139a4a6b0>

    def _calculate_performance_metrics(self) -> dict[str, float]:
        """计算性能指标"""
        if not self.equity_curve:
            return {}
        equity_values = [point["portfolio_value"] for point in self.equity_curve]
        returns = np.diff(equity_values) / equity_values[:-1]
        # 总收益率
        total_return = (equity_values[-1] / equity_values[0] - 1) * 100
        # 年化收益率
        days = (
            self.equity_curve[-1]["timestamp"] - self.equity_curve[0]["timestamp"]
        ).days
        annual_return = (1 + total_return / 100) ** (365 / max(days, 1)) - 1
        # 夏普比率
        sharpe_ratio = (
>           np.mean(returns) / np.std(returns) * np.sqrt(252) if len(returns) > 1 else 0
        )
E       RuntimeWarning: invalid value encountered in scalar divide

backend/app/analytics/backtest/backtester.py:242: RuntimeWarning
------------------------------ Captured log call -------------------------------
ERROR    app.analytics.backtest.backtester:backtester.py:108 回测执行失败: invalid value encountered in scalar divide
______ TestErrorHandlingIntegration.test_insufficient_data_for_indicators ______

self = <test_strategy_backtest_integration.TestErrorHandlingIntegration object at 0x139a3a7a0>

    def test_insufficient_data_for_indicators(self):
        """测试指标计算数据不足的情况"""
        strategy_def = {
            "version": "1.0",
            "symbols": ["TEST"],
            "interval": "1d",
            "conditions": [
                {
                    "id": 0,
                    "type": "technical",
                    "indicator": "sma",
                    "operator": ">",
                    "value": 150,
                    "lookback_period": 50,  # 需要50期数据
                }
            ],
            "actions": [{"type": "buy", "condition_id": 0, "position_size": 0.1}],
        }

        # 创建数据不足的测试数据
        dates = pd.date_range("2023-01-01", periods=30, freq="D")  # 只有30期数据
        test_data = pd.DataFrame(
            {
                "open": np.random.uniform(100, 200, 30),
                "high": np.random.uniform(100, 200, 30),
                "low": np.random.uniform(100, 200, 30),
                "close": np.random.uniform(100, 200, 30),
                "volume": np.random.uniform(100000, 500000, 30),
            },
            index=dates,
        )

        backtest_engine = BacktestEngine(initial_capital=100000)

        # 应该正确处理数据不足的情况
>       results = backtest_engine.run_backtest(
            data=test_data, strategy_definition=strategy_def
        )

backend/tests/integration/analytics/test_strategy_backtest_integration.py:327:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
backend/app/analytics/backtest/backtester.py:98: in run_backtest
    performance = self._calculate_performance_metrics()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <app.analytics.backtest.backtester.BacktestEngine object at 0x139d239d0>

    def _calculate_performance_metrics(self) -> dict[str, float]:
        """计算性能指标"""
        if not self.equity_curve:
            return {}
        equity_values = [point["portfolio_value"] for point in self.equity_curve]
        returns = np.diff(equity_values) / equity_values[:-1]
        # 总收益率
        total_return = (equity_values[-1] / equity_values[0] - 1) * 100
        # 年化收益率
        days = (
            self.equity_curve[-1]["timestamp"] - self.equity_curve[0]["timestamp"]
        ).days
        annual_return = (1 + total_return / 100) ** (365 / max(days, 1)) - 1
        # 夏普比率
        sharpe_ratio = (
>           np.mean(returns) / np.std(returns) * np.sqrt(252) if len(returns) > 1 else 0
        )
E       RuntimeWarning: invalid value encountered in scalar divide

backend/app/analytics/backtest/backtester.py:242: RuntimeWarning
------------------------------ Captured log call -------------------------------
ERROR    app.analytics.backtest.backtester:backtester.py:108 回测执行失败: invalid value encountered in scalar divide
______________________ test_fetch_from_api_when_db_empty _______________________

mock_fetch_a_share = <MagicMock name='fetch_a_share_data_from_akshare' id='5267527648'>
db_session = <sqlalchemy.orm.session.Session object at 0x139f80970>
mock_stock_data_api =   trade_date  close  high   low  open   vol  amount
0 2023-01-03   10.5  10.7  10.4  10.4  1200   12600
1 2023-01-04   10.6  10.8  10.5  10.6  1300   13780

    @patch(
        "app.data.fetchers.stock_fetchers.a_share_fetcher.fetch_a_share_data_from_akshare"
    )
    def test_fetch_from_api_when_db_empty(
        mock_fetch_a_share, db_session, mock_stock_data_api
    ):
        """Tests that the API is called when the database is empty."""
        # 1. Setup: Mock the API fetcher
        mock_fetch_a_share.return_value = mock_stock_data_api

        # 2. Action: Instantiate fetcher and call the main fetch method
        fetcher = StockDataFetcher(
            db=db_session, stock_code="TEST.SH", interval="daily", market_type="A_share"
        )
        df = fetcher.fetch_stock_data()

        # 3. Assert: Check API call and returned data
        mock_fetch_a_share.assert_called_once()
        assert not df.empty
        assert len(df) == 2
        assert df["close"].iloc[0] == 10.5

        # 4. Assert: Check if data was stored in the DB
>       db_df = pd.read_sql(
            text("SELECT * FROM stock_data WHERE ts_code='TEST.SH'"),
            db_session.connection(),
        )

backend/tests/integration/test_services.py:432:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/pandas/io/sql.py:734: in read_sql
    return pandas_sql.read_query(
/usr/local/lib/python3.10/site-packages/pandas/io/sql.py:1836: in read_query
    result = self.execute(sql, params)
/usr/local/lib/python3.10/site-packages/pandas/io/sql.py:1660: in execute
    return self.con.execute(sql, *args)
/usr/local/lib/python3.10/site-packages/sqlalchemy/engine/base.py:1415: in execute
    return meth(
/usr/local/lib/python3.10/site-packages/sqlalchemy/sql/elements.py:523: in _execute_on_connection
    return connection._execute_clauseelement(
/usr/local/lib/python3.10/site-packages/sqlalchemy/engine/base.py:1637: in _execute_clauseelement
    ret = self._execute_context(
/usr/local/lib/python3.10/site-packages/sqlalchemy/engine/base.py:1809: in _execute_context
    conn = self._revalidate_connection()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <sqlalchemy.engine.base.Connection object at 0x13a018370>

    def _revalidate_connection(self) -> PoolProxiedConnection:
        if self.__can_reconnect and self.invalidated:
            if self._transaction is not None:
                self._invalid_transaction()
            self._dbapi_connection = self.engine.raw_connection()
            return self._dbapi_connection
>       raise exc.ResourceClosedError("This Connection is closed")
E       sqlalchemy.exc.ResourceClosedError: This Connection is closed

/usr/local/lib/python3.10/site-packages/sqlalchemy/engine/base.py:678: ResourceClosedError
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:132 Querying DB for TEST.SH from 2010-09-29 to 2025-09-25
INFO     app.data.managers.data_manager:data_manager.py:119 DB data for TEST.SH is missing or stale. Fetching from API.
INFO     app.data.managers.data_manager:data_manager.py:173 Storing 2 records for TEST.SH into the database.
INFO     app.data.quality.quality_manager:quality_manager.py:157 开始处理数据质量，数据量: 2
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 开始处理 2 条 A_share 数据
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 2 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 2 条，去重后 1 条
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量处理完成
INFO     app.data.quality.quality_manager:quality_manager.py:238 数据质量处理完成，耗时: 1.02秒
INFO     app.data.managers.database_writer:database_writer.py:57 Data quality summary for TEST.SH: 去重报告: 处理了 2 条记录, 发现 2 个重复, 移除了 1 个重复记录, 执行时间: 0.00 秒
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.data.managers.data_manager:data_manager.py:182 Successfully stored data in DB.
_________________________ test_websocket_subscription __________________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_subscription(client):
        client_id = "test_client_001"

        try:
            print("正在连接...")
>           with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:

backend/tests/integration/test_websocket_basic.py:19:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a1f54e0>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_subscription(client):
        client_id = "test_client_001"

        try:
            print("正在连接...")
            with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:
                print("✅ WebSocket连接成功!")

                # 1. 接收连接确认
                conn_ack_msg = websocket.receive_text()
                print(f"收到连接确认: {conn_ack_msg}")

                # 2. 发送订阅消息
                subscribe_message = {"type": "subscribe", "topic": "stock.AAPL.1m"}
                print(f"发送订阅消息: {json.dumps(subscribe_message, ensure_ascii=False)}")
                websocket.send_text(json.dumps(subscribe_message))

                # 3. 接收订阅确认
                sub_ack_msg = websocket.receive_text()
                print(f"收到订阅确认: {sub_ack_msg}")

                received_subscribe_ack = False
                try:
                    data = json.loads(sub_ack_msg)
                    if data.get("type") == "subscribe_ack":
                        received_subscribe_ack = True
                        print("✅ 收到订阅确认")
                except json.JSONDecodeError:
                    print(f"非JSON消息: {sub_ack_msg}")

                assert received_subscribe_ack, "未收到订阅确认"

                # 4. 取消订阅
                unsubscribe_message = {"type": "unsubscribe", "topic": "stock.AAPL.1m"}
                print(
                    f"发送取消订阅消息: {json.dumps(unsubscribe_message, ensure_ascii=False)}"
                )
                websocket.send_text(json.dumps(unsubscribe_message))

                # 5. 接收取消订阅确认
                unsub_ack_msg = websocket.receive_text()
                print(f"收到取消订阅确认: {unsub_ack_msg}")

                received_unsubscribe_ack = False
                try:
                    data = json.loads(unsub_ack_msg)
                    if data.get("type") == "unsubscribe_ack":
                        received_unsubscribe_ack = True
                        print("✅ 收到取消订阅确认")
                except json.JSONDecodeError:
                    print(f"非JSON消息: {unsub_ack_msg}")

                assert received_unsubscribe_ack, "未收到取消订阅确认"

                print("✅ WebSocket测试完成")

        except Exception as e:
            print(f"❌ 测试失败: {e}")
>           pytest.fail(f"❌ 测试失败: {e}")
E           Failed: ❌ 测试失败:

backend/tests/integration/test_websocket_basic.py:72: Failed
------------------------------ Captured log setup ------------------------------
INFO     app.main:main.py:196 正在启动应用...
INFO     app.main:main.py:200 检测到测试环境，跳过数据库/缓存/调度器等重型初始化。
------------------------------ Captured log call -------------------------------
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=test_client_001, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
________________________ test_websocket_connection_only ________________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_connection_only(client):
        """仅测试WebSocket连接"""
        client_id = "test_client_connection"

        try:
            print("测试连接...")
>           with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:

backend/tests/integration/test_websocket_basic.py:82:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a019570>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_connection_only(client):
        """仅测试WebSocket连接"""
        client_id = "test_client_connection"

        try:
            print("测试连接...")
            with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:
                print("✅ WebSocket连接测试成功!")

                # 发送ping消息
                websocket.send_text("ping")
                print("发送了ping消息")

                # 等待响应
                try:
                    response = websocket.receive_text()
                    print(f"收到响应: {response}")
                except Exception:
                    print("未收到响应（这是正常的，因为服务器可能不处理ping消息）")

        except Exception as e:
            print(f"❌ 连接测试失败: {e}")
>           pytest.fail(f"❌ 连接测试失败: {e}")
E           Failed: ❌ 连接测试失败:

backend/tests/integration/test_websocket_basic.py:98: Failed
------------------------------ Captured log call -------------------------------
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=test_client_connection, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
_________________________ test_websocket_invalid_json __________________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_invalid_json(client):
        """测试发送无效JSON"""
        logger.info("测试: 发送无效JSON")
        client_id = "test_invalid_json"

        try:
>           with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:

backend/tests/integration/test_websocket_error.py:26:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a2b82b0>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_invalid_json(client):
        """测试发送无效JSON"""
        logger.info("测试: 发送无效JSON")
        client_id = "test_invalid_json"

        try:
            with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:
                # 等待连接确认
                ack = websocket.receive_text()
                logger.info(f"连接确认: {ack}")

                # 发送无效JSON
                websocket.send_text("这不是有效的JSON")

                # 等待服务器响应
                try:
                    response = websocket.receive_text()
                    logger.info(f"收到响应: {response}")

                    # 验证响应是错误消息
                    response_data = json.loads(response)
                    assert response_data.get("type") == "error"
                    assert "invalid_json" in response_data.get("error_code", "")

                except Exception:
                    logger.info("没有收到响应 - 这是可接受的行为")
                    pass

        except Exception as e:
            logger.error(f"无效JSON测试失败: {e}")
>           pytest.fail(f"无效JSON测试失败: {e}")
E           Failed: 无效JSON测试失败:

backend/tests/integration/test_websocket_error.py:50: Failed
------------------------------ Captured log call -------------------------------
INFO     backend.tests.integration.test_websocket_error:test_websocket_error.py:22 测试: 发送无效JSON
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=test_invalid_json, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
ERROR    backend.tests.integration.test_websocket_error:test_websocket_error.py:49 无效JSON测试失败:
_____________________ test_websocket_invalid_message_type ______________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_invalid_message_type(client):
        """测试发送无效消息类型"""
        logger.info("测试: 发送无效消息类型")
        client_id = "test_invalid_type"

        try:
>           with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:

backend/tests/integration/test_websocket_error.py:60:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a1d0610>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_invalid_message_type(client):
        """测试发送无效消息类型"""
        logger.info("测试: 发送无效消息类型")
        client_id = "test_invalid_type"

        try:
            with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:
                # 等待连接确认
                ack = websocket.receive_text()
                logger.info(f"连接确认: {ack}")

                # 发送无效消息类型
                invalid_message = {"type": "invalid_type", "data": "test"}
                websocket.send_text(json.dumps(invalid_message))

                # 尝试接收响应
                try:
                    response = websocket.receive_text()
                    logger.info(f"收到响应: {response}")
                    # 服务器应该返回错误消息
                    assert response is not None
                except Exception:
                    logger.info("没有收到响应 - 这是可接受的行为")
                    pass

        except Exception as e:
            logger.error(f"无效消息类型测试失败: {e}")
>           pytest.fail(f"无效消息类型测试失败: {e}")
E           Failed: 无效消息类型测试失败:

backend/tests/integration/test_websocket_error.py:81: Failed
------------------------------ Captured log call -------------------------------
INFO     backend.tests.integration.test_websocket_error:test_websocket_error.py:56 测试: 发送无效消息类型
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=test_invalid_type, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
ERROR    backend.tests.integration.test_websocket_error:test_websocket_error.py:80 无效消息类型测试失败:
______________________ test_websocket_malformed_subscribe ______________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_malformed_subscribe(client):
        """测试格式错误的订阅消息"""
        logger.info("测试: 发送格式错误的订阅消息")
        client_id = "test_malformed_subscribe"

        try:
>           with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:

backend/tests/integration/test_websocket_error.py:91:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a03b2b0>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_malformed_subscribe(client):
        """测试格式错误的订阅消息"""
        logger.info("测试: 发送格式错误的订阅消息")
        client_id = "test_malformed_subscribe"

        try:
            with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:
                # 等待连接确认
                ack = websocket.receive_text()
                logger.info(f"连接确认: {ack}")

                # 发送缺少topic的订阅消息
                malformed_message = {"type": "subscribe"}  # 缺少topic
                websocket.send_text(json.dumps(malformed_message))

                # 发送无效topic的订阅消息
                invalid_topic_message = {"type": "subscribe", "topic": ""}  # 空topic
                websocket.send_text(json.dumps(invalid_topic_message))

                # 尝试接收响应
                try:
                    response = websocket.receive_text()
                    logger.info(f"收到响应: {response}")
                    assert response is not None
                except Exception:
                    logger.info("没有收到响应")
                    pass

        except Exception as e:
            logger.error(f"格式错误订阅测试失败: {e}")
>           pytest.fail(f"格式错误订阅测试失败: {e}")
E           Failed: 格式错误订阅测试失败:

backend/tests/integration/test_websocket_error.py:115: Failed
------------------------------ Captured log call -------------------------------
INFO     backend.tests.integration.test_websocket_error:test_websocket_error.py:87 测试: 发送格式错误的订阅消息
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=test_malformed_subscribe, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
ERROR    backend.tests.integration.test_websocket_error:test_websocket_error.py:114 格式错误订阅测试失败:
_________________________ test_websocket_large_message _________________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_large_message(client):
        """测试发送大消息"""
        logger.info("测试: 发送大消息")
        client_id = "test_large_message"

        try:
>           with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:

backend/tests/integration/test_websocket_error.py:145:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a2b87f0>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_large_message(client):
        """测试发送大消息"""
        logger.info("测试: 发送大消息")
        client_id = "test_large_message"

        try:
            with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:
                # 等待连接确认
                ack = websocket.receive_text()
                logger.info(f"连接确认: {ack}")

                # 创建一个大消息
                large_data = "x" * 5000  # 5KB
                large_message = {
                    "type": "subscribe",
                    "topic": "stock.AAPL.1m",
                    "large_data": large_data,
                }
                websocket.send_text(json.dumps(large_message))

                # 尝试接收响应
                try:
                    response = websocket.receive_text()
                    logger.info(f"收到响应长度: {len(response)}")
                    assert response is not None
                except Exception:
                    logger.info("没有收到响应")
                    pass

        except Exception as e:
            logger.error(f"大消息测试失败: {e}")
>           pytest.fail(f"大消息测试失败: {e}")
E           Failed: 大消息测试失败:

backend/tests/integration/test_websocket_error.py:170: Failed
------------------------------ Captured log call -------------------------------
INFO     backend.tests.integration.test_websocket_error:test_websocket_error.py:141 测试: 发送大消息
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=test_large_message, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
ERROR    backend.tests.integration.test_websocket_error:test_websocket_error.py:169 大消息测试失败:
___________________ test_websocket_concurrent_subscriptions ____________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_concurrent_subscriptions(client):
        """测试并发订阅相同主题"""
        logger.info("测试: 并发订阅相同主题")

        try:
>           with (
                client.websocket_connect("/api/v1/ws/concurrent_test_1") as websocket1,
                client.websocket_connect("/api/v1/ws/concurrent_test_2") as websocket2,
                client.websocket_connect("/api/v1/ws/concurrent_test_3") as websocket3,
            ):

backend/tests/integration/test_websocket_error.py:179:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a20db40>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_websocket_concurrent_subscriptions(client):
        """测试并发订阅相同主题"""
        logger.info("测试: 并发订阅相同主题")

        try:
            with (
                client.websocket_connect("/api/v1/ws/concurrent_test_1") as websocket1,
                client.websocket_connect("/api/v1/ws/concurrent_test_2") as websocket2,
                client.websocket_connect("/api/v1/ws/concurrent_test_3") as websocket3,
            ):

                websockets = [websocket1, websocket2, websocket3]

                for i, websocket in enumerate(websockets):
                    # 等待连接确认
                    ack = websocket.receive_text()
                    logger.info(f"并发连接 {i} 确认: {ack}")

                    # 所有连接订阅相同主题
                    subscribe_message = {"type": "subscribe", "topic": "stock.AAPL.1m"}
                    websocket.send_text(json.dumps(subscribe_message))

        except Exception as e:
            logger.error(f"并发订阅测试失败: {e}")
>           pytest.fail(f"并发订阅测试失败: {e}")
E           Failed: 并发订阅测试失败:

backend/tests/integration/test_websocket_error.py:198: Failed
------------------------------ Captured log call -------------------------------
INFO     backend.tests.integration.test_websocket_error:test_websocket_error.py:176 测试: 并发订阅相同主题
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=concurrent_test_1, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
ERROR    backend.tests.integration.test_websocket_error:test_websocket_error.py:197 并发订阅测试失败:
____________________________ test_single_connection ____________________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_single_connection(client):
        """测试单个连接"""
        print("🔍 测试单个WebSocket连接...")

        try:
>           with client.websocket_connect("/api/v1/ws/test_client") as websocket:

backend/tests/integration/test_websocket_fix.py:17:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a2d3520>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_single_connection(client):
        """测试单个连接"""
        print("🔍 测试单个WebSocket连接...")

        try:
            with client.websocket_connect("/api/v1/ws/test_client") as websocket:
                print("✅ 连接成功")

                # 等待确认
                ack = websocket.receive_text()
                ack_data = json.loads(ack)
                print(f"📨 收到确认: {ack_data['client_id']}")

                # 测试ping
                websocket.send_text(json.dumps({"type": "ping"}))
                _response = websocket.receive_text()
                print("✅ ping/pong 成功")

                # 测试订阅
                websocket.send_text(
                    json.dumps({"type": "subscribe", "topic": "test_topic"})
                )
                _response = websocket.receive_text()
                print("✅ 订阅成功")

                # 断开连接
                # TestClient 会在 with 块结束时自动关闭连接
                print("✅ 连接正常断开")
                assert True

        except Exception as e:
            print(f"❌ 单连接测试失败: {e}")
>           pytest.fail(f"❌ 单连接测试失败: {e}")
E           Failed: ❌ 单连接测试失败:

backend/tests/integration/test_websocket_fix.py:44: Failed
------------------------------ Captured log call -------------------------------
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=test_client, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
__________________________ test_multiple_connections ___________________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_multiple_connections(client):
        """测试多个连接"""
        print("🔍 测试多个WebSocket连接...")

        with ExitStack() as stack:
            connections = []
            try:
                # 创建5个连接
                for i in range(5):
>                   websocket = stack.enter_context(
                        client.websocket_connect(f"/api/v1/ws/lifecycle_test_{i}")
                    )

backend/tests/integration/test_websocket_fix.py:57:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/contextlib.py:492: in enter_context
    result = _cm_type.__enter__(cm)
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a20fa00>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_multiple_connections(client):
        """测试多个连接"""
        print("🔍 测试多个WebSocket连接...")

        with ExitStack() as stack:
            connections = []
            try:
                # 创建5个连接
                for i in range(5):
                    websocket = stack.enter_context(
                        client.websocket_connect(f"/api/v1/ws/lifecycle_test_{i}")
                    )
                    connections.append((f"lifecycle_test_{i}", websocket))

                    # 等待确认
                    _ack = websocket.receive_text()
                    print(f"✅ 连接 {i+1}/5 创建成功")

                # 发送消息
                for client_id, websocket in connections:
                    websocket.send_text(json.dumps({"type": "ping"}))
                    _response = websocket.receive_text()
                    print(f"✅ {client_id} ping/pong 成功")

                print("✅ 多连接测试成功")

            except Exception as e:
                print(f"❌ 多连接测试失败: {e}")
>               pytest.fail(f"❌ 多连接测试失败: {e}")
E               Failed: ❌ 多连接测试失败:

backend/tests/integration/test_websocket_fix.py:76: Failed
------------------------------ Captured log call -------------------------------
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=lifecycle_test_0, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
_____________________ test_websocket_multiple_connections ______________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    @pytest.mark.slow
    def test_websocket_multiple_connections(client):
        """测试多个并发连接"""
        logger.info("测试: 多个并发连接")
        connection_count = 5  # 适中的连接数量

        def connect_and_send(i):
            try:
                with client.websocket_connect(f"/api/v1/ws/stress_client_{i}") as websocket:
                    # 等待连接确认
                    ack = websocket.receive_text()
                    logger.info(f"客户端 stress_client_{i} 连接成功: {ack}")

                    # 测试消息发送
                    message = {"type": "subscribe", "topic": "stock.AAPL.1m"}
                    websocket.send_text(json.dumps(message))
                    logger.info(f"向连接 {i} 发送消息成功")
                    return True
            except Exception as e:
                logger.error(f"客户端 stress_client_{i} 连接失败: {e}")
                return False

        with ThreadPoolExecutor(max_workers=connection_count) as executor:
            results = list(executor.map(connect_and_send, range(connection_count)))

        successful_connections = sum(results)
        logger.info(f"成功建立 {successful_connections}/{connection_count} 个连接")
>       assert successful_connections > 0, "至少应该有一个连接成功"
E       AssertionError: 至少应该有一个连接成功
E       assert 0 > 0

backend/tests/integration/test_websocket_stress.py:47: AssertionError
------------------------------ Captured log call -------------------------------
INFO     backend.tests.integration.test_websocket_stress:test_websocket_stress.py:23 测试: 多个并发连接
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=stress_client_0, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=stress_client_1, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=stress_client_2, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=stress_client_3, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=stress_client_4, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
ERROR    backend.tests.integration.test_websocket_stress:test_websocket_stress.py:39 客户端 stress_client_4 连接失败:
ERROR    backend.tests.integration.test_websocket_stress:test_websocket_stress.py:39 客户端 stress_client_3 连接失败:
ERROR    backend.tests.integration.test_websocket_stress:test_websocket_stress.py:39 客户端 stress_client_1 连接失败:
ERROR    backend.tests.integration.test_websocket_stress:test_websocket_stress.py:39 客户端 stress_client_2 连接失败:
ERROR    backend.tests.integration.test_websocket_stress:test_websocket_stress.py:39 客户端 stress_client_0 连接失败:
INFO     backend.tests.integration.test_websocket_stress:test_websocket_stress.py:46 成功建立 0/5 个连接
_________________________ test_websocket_message_burst _________________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    @pytest.mark.slow
    def test_websocket_message_burst(client):
        """测试消息突发发送"""
        logger.info("测试: 消息突发发送")
        client_id = "burst_test_client"

        try:
>           with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:

backend/tests/integration/test_websocket_stress.py:58:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a05fdc0>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    @pytest.mark.slow
    def test_websocket_message_burst(client):
        """测试消息突发发送"""
        logger.info("测试: 消息突发发送")
        client_id = "burst_test_client"

        try:
            with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:
                # 等待连接确认
                ack = websocket.receive_text()
                logger.info(f"连接确认: {ack}")

                # 快速发送多条消息
                message_count = 10
                for i in range(message_count):
                    message = {"type": "subscribe", "topic": f"stock.SYMBOL_{i}.1m"}
                    websocket.send_text(json.dumps(message))

                logger.info(f"发送了 {message_count} 条消息")

                # 尝试接收响应
                responses = 0
                try:
                    while responses < 5:  # 最多接收5个响应
                        response = websocket.receive_text()
                        responses += 1
                        logger.info(f"收到响应 {responses}: {response[:100]}...")
                except Exception:
                    logger.info(f"总共收到 {responses} 个响应")

        except Exception as e:
            logger.error(f"消息突发测试失败: {e}")
>           pytest.fail(f"消息突发测试失败: {e}")
E           Failed: 消息突发测试失败:

backend/tests/integration/test_websocket_stress.py:83: Failed
------------------------------ Captured log call -------------------------------
INFO     backend.tests.integration.test_websocket_stress:test_websocket_stress.py:54 测试: 消息突发发送
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=burst_test_client, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
ERROR    backend.tests.integration.test_websocket_stress:test_websocket_stress.py:82 消息突发测试失败:
_____________________ test_websocket_concurrent_operations _____________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    @pytest.mark.slow
    def test_websocket_concurrent_operations(client):
        """测试并发操作"""
        logger.info("测试: 并发操作")

        def client_task(client_id: str):
            """单个客户端任务"""
            try:
                with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:
                    # 等待连接确认
                    websocket.receive_text()
                    logger.info(f"{client_id}: 连接确认")

                    # 执行多个操作
                    operations = [
                        {"type": "subscribe", "topic": "stock.AAPL.1m"},
                        {"type": "subscribe", "topic": "stock.GOOGL.1m"},
                        {"type": "ping"},
                        {"type": "unsubscribe", "topic": "stock.AAPL.1m"},
                    ]

                    for op in operations:
                        websocket.send_text(json.dumps(op))

                    return True
            except Exception as e:
                logger.warning(f"{client_id} 任务失败: {e}")
                return False

        # 并发执行多个客户端任务
        client_count = 3
        with ThreadPoolExecutor(max_workers=client_count) as executor:
            results = list(
                executor.map(
                    client_task, [f"concurrent_client_{i}" for i in range(client_count)]
                )
            )

        # 统计结果
        successful = sum(results)
        logger.info(f"并发操作结果: {successful}/{client_count} 成功")

        # 至少应该有一半的操作成功
>       assert successful >= client_count // 2, f"成功率过低: {successful}/{client_count}"
E       AssertionError: 成功率过低: 0/3
E       assert 0 >= (3 // 2)

backend/tests/integration/test_websocket_stress.py:162: AssertionError
------------------------------ Captured log call -------------------------------
INFO     backend.tests.integration.test_websocket_stress:test_websocket_stress.py:122 测试: 并发操作
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=concurrent_client_0, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=concurrent_client_1, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=concurrent_client_2, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
WARNING  backend.tests.integration.test_websocket_stress:test_websocket_stress.py:145 concurrent_client_1 任务失败:
WARNING  backend.tests.integration.test_websocket_stress:test_websocket_stress.py:145 concurrent_client_0 任务失败:
WARNING  backend.tests.integration.test_websocket_stress:test_websocket_stress.py:145 concurrent_client_2 任务失败:
INFO     backend.tests.integration.test_websocket_stress:test_websocket_stress.py:159 并发操作结果: 0/3 成功
____________________ test_websocket_long_running_connection ____________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    @pytest.mark.slow
    def test_websocket_long_running_connection(client):
        """测试长时间运行的连接"""
        logger.info("测试: 长时间运行的连接")
        client_id = "long_running_client"

        try:
>           with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:

backend/tests/integration/test_websocket_stress.py:173:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a20f2e0>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    @pytest.mark.slow
    def test_websocket_long_running_connection(client):
        """测试长时间运行的连接"""
        logger.info("测试: 长时间运行的连接")
        client_id = "long_running_client"

        try:
            with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:
                # 等待连接确认
                ack = websocket.receive_text()
                logger.info(f"连接确认: {ack}")

                # 订阅数据
                subscribe_message = {"type": "subscribe", "topic": "stock.AAPL.1m"}
                websocket.send_text(json.dumps(subscribe_message))

                # 保持连接一段时间，定期发送心跳
                duration = 5  # 5秒
                start_time = time.time()

                while time.time() - start_time < duration:
                    # 发送心跳
                    ping_message = {"type": "ping"}
                    websocket.send_text(json.dumps(ping_message))

                    # 尝试接收消息
                    try:
                        response = websocket.receive_text()
                        logger.info(f"收到消息: {response[:100]}...")
                    except Exception:
                        logger.info("心跳周期内无消息")

                    time.sleep(1)  # 1秒心跳间隔

                logger.info(f"长连接测试完成，持续时间: {duration}秒")

        except Exception as e:
            logger.error(f"长连接测试失败: {e}")
>           pytest.fail(f"长连接测试失败: {e}")
E           Failed: 长连接测试失败:

backend/tests/integration/test_websocket_stress.py:204: Failed
------------------------------ Captured log call -------------------------------
INFO     backend.tests.integration.test_websocket_stress:test_websocket_stress.py:169 测试: 长时间运行的连接
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=long_running_client, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
ERROR    backend.tests.integration.test_websocket_stress:test_websocket_stress.py:203 长连接测试失败:
______________________________ test_subscription _______________________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_subscription(client):
        """测试WebSocket订阅功能"""
        client_id = "test_subscription_client"

        print("=== WebSocket订阅测试开始 ===")

        try:
>           with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:

backend/tests/integration/test_websocket_subscription.py:20:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a1f6230>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_subscription(client):
        """测试WebSocket订阅功能"""
        client_id = "test_subscription_client"

        print("=== WebSocket订阅测试开始 ===")

        try:
            with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:
                print("✅ WebSocket连接成功!")

                # 1. 接收连接确认
                response = websocket.receive_text()
                print(f"收到连接确认: {response}")

                # 2. 发送订阅消息
                subscribe_message = {"type": "subscribe", "topic": "stock.AAPL.1m"}
                print(f"发送订阅消息: {json.dumps(subscribe_message, ensure_ascii=False)}")
                websocket.send_text(json.dumps(subscribe_message))

                # 3. 接收订阅确认
                sub_ack_msg = websocket.receive_text()
                print(f"收到订阅确认: {sub_ack_msg}")
                sub_ack_data = json.loads(sub_ack_msg)
                assert sub_ack_data.get("type") == "subscribe_ack"

                # 4. 发送取消订阅消息
                unsubscribe_message = {"type": "unsubscribe", "topic": "stock.AAPL.1m"}
                print(
                    f"发送取消订阅消息: {json.dumps(unsubscribe_message, ensure_ascii=False)}"
                )
                websocket.send_text(json.dumps(unsubscribe_message))

                # 5. 接收取消订阅确认
                unsub_ack_msg = websocket.receive_text()
                print(f"收到取消订阅确认: {unsub_ack_msg}")
                unsub_ack_data = json.loads(unsub_ack_msg)
                assert unsub_ack_data.get("type") == "unsubscribe_ack"

                print("✅ 订阅测试完成")

        except Exception as e:
            print(f"❌ 订阅测试失败: {e}")
>           pytest.fail(f"订阅测试失败: {e}")
E           Failed: 订阅测试失败:

backend/tests/integration/test_websocket_subscription.py:55: Failed
------------------------------ Captured log call -------------------------------
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=test_subscription_client, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
__________________________________ test_ping ___________________________________

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_ping(client):
        """测试ping功能"""
        client_id = "test_ping_client"

        print("\n=== Ping测试开始 ===")

        try:
>           with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:

backend/tests/integration/test_websocket_subscription.py:66:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/site-packages/starlette/testclient.py:107: in __enter__
    self._raise_on_close(message)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <starlette.testclient.WebSocketTestSession object at 0x13a2b9210>
message = {'code': 1011, 'reason': 'WebSocket服务未初始化', 'type': 'websocket.close'}

    def _raise_on_close(self, message: Message) -> None:
        if message["type"] == "websocket.close":
>           raise WebSocketDisconnect(code=message.get("code", 1000), reason=message.get("reason", ""))
E           starlette.websockets.WebSocketDisconnect

/usr/local/lib/python3.10/site-packages/starlette/testclient.py:136: WebSocketDisconnect

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x13a2d2980>

    @pytest.mark.integration
    def test_ping(client):
        """测试ping功能"""
        client_id = "test_ping_client"

        print("\n=== Ping测试开始 ===")

        try:
            with client.websocket_connect(f"/api/v1/ws/{client_id}") as websocket:
                print("✅ WebSocket连接成功!")

                # 等待连接确认
                websocket.receive_text()

                # 发送ping消息
                ping_message = {"type": "ping"}
                print(f"发送ping消息: {json.dumps(ping_message)}")
                websocket.send_text(json.dumps(ping_message))

                # 等待pong响应
                response = websocket.receive_text()
                print(f"收到pong响应: {response}")

                print("✅ Ping测试完成")
                assert True

        except Exception as e:
            print(f"❌ Ping测试失败: {e}")
>           pytest.fail(f"Ping测试失败: {e}")
E           Failed: Ping测试失败:

backend/tests/integration/test_websocket_subscription.py:86: Failed
------------------------------ Captured log call -------------------------------
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=test_ping_client, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
_________________ TestBacktestEngine.test_trade_execution_buy __________________

self = <test_strategy_backtest.TestBacktestEngine object at 0x139b98eb0>

    def test_trade_execution_buy(self):
        """测试买入交易执行"""
        current_row = pd.Series({"close": 150.0})
        signals = [{"action": TradeAction.BUY, "symbol": "TEST", "quantity": 100}]

        self.engine._execute_trades(signals, current_row)

>       assert len(self.engine.trades) == 1
E       assert 0 == 1
E        +  where 0 = len([])
E        +    where [] = <app.analytics.backtest.backtester.BacktestEngine object at 0x13a324a30>.trades
E        +      where <app.analytics.backtest.backtester.BacktestEngine object at 0x13a324a30> = <test_strategy_backtest.TestBacktestEngine object at 0x139b98eb0>.engine

backend/tests/unit/analytics/test_strategy_backtest.py:212: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  app.analytics.backtest.backtester:backtester.py:172 current_date is not a datetime object, skipping trade execution.
_________________ TestBacktestEngine.test_trade_execution_sell _________________

self = <test_strategy_backtest.TestBacktestEngine object at 0x139b98f40>

    def test_trade_execution_sell(self):
        """测试卖出交易执行"""
        # 先买入
        self.engine.positions = {"TEST": 100}
        self.engine.cash = 50000

        current_row = pd.Series({"close": 160.0})
        signals = [{"action": TradeAction.SELL, "symbol": "TEST", "quantity": 100}]

        self.engine._execute_trades(signals, current_row)

>       assert len(self.engine.trades) == 1
E       assert 0 == 1
E        +  where 0 = len([])
E        +    where [] = <app.analytics.backtest.backtester.BacktestEngine object at 0x13a327c10>.trades
E        +      where <app.analytics.backtest.backtester.BacktestEngine object at 0x13a327c10> = <test_strategy_backtest.TestBacktestEngine object at 0x139b98f40>.engine

backend/tests/unit/analytics/test_strategy_backtest.py:227: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  app.analytics.backtest.backtester:backtester.py:172 current_date is not a datetime object, skipping trade execution.
==================================== PASSES ====================================
___________________________ test_clear_cache_success ___________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/admin/clear-cache "HTTP/1.1 200 OK"
_______________________ test_clear_cache_database_error ________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/admin/clear-cache "HTTP/1.1 500 Internal Server Error"
_________________________ test_clear_cache_redis_error _________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/admin/clear-cache "HTTP/1.1 500 Internal Server Error"
____________________ test_clear_cache_empty_database_result ____________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/admin/clear-cache "HTTP/1.1 200 OK"
___________________ test_clear_cache_large_deletion_numbers ____________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/admin/clear-cache "HTTP/1.1 200 OK"
_______ TestCacheServiceIntegration.test_cache_service_basic_operations ________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.cache.redis_manager:redis_manager.py:220 Redis connection established successfully
INFO     app.infrastructure.cache.redis_manager:redis_manager.py:339 Batch deleted 2 keys matching pattern: stock:info:000001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 2 cache entries for pattern: stock:info:000001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 0 cache entries for pattern: stock:daily:000001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 0 cache entries for pattern: stock:metrics:000001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:268 Invalidated cache for stock: 000001
______________ TestCacheServiceIntegration.test_cache_expiration _______________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.cache.redis_manager:redis_manager.py:339 Batch deleted 1 keys matching pattern: stock:info:test:expiration:001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 1 cache entries for pattern: stock:info:test:expiration:001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 0 cache entries for pattern: stock:daily:test:expiration:001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 0 cache entries for pattern: stock:metrics:test:expiration:001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:268 Invalidated cache for stock: test:expiration:001
__________ TestCacheServiceIntegration.test_cache_pattern_operations ___________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.cache.redis_manager:redis_manager.py:339 Batch deleted 2 keys matching pattern: stock:info:stock:info:000001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 2 cache entries for pattern: stock:info:stock:info:000001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 0 cache entries for pattern: stock:daily:stock:info:000001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 0 cache entries for pattern: stock:metrics:stock:info:000001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:268 Invalidated cache for stock: stock:info:000001
INFO     app.infrastructure.cache.redis_manager:redis_manager.py:339 Batch deleted 2 keys matching pattern: stock:info:stock:info:000002*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 2 cache entries for pattern: stock:info:stock:info:000002*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 0 cache entries for pattern: stock:daily:stock:info:000002*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 0 cache entries for pattern: stock:metrics:stock:info:000002*
INFO     app.infrastructure.cache.cache_service:cache_service.py:268 Invalidated cache for stock: stock:info:000002
INFO     app.infrastructure.cache.redis_manager:redis_manager.py:339 Batch deleted 1 keys matching pattern: stock:info:stock:data:000001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 1 cache entries for pattern: stock:info:stock:data:000001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 0 cache entries for pattern: stock:daily:stock:data:000001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 0 cache entries for pattern: stock:metrics:stock:data:000001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:268 Invalidated cache for stock: stock:data:000001
INFO     app.infrastructure.cache.redis_manager:redis_manager.py:339 Batch deleted 1 keys matching pattern: stock:info:other:data:001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 1 cache entries for pattern: stock:info:other:data:001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 0 cache entries for pattern: stock:daily:other:data:001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:262 Invalidated 0 cache entries for pattern: stock:metrics:other:data:001*
INFO     app.infrastructure.cache.cache_service:cache_service.py:268 Invalidated cache for stock: other:data:001
_____________ TestCacheWarmingIntegration.test_stock_info_warming ______________
------------------------------ Captured log call -------------------------------
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:148 A股缓存检查结果: True, force=True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:161 从数据库查询到 0 只A股
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:175 A股缓存设置结果: True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:177 Successfully cached A-share list with 0 stocks
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:189 美股缓存检查结果: True, force=True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:204 从数据库查询到 0 只美股
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:218 美股缓存设置结果: True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:220 Successfully cached US stock list with 0 stocks
INFO     app.infrastructure.cache.cache_warming:cache_warming.py:227 股票列表预热完成: 2 个列表
_____________ TestCacheWarmingIntegration.test_hot_stocks_warming ______________
------------------------------ Captured log call -------------------------------
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:148 A股缓存检查结果: True, force=True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:161 从数据库查询到 0 只A股
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:175 A股缓存设置结果: True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:177 Successfully cached A-share list with 0 stocks
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:189 美股缓存检查结果: True, force=True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:204 从数据库查询到 0 只美股
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:218 美股缓存设置结果: True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:220 Successfully cached US stock list with 0 stocks
INFO     app.infrastructure.cache.cache_warming:cache_warming.py:227 股票列表预热完成: 2 个列表
_____________ TestCacheWarmingIntegration.test_incremental_update ______________
------------------------------ Captured log call -------------------------------
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:148 A股缓存检查结果: True, force=True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:161 从数据库查询到 0 只A股
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:175 A股缓存设置结果: True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:177 Successfully cached A-share list with 0 stocks
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:189 美股缓存检查结果: True, force=True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:204 从数据库查询到 0 只美股
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:218 美股缓存设置结果: True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:220 Successfully cached US stock list with 0 stocks
INFO     app.infrastructure.cache.cache_warming:cache_warming.py:227 股票列表预热完成: 2 个列表
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:631 Successfully cached stock info for 000001.SZ
ERROR    app.infrastructure.cache.cache_warming:cache_warming.py:690 Failed to update 000001.SZ: float() argument must be a string or a real number, not 'Mock'
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:631 Successfully cached stock info for 000002.SZ
ERROR    app.infrastructure.cache.cache_warming:cache_warming.py:690 Failed to update 000002.SZ: float() argument must be a string or a real number, not 'Mock'
______ TestCacheWarmingIntegration.test_cache_warming_with_force_refresh _______
------------------------------ Captured log call -------------------------------
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:148 A股缓存检查结果: True, force=True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:161 从数据库查询到 0 只A股
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:175 A股缓存设置结果: True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:177 Successfully cached A-share list with 0 stocks
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:189 美股缓存检查结果: True, force=True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:204 从数据库查询到 0 只美股
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:218 美股缓存设置结果: True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:220 Successfully cached US stock list with 0 stocks
INFO     app.infrastructure.cache.cache_warming:cache_warming.py:227 股票列表预热完成: 2 个列表
____ TestPerformanceMonitoringIntegration.test_cache_operations_monitoring _____
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:529 统计信息已重置: cache=None, endpoint=None
_____ TestPerformanceMonitoringIntegration.test_api_performance_monitoring _____
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:529 统计信息已重置: cache=None, endpoint=None
_____ TestPerformanceMonitoringIntegration.test_metrics_summary_generation _____
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:529 统计信息已重置: cache=None, endpoint=None
____________ TestFullSystemIntegration.test_complete_cache_workflow ____________
------------------------------ Captured log call -------------------------------
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:148 A股缓存检查结果: True, force=True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:161 从数据库查询到 0 只A股
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:175 A股缓存设置结果: True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:177 Successfully cached A-share list with 0 stocks
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:189 美股缓存检查结果: True, force=True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:204 从数据库查询到 0 只美股
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:218 美股缓存设置结果: True
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:220 Successfully cached US stock list with 0 stocks
INFO     app.infrastructure.cache.cache_warming:cache_warming.py:227 股票列表预热完成: 2 个列表
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:153 性能监控已停止
_____________________ test_update_stock_list_from_akshare ______________________
------------------------------ Captured log call -------------------------------
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:304 Could not find a valid code column for bj. Skipping.
ERROR    app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:343 Failed to fetch ETF list from Akshare: '代码'
INFO     app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:373 Successfully upserted 3 stocks and ETFs into the database.
__________________________ test_update_us_stock_list ___________________________
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:436 Fetching S&P 500 tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:438 Fetched 2 S&P 500 tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching NASDAQ tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 2 NASDAQ tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching Dow Jones tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 1 Dow Jones tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching other US (NYSE/AMEX/etc.) tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 1 other US (NYSE/AMEX/etc.) tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:478 Total unique symbols fetched from yahoo_fin: 6
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:496 Total qualified symbols after filtering: 6
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:532 Successfully upserted 6 US stock entries into DB.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:635 Starting to update US stock names from yfinance...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:648 Found 6 US stocks to update names
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:677 Successfully updated 6 US stock names from yfinance
________________________ test_clear_all_financial_data _________________________
------------------------------ Captured log call -------------------------------
WARNING  app.data.managers.database_writer:database_writer.py:227 Fundamental data quality issues for MSFT: 校验报告: 数据无效, 质量评分: 0.40, 错误: 3 个, 警告: 0 个, 执行时间: 0.000 秒
ERROR    app.data.managers.database_writer:database_writer.py:232 Validation error: 必填字段 'code' 缺失
ERROR    app.data.managers.database_writer:database_writer.py:232 Validation error: 必填字段 'date' 缺失
ERROR    app.data.managers.database_writer:database_writer.py:232 Validation error: 必填字段 'close' 缺失
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.data.managers.database_writer:database_writer.py:265 Successfully upserted fundamental data for MSFT.
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.data.quality.quality_manager:quality_manager.py:157 开始处理数据质量，数据量: 1
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 开始处理 1 条 A_share 数据
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 1 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量处理完成
INFO     app.data.quality.quality_manager:quality_manager.py:238 数据质量处理完成，耗时: 1.00秒
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.data.quality.quality_manager:quality_manager.py:157 开始处理数据质量，数据量: 1
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 开始处理 1 条 A_share 数据
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 1 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量处理完成
INFO     app.data.quality.quality_manager:quality_manager.py:238 数据质量处理完成，耗时: 1.01秒
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.data.managers.database_admin:database_admin.py:23 Cleared 1 fundamental data records.
INFO     app.data.managers.database_admin:database_admin.py:24 Cleared 1 corporate action records.
INFO     app.data.managers.database_admin:database_admin.py:25 Cleared 1 annual earning records.
_________________________ test_store_stock_data_insert _________________________
------------------------------ Captured log call -------------------------------
INFO     app.data.quality.quality_manager:quality_manager.py:157 开始处理数据质量，数据量: 2
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 开始处理 2 条 A_share 数据
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 2 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.04MB
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 2 条，去重后 1 条
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量处理完成
INFO     app.data.quality.quality_manager:quality_manager.py:238 数据质量处理完成，耗时: 1.01秒
INFO     app.data.managers.database_writer:database_writer.py:57 Data quality summary for TEST.SH: 去重报告: 处理了 2 条记录, 发现 2 个重复, 移除了 1 个重复记录, 执行时间: 0.00 秒
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
_________________________ test_store_stock_data_upsert _________________________
------------------------------ Captured log call -------------------------------
INFO     app.data.quality.quality_manager:quality_manager.py:157 开始处理数据质量，数据量: 2
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 开始处理 2 条 A_share 数据
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 2 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 2 条，去重后 1 条
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量处理完成
INFO     app.data.quality.quality_manager:quality_manager.py:238 数据质量处理完成，耗时: 1.01秒
INFO     app.data.managers.database_writer:database_writer.py:57 Data quality summary for TEST.SH: 去重报告: 处理了 2 条记录, 发现 2 个重复, 移除了 1 个重复记录, 执行时间: 0.00 秒
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.data.quality.quality_manager:quality_manager.py:157 开始处理数据质量，数据量: 2
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 开始处理 2 条 A_share 数据
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 2 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 2 条，去重后 1 条
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量处理完成
INFO     app.data.quality.quality_manager:quality_manager.py:238 数据质量处理完成，耗时: 1.01秒
INFO     app.data.managers.database_writer:database_writer.py:57 Data quality summary for TEST.SH: 去重报告: 处理了 2 条记录, 发现 2 个重复, 移除了 1 个重复记录, 执行时间: 0.00 秒
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
_________________________ test_store_corporate_actions _________________________
------------------------------ Captured log call -------------------------------
INFO     app.data.quality.quality_manager:quality_manager.py:157 开始处理数据质量，数据量: 2
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 开始处理 2 条 A_share 数据
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 2 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 2 条，去重后 1 条
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量处理完成
INFO     app.data.quality.quality_manager:quality_manager.py:238 数据质量处理完成，耗时: 1.01秒
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.data.quality.quality_manager:quality_manager.py:157 开始处理数据质量，数据量: 2
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 开始处理 2 条 A_share 数据
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 2 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 2 条，去重后 1 条
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量处理完成
INFO     app.data.quality.quality_manager:quality_manager.py:238 数据质量处理完成，耗时: 1.01秒
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
_________________________ test_store_fundamental_data __________________________
------------------------------ Captured log call -------------------------------
WARNING  app.data.managers.database_writer:database_writer.py:227 Fundamental data quality issues for MSFT: 校验报告: 数据无效, 质量评分: 0.40, 错误: 3 个, 警告: 0 个, 执行时间: 0.000 秒
ERROR    app.data.managers.database_writer:database_writer.py:232 Validation error: 必填字段 'code' 缺失
ERROR    app.data.managers.database_writer:database_writer.py:232 Validation error: 必填字段 'date' 缺失
ERROR    app.data.managers.database_writer:database_writer.py:232 Validation error: 必填字段 'close' 缺失
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.data.managers.database_writer:database_writer.py:265 Successfully upserted fundamental data for MSFT.
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
WARNING  app.data.managers.database_writer:database_writer.py:227 Fundamental data quality issues for MSFT: 校验报告: 数据无效, 质量评分: 0.40, 错误: 3 个, 警告: 0 个, 执行时间: 0.000 秒
ERROR    app.data.managers.database_writer:database_writer.py:232 Validation error: 必填字段 'code' 缺失
ERROR    app.data.managers.database_writer:database_writer.py:232 Validation error: 必填字段 'date' 缺失
ERROR    app.data.managers.database_writer:database_writer.py:232 Validation error: 必填字段 'close' 缺失
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.data.managers.database_writer:database_writer.py:265 Successfully upserted fundamental data for MSFT.
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
__________________________ test_store_annual_earnings __________________________
------------------------------ Captured log call -------------------------------
INFO     app.data.quality.quality_manager:quality_manager.py:157 开始处理数据质量，数据量: 2
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 开始处理 2 条 A_share 数据
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 2 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 2 条，去重后 1 条
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量处理完成
INFO     app.data.quality.quality_manager:quality_manager.py:238 数据质量处理完成，耗时: 1.02秒
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.data.quality.quality_manager:quality_manager.py:157 开始处理数据质量，数据量: 2
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 开始处理 2 条 A_share 数据
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 2 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 2 条，去重后 1 条
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量处理完成
INFO     app.data.quality.quality_manager:quality_manager.py:238 数据质量处理完成，耗时: 1.01秒
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
______________________________ test_fetch_from_db ______________________________
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:132 Querying DB for TEST.SH from 2023-01-01 to 2023-01-02
INFO     app.data.managers.data_manager:data_manager.py:150 Found 2 records in DB for TEST.SH.
____________________ test_fetch_from_db_when_data_is_fresh _____________________
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:132 Querying DB for TEST.SH from 2010-09-29 to 2025-09-25
INFO     app.data.managers.data_manager:data_manager.py:150 Found 2 records in DB for TEST.SH.
INFO     app.data.managers.data_manager:data_manager.py:113 DB data for TEST.SH is up-to-date. Returning from DB.
______________________ test_fetch_from_api_when_db_stale _______________________
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:132 Querying DB for TEST.SH from 2010-09-29 to 2025-09-25
INFO     app.data.managers.data_manager:data_manager.py:150 Found 2 records in DB for TEST.SH.
INFO     app.data.managers.data_manager:data_manager.py:119 DB data for TEST.SH is missing or stale. Fetching from API.
INFO     app.data.managers.data_manager:data_manager.py:173 Storing 2 records for TEST.SH into the database.
INFO     app.data.quality.quality_manager:quality_manager.py:157 开始处理数据质量，数据量: 2
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 开始处理 2 条 A_share 数据
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 2 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 2 条，去重后 1 条
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量处理完成
INFO     app.data.quality.quality_manager:quality_manager.py:238 数据质量处理完成，耗时: 1.01秒
INFO     app.data.managers.database_writer:database_writer.py:57 Data quality summary for TEST.SH: 去重报告: 处理了 2 条记录, 发现 2 个重复, 移除了 1 个重复记录, 执行时间: 0.00 秒
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.data.managers.data_manager:data_manager.py:182 Successfully stored data in DB.
____________________ test_fetch_us_stock_directly_from_api _____________________
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:132 Querying DB for AAPL from 2010-09-29 to 2025-09-25
INFO     app.data.managers.data_manager:data_manager.py:119 DB data for AAPL is missing or stale. Fetching from API.
INFO     app.data.managers.data_manager:data_manager.py:173 Storing 2 records for AAPL into the database.
INFO     app.data.quality.quality_manager:quality_manager.py:157 开始处理数据质量，数据量: 2
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 开始处理 2 条 A_share 数据
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 2 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 2 条，去重后 1 条
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量处理完成
INFO     app.data.quality.quality_manager:quality_manager.py:238 数据质量处理完成，耗时: 1.01秒
INFO     app.data.managers.database_writer:database_writer.py:57 Data quality summary for AAPL: 去重报告: 处理了 2 条记录, 发现 2 个重复, 移除了 1 个重复记录, 执行时间: 0.00 秒
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.logging_service:logging_service.py:551 清理了 0 条过期日志
INFO     app.data.quality.quality_manager:quality_manager.py:467 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.data.managers.data_manager:data_manager.py:182 Successfully stored data in DB.
_____ TestFetchAShareFundamentals.test_fetch_a_share_fundamentals_success ______
------------------------------ Captured log call -------------------------------
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:75 Fetching A-share fundamentals for 000001.SZ
______ TestUpdateMetricsForMarket.test_update_metrics_for_market_success _______
------------------------------ Captured log call -------------------------------
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:95 Starting metrics update for A_share
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:99 Found 3 stocks for A_share
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:112 Using batch fetch for A-share data to avoid frequency limits
ERROR    app.jobs.update_daily_metrics:update_daily_metrics.py:316 Batch fetch failed, falling back to individual fetch: The truth value of a DataFrame is ambiguous. Use a.empty, a.bool(), a.item(), a.any() or a.all().
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:502 Successfully updated 3 stocks for A_share
______ TestUpdateMetricsForMarket.test_update_metrics_for_market_no_data _______
------------------------------ Captured log call -------------------------------
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:95 Starting metrics update for A_share
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:99 Found 3 stocks for A_share
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:112 Using batch fetch for A-share data to avoid frequency limits
ERROR    app.jobs.update_daily_metrics:update_daily_metrics.py:316 Batch fetch failed, falling back to individual fetch: The truth value of a DataFrame is ambiguous. Use a.empty, a.bool(), a.item(), a.any() or a.all().
WARNING  app.jobs.update_daily_metrics:update_daily_metrics.py:331 No data available for 000001.SZ
WARNING  app.jobs.update_daily_metrics:update_daily_metrics.py:339 Too many total failures (1), stopping A-share fallback update
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:502 Successfully updated 0 stocks for A_share
__ TestUpdateMetricsForMarket.test_update_metrics_for_market_update_existing ___
------------------------------ Captured log call -------------------------------
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:95 Starting metrics update for A_share
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:99 Found 3 stocks for A_share
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:112 Using batch fetch for A-share data to avoid frequency limits
ERROR    app.jobs.update_daily_metrics:update_daily_metrics.py:316 Batch fetch failed, falling back to individual fetch: The truth value of a DataFrame is ambiguous. Use a.empty, a.bool(), a.item(), a.any() or a.all().
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:502 Successfully updated 3 stocks for A_share
_ TestUpdateMetricsForMarket.test_update_metrics_for_market_exception_handling _
------------------------------ Captured log call -------------------------------
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:95 Starting metrics update for A_share
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:99 Found 3 stocks for A_share
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:112 Using batch fetch for A-share data to avoid frequency limits
ERROR    app.jobs.update_daily_metrics:update_daily_metrics.py:316 Batch fetch failed, falling back to individual fetch: API Error
ERROR    app.jobs.update_daily_metrics:update_daily_metrics.py:382 Failed to update 000001.SZ: API Error
WARNING  app.jobs.update_daily_metrics:update_daily_metrics.py:391 Too many total failures (1), stopping A-share fallback update
INFO     app.jobs.update_daily_metrics:update_daily_metrics.py:502 Successfully updated 0 stocks for A_share
_______________________ test_websocket_rapid_connections _______________________
------------------------------ Captured log call -------------------------------
INFO     backend.tests.integration.test_websocket_error:test_websocket_error.py:121 测试: 快速连接和断开
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=rapid_test_0, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
WARNING  backend.tests.integration.test_websocket_error:test_websocket_error.py:134 快速连接 0 失败:
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=rapid_test_1, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
WARNING  backend.tests.integration.test_websocket_error:test_websocket_error.py:134 快速连接 1 失败:
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=rapid_test_2, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
WARNING  backend.tests.integration.test_websocket_error:test_websocket_error.py:134 快速连接 2 失败:
_________________ test_websocket_connection_without_client_id __________________
------------------------------ Captured log call -------------------------------
INFO     backend.tests.integration.test_websocket_error:test_websocket_error.py:204 测试: 不带客户端ID的连接
INFO     backend.tests.integration.test_websocket_error:test_websocket_error.py:213 预期的连接失败:
_____________________ test_websocket_connection_lifecycle ______________________
------------------------------ Captured log call -------------------------------
INFO     backend.tests.integration.test_websocket_stress:test_websocket_stress.py:90 测试: 连接生命周期
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=lifecycle_test_0, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
WARNING  backend.tests.integration.test_websocket_stress:test_websocket_stress.py:115 周期 0 失败:
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=lifecycle_test_1, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
WARNING  backend.tests.integration.test_websocket_stress:test_websocket_stress.py:115 周期 1 失败:
INFO     app.api.v1.websocket:websocket.py:88 WebSocket连接请求: client_id=lifecycle_test_2, token=None
ERROR    app.api.v1.websocket:websocket.py:98 WebSocket服务未初始化 - connection_manager为空
WARNING  backend.tests.integration.test_websocket_stress:test_websocket_stress.py:115 周期 2 失败:
_________________ TestStrategyAPI.test_create_strategy_success _________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/analytics/strategies "HTTP/1.1 200 OK"
______________ TestStrategyAPI.test_create_strategy_invalid_data _______________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/analytics/strategies "HTTP/1.1 422 Unprocessable Entity"
___________________ TestStrategyAPI.test_get_all_strategies ____________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/analytics/strategies?user_id=1 "HTTP/1.1 200 OK"
___________________ TestStrategyAPI.test_get_strategy_by_id ____________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/analytics/strategies/1 "HTTP/1.1 200 OK"
_________________ TestStrategyAPI.test_get_strategy_not_found __________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/analytics/strategies/999 "HTTP/1.1 404 Not Found"
_____________________ TestStrategyAPI.test_update_strategy _____________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: PUT http://testserver/api/analytics/strategies/1 "HTTP/1.1 200 OK"
_____________________ TestStrategyAPI.test_delete_strategy _____________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: DELETE http://testserver/api/analytics/strategies/1 "HTTP/1.1 200 OK"
________________ TestBacktestAPI.test_get_all_backtest_results _________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/analytics/backtest/results?user_id=1 "HTTP/1.1 200 OK"
________________ TestBacktestAPI.test_get_backtest_result_by_id ________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/analytics/backtest/results/1 "HTTP/1.1 200 OK"
______________ TestBacktestAPI.test_get_backtest_result_not_found ______________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/analytics/backtest/results/999 "HTTP/1.1 404 Not Found"
_______________ TestBacktestExecution.test_run_backtest_success ________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/analytics/strategies/1/backtest "HTTP/1.1 200 OK"
__________ TestBacktestExecution.test_run_backtest_strategy_not_found __________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/analytics/strategies/999/backtest "HTTP/1.1 404 Not Found"
__________ TestBacktestExecution.test_run_backtest_invalid_parameters __________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/analytics/strategies/1/backtest "HTTP/1.1 422 Unprocessable Entity"
________________________ test_overview_em_with_fallback ________________________
------------------------------ Captured log call -------------------------------
INFO     app.api.v1.a_industries:a_industries.py:35 Fetching industry overview: window=20D, provider=em
INFO     app.data.fetchers.a_industries_fetcher:a_industries_fetcher.py:198 Building industry overview with window=20D, provider=em
INFO     app.data.fetchers.a_industries_fetcher:a_industries_fetcher.py:78 Fetching industry list from Eastmoney (attempt 1/3)
INFO     app.data.fetchers.a_industries_fetcher:a_industries_fetcher.py:142 Fetching Eastmoney hist for industry: '电子元件' until 20250925
INFO     app.data.fetchers.a_industries_fetcher:a_industries_fetcher.py:267 Successfully built overview for 1 industries.
INFO     app.api.v1.a_industries:a_industries.py:39 Industry overview fetched: count=1
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/a-industries/overview?window=20D "HTTP/1.1 200 OK"
__________________________ test_overview_ths_provider __________________________
------------------------------ Captured log call -------------------------------
INFO     app.api.v1.a_industries:a_industries.py:35 Fetching industry overview: window=5D, provider=ths
INFO     app.data.fetchers.a_industries_fetcher:a_industries_fetcher.py:198 Building industry overview with window=5D, provider=ths
INFO     app.data.fetchers.a_industries_fetcher:a_industries_fetcher.py:119 Fetching industry list from THS
INFO     app.data.fetchers.a_industries_fetcher:a_industries_fetcher.py:142 Fetching Eastmoney hist for industry: '汽车整车' until 20250925
INFO     app.data.fetchers.a_industries_fetcher:a_industries_fetcher.py:267 Successfully built overview for 1 industries.
INFO     app.api.v1.a_industries:a_industries.py:39 Industry overview fetched: count=1
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/a-industries/overview?window=5D&provider=ths "HTTP/1.1 200 OK"
________________________ test_run_grid_backtest_success ________________________
------------------------------ Captured log call -------------------------------
INFO     app.api.v1.backtest:backtest.py:30 Received single grid backtest request for AAPL
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 200 OK"
______________________ test_run_grid_backtest_value_error ______________________
------------------------------ Captured log call -------------------------------
INFO     app.api.v1.backtest:backtest.py:30 Received single grid backtest request for INVALID
ERROR    app.api.v1.backtest:backtest.py:34 ValueError during backtest for INVALID: Invalid configuration parameters
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/backtest.py", line 31, in run_grid_backtest_api
    result = backtester.run_grid_backtest(db=db, config=config)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
ValueError: Invalid configuration parameters
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 400 Bad Request"
___________________ test_run_grid_backtest_unexpected_error ____________________
------------------------------ Captured log call -------------------------------
INFO     app.api.v1.backtest:backtest.py:30 Received single grid backtest request for AAPL
ERROR    app.api.v1.backtest:backtest.py:39 An unexpected error occurred during backtest for AAPL: Database connection failed
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/backtest.py", line 31, in run_grid_backtest_api
    result = backtester.run_grid_backtest(db=db, config=config)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
Exception: Database connection failed
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 500 Internal Server Error"
________________ test_run_grid_backtest_missing_required_fields ________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 422 Unprocessable Entity"
__________________ test_run_grid_backtest_invalid_date_format __________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 422 Unprocessable Entity"
______________ test_run_grid_backtest_end_date_before_start_date _______________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 422 Unprocessable Entity"
__________________ test_run_grid_backtest_invalid_date_range ___________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 422 Unprocessable Entity"
___________________ test_run_grid_backtest_large_grid_levels ___________________
------------------------------ Captured log call -------------------------------
INFO     app.api.v1.backtest:backtest.py:30 Received single grid backtest request for AAPL
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/v1/backtest/grid "HTTP/1.1 200 OK"
_______________________ test_get_commodity_data_success ________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/commodities/ag2412 "HTTP/1.1 200 OK"
______________________ test_get_commodity_data_not_found _______________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/commodities/invalid_symbol "HTTP/1.1 404 Not Found"
___________________ test_get_commodity_list_success[asyncio] ___________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/commodities/list "HTTP/1.1 200 OK"
________________ test_get_commodity_list_akshare_fails[asyncio] ________________
------------------------------ Captured log call -------------------------------
ERROR    app.api.v1.commodities:commodities.py:33 Failed to create commodity list: Akshare down
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/commodities.py", line 26, in get_commodity_list
    df = await run_in_threadpool(ak.futures_display_main_sina)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 2234, in _execute_mock_call
    raise effect
Exception: Akshare down
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/commodities/list "HTTP/1.1 200 OK"
____________________ test_get_commodity_list_success[trio] _____________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/commodities/list "HTTP/1.1 200 OK"
_________________ test_get_commodity_list_akshare_fails[trio] __________________
------------------------------ Captured log call -------------------------------
ERROR    app.api.v1.commodities:commodities.py:33 Failed to create commodity list: Akshare down
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/commodities.py", line 26, in get_commodity_list
    df = await run_in_threadpool(ak.futures_display_main_sina)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 2234, in _execute_mock_call
    raise effect
Exception: Akshare down
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/commodities/list "HTTP/1.1 200 OK"
________________________ test_read_top_cryptos_success _________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/crypto/top "HTTP/1.1 200 OK"
_______________________ test_read_top_cryptos_not_found ________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/crypto/top "HTTP/1.1 404 Not Found"
_______________________ test_read_crypto_history_success _______________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/crypto/BTC/history "HTTP/1.1 200 OK"
______________________ test_read_crypto_history_not_found ______________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/crypto/NONEXISTENT/history "HTTP/1.1 404 Not Found"
________________________ test_get_futures_data_success _________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/futures/rb2410 "HTTP/1.1 200 OK"
_______________________ test_get_futures_data_not_found ________________________
------------------------------ Captured log call -------------------------------
ERROR    app.api.v1.futures:futures.py:109 Failed to fetch futures data for invalid_symbol. Attempted: INVALID_SYMBOL=F, INVALID_SYMBOL, INVALID_SYMBOL.SHF, INVALID_SYMBOL.INE, INVALID_SYMBOL.DCE, INVALID_SYMBOL.ZCE, INVALID_SYMBOL.CFX
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/futures/invalid_symbol "HTTP/1.1 404 Not Found"
________________________ test_get_futures_list_success _________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/futures/list "HTTP/1.1 200 OK"
_____________________ test_get_futures_list_akshare_fails ______________________
------------------------------ Captured log call -------------------------------
ERROR    app.api.v1.futures:futures.py:27 Failed to fetch futures list from Akshare: Akshare down
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/futures.py", line 24, in get_futures_list
    futures_df = await run_in_threadpool(ak.futures_display_main_sina)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 2234, in _execute_mock_call
    raise effect
Exception: Akshare down
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/futures/list "HTTP/1.1 200 OK"
_____________________ test_get_option_expirations_success ______________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/options/expirations/SPY "HTTP/1.1 200 OK"
____________________ test_get_option_expirations_not_found _____________________
------------------------------ Captured log call -------------------------------
ERROR    app.api.v1.options:options.py:25 Failed to fetch expiration dates for INVALID: Not found
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/options.py", line 20, in get_option_expirations
    expirations = await run_in_threadpool(
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 2234, in _execute_mock_call
    raise effect
Exception: Not found
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/options/expirations/INVALID "HTTP/1.1 404 Not Found"
________________________ test_get_option_chain_success _________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/options/chain/SPY?expiration_date=2025-12-19 "HTTP/1.1 200 OK"
________________________ test_get_option_chain_failure _________________________
------------------------------ Captured log call -------------------------------
ERROR    app.api.v1.options:options.py:48 Failed to fetch option chain for SPY on 2025-12-19: Fetch failed
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/api/v1/options.py", line 41, in get_option_chain_for_date
    chain = await run_in_threadpool(
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 2234, in _execute_mock_call
    raise effect
Exception: Fetch failed
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/options/chain/SPY?expiration_date=2025-12-19 "HTTP/1.1 500 Internal Server Error"
________________________ test_get_options_data_success _________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/options/SPY251219C00600000 "HTTP/1.1 200 OK"
_________________________ test_get_options_data_empty __________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/v1/options/UNKNOWN_CONTRACT "HTTP/1.1 200 OK"
___________ TestBaostockSession.test_baostock_session_login_failure ____________
------------------------------ Captured log call -------------------------------
ERROR    app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:33 Baostock login failed: Login failed
______ TestBaostockQueryWithRetry.test_baostock_query_network_error_retry ______
------------------------------ Captured log call -------------------------------
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:215 Baostock network error (attempt 1/2). Retrying in 1s...
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:215 Baostock network error (attempt 2/2). Retrying in 1s...
ERROR    app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:225 Failed to execute Baostock query after 2 retries.
____ TestBaostockQueryWithRetry.test_baostock_query_data_mismatch_handling _____
------------------------------ Captured log call -------------------------------
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:190 Baostock data/field mismatch for mock_query_func: columns passed. Attempting to build DataFrame manually.
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:196 Using first 2 fields out of 3 available: ['year', 'netProfit']
________ TestBaostockQueryWithRetry.test_baostock_query_circuit_breaker ________
------------------------------ Captured log call -------------------------------
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:215 Baostock network error (attempt 1/2). Retrying in 1s...
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:215 Baostock network error (attempt 2/2). Retrying in 1s...
ERROR    app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:225 Failed to execute Baostock query after 2 retries.
________ TestFetchAnnualNetProfit.test_fetch_annual_net_profit_no_data _________
------------------------------ Captured log call -------------------------------
ERROR    app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:241 Circuit breaker for 000001.SH: Too many consecutive quarterly failures. Aborting year loop.
__ TestFetchAnnualNetProfit.test_fetch_annual_net_profit_invalid_profit_value __
------------------------------ Captured log call -------------------------------
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:266 Could not parse netProfit 'invalid' for 000001.sh 2024Q1
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:266 Could not parse netProfit 'invalid' for 000001.sh 2024Q2
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:266 Could not parse netProfit 'invalid' for 000001.sh 2024Q3
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:266 Could not parse netProfit 'invalid' for 000001.sh 2024Q4
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:266 Could not parse netProfit 'invalid' for 000001.sh 2025Q1
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:266 Could not parse netProfit 'invalid' for 000001.sh 2025Q2
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:266 Could not parse netProfit 'invalid' for 000001.sh 2025Q3
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:266 Could not parse netProfit 'invalid' for 000001.sh 2025Q4
________ TestUpdateStockListFromAkshare.test_update_stock_list_success _________
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:341 Successfully fetched and processed 2 ETFs.
INFO     app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:373 Successfully upserted 289 stocks and ETFs into the database.
_____ TestUpdateStockListFromAkshare.test_update_stock_list_market_failure _____
------------------------------ Captured log call -------------------------------
ERROR    app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:316 Failed to fetch stock list for market sh from Akshare: SH market error
INFO     app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:341 Successfully fetched and processed 1 ETFs.
INFO     app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:373 Successfully upserted 285 stocks and ETFs into the database.
____ TestUpdateStockListFromAkshare.test_update_stock_list_column_fallback _____
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:341 Successfully fetched and processed 1 ETFs.
INFO     app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:373 Successfully upserted 286 stocks and ETFs into the database.
__ TestUpdateStockListFromAkshare.test_update_stock_list_etf_suffix_detection __
------------------------------ Captured log call -------------------------------
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:304 Could not find a valid code column for sh. Skipping.
WARNING  app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:304 Could not find a valid code column for sz. Skipping.
INFO     app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:341 Successfully fetched and processed 3 ETFs.
INFO     app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:373 Successfully upserted 286 stocks and ETFs into the database.
____ TestUpdateStockListFromAkshare.test_update_stock_list_all_markets_fail ____
------------------------------ Captured log call -------------------------------
ERROR    app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:316 Failed to fetch stock list for market sh from Akshare: SH market error
ERROR    app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:316 Failed to fetch stock list for market sz from Akshare: SZ market error
ERROR    app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:343 Failed to fetch ETF list from Akshare: ETF market error
INFO     app.data.fetchers.stock_fetchers.a_share_fetcher:a_share_fetcher.py:373 Successfully upserted 283 stocks and ETFs into the database.
____________ TestFetchFromYfinance.test_fetch_from_yfinance_success ____________
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:40 Fetching yfinance data for ticker: AAPL, interval: 1d, start: 2023-01-01, end: 2023-01-05
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:68 Successfully fetched 5 rows from yfinance for AAPL. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume', 'Adj Close']
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:164 Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
________ TestFetchFromYfinance.test_fetch_from_yfinance_empty_response _________
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:40 Fetching yfinance data for ticker: UNKNOWN, interval: 1d, start: 2023-01-01, end: 2023-01-05
WARNING  app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:65 yfinance returned empty or None DataFrame for UNKNOWN
______ TestFetchFromYfinance.test_fetch_from_yfinance_multiindex_columns _______
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:40 Fetching yfinance data for ticker: AAPL, interval: 1d, start: 2023-01-01, end: 2023-01-03
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:68 Successfully fetched 3 rows from yfinance for AAPL. Original Columns: [('Date', ''), ('Open', ''), ('High', ''), ('Low', ''), ('Close', ''), ('Volume', ''), ('Adj Close', '')]
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:164 Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
________ TestFetchFromYfinance.test_fetch_from_yfinance_weekly_interval ________
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:40 Fetching yfinance data for ticker: AAPL, interval: weekly, start: 2023-01-01, end: 2023-01-21
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:68 Successfully fetched 3 rows from yfinance for AAPL. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume', 'Adj Close']
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:164 Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
_______ TestFetchFromYfinance.test_fetch_from_yfinance_monthly_interval ________
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:40 Fetching yfinance data for ticker: AAPL, interval: monthly, start: 2023-01-01, end: 2023-03-31
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:68 Successfully fetched 3 rows from yfinance for AAPL. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume', 'Adj Close']
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:164 Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
_______ TestFetchFromYfinance.test_fetch_from_yfinance_invalid_interval ________
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:40 Fetching yfinance data for ticker: AAPL, interval: invalid, start: 2023-01-01, end: 2023-01-03
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:68 Successfully fetched 3 rows from yfinance for AAPL. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume', 'Adj Close']
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:164 Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
_______ TestFetchFromYfinance.test_fetch_from_yfinance_missing_adj_close _______
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:40 Fetching yfinance data for ticker: AAPL, interval: 1d, start: 2023-01-01, end: 2023-01-03
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:68 Successfully fetched 3 rows from yfinance for AAPL. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume']
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:164 Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
______ TestFetchFromYfinance.test_fetch_from_yfinance_nan_dates_handling _______
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:40 Fetching yfinance data for ticker: AAPL, interval: 1d, start: 2023-01-01, end: 2023-01-03
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:68 Successfully fetched 3 rows from yfinance for AAPL. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume', 'Adj Close']
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:164 Final DataFrame columns for AAPL: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
_______ TestFetchFromYfinance.test_fetch_from_yfinance_symbol_conversion _______
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:40 Fetching yfinance data for ticker: AAPL.SS, interval: 1d, start: 2023-01-01, end: 2023-01-03
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:68 Successfully fetched 3 rows from yfinance for AAPL.SS. Original Columns: ['Date', 'Open', 'High', 'Low', 'Close', 'Volume', 'Adj Close']
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:164 Final DataFrame columns for AAPL.SS: ['trade_date', 'open', 'high', 'low', 'close', 'pre_close', 'change', 'pct_chg', 'vol', 'amount']
___________ TestUpdateUsStockList.test_update_us_stock_list_success ____________
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:436 Fetching S&P 500 tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:438 Fetched 3 S&P 500 tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching NASDAQ tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 4 NASDAQ tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching Dow Jones tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 4 Dow Jones tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching other US (NYSE/AMEX/etc.) tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 2 other US (NYSE/AMEX/etc.) tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:478 Total unique symbols fetched from yahoo_fin: 7
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:496 Total qualified symbols after filtering: 7
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:532 Successfully upserted 7 US stock entries into DB.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:635 Starting to update US stock names from yfinance...
ERROR    app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:682 Error updating US stock names from yfinance: object of type 'Mock' has no len()
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/data/fetchers/stock_fetchers/us_stock_fetcher.py", line 648, in update_stock_names_from_yfinance
    logger.info(f"Found {len(us_stocks)} US stocks to update names")
TypeError: object of type 'Mock' has no len()
________ TestUpdateUsStockList.test_update_us_stock_list_sp500_failure _________
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:436 Fetching S&P 500 tickers...
ERROR    app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:440 Error fetching S&P 500 tickers: S&P 500 error
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/data/fetchers/stock_fetchers/us_stock_fetcher.py", line 437, in update_us_stock_list
    sp500_tickers = si.tickers_sp500()
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
Exception: S&P 500 error
_________ TestUpdateUsStockList.test_update_us_stock_list_all_failures _________
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:436 Fetching S&P 500 tickers...
ERROR    app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:440 Error fetching S&P 500 tickers: S&P 500 error
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/data/fetchers/stock_fetchers/us_stock_fetcher.py", line 437, in update_us_stock_list
    sp500_tickers = si.tickers_sp500()
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1114, in __call__
    return self._mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1118, in _mock_call
    return self._execute_mock_call(*args, **kwargs)
  File "/usr/local/Cellar/python@3.10/3.10.13_2/Frameworks/Python.framework/Versions/3.10/lib/python3.10/unittest/mock.py", line 1173, in _execute_mock_call
    raise effect
Exception: S&P 500 error
_________ TestUpdateUsStockList.test_update_us_stock_list_empty_lists __________
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:436 Fetching S&P 500 tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:438 Fetched 0 S&P 500 tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching S&P 500 (Alpha Vantage fallback) tickers...
WARNING  app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:182 Alpha Vantage API key not configured, falling back to yfinance
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 0 S&P 500 (Alpha Vantage fallback) tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching NASDAQ tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 0 NASDAQ tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching Dow Jones tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 0 Dow Jones tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching other US (NYSE/AMEX/etc.) tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 0 other US (NYSE/AMEX/etc.) tickers.
WARNING  app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:472 No stocks fetched from yahoo_fin, using yfinance fallback
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching yfinance fallback tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:261 Using comprehensive US stock list as yfinance fallback
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:405 yfinance fallback fetched 129 US stock tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 129 yfinance fallback tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:478 Total unique symbols fetched from yahoo_fin: 129
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:496 Total qualified symbols after filtering: 129
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:532 Successfully upserted 129 US stock entries into DB.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:635 Starting to update US stock names from yfinance...
ERROR    app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:682 Error updating US stock names from yfinance: object of type 'Mock' has no len()
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/data/fetchers/stock_fetchers/us_stock_fetcher.py", line 648, in update_stock_names_from_yfinance
    logger.info(f"Found {len(us_stocks)} US stocks to update names")
TypeError: object of type 'Mock' has no len()
______ TestUpdateUsStockList.test_update_us_stock_list_duplicate_symbols _______
------------------------------ Captured log call -------------------------------
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:436 Fetching S&P 500 tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:438 Fetched 3 S&P 500 tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching NASDAQ tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 4 NASDAQ tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching Dow Jones tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 4 Dow Jones tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:426 Fetching other US (NYSE/AMEX/etc.) tickers...
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:428 Fetched 3 other US (NYSE/AMEX/etc.) tickers.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:478 Total unique symbols fetched from yahoo_fin: 7
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:496 Total qualified symbols after filtering: 7
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:532 Successfully upserted 7 US stock entries into DB.
INFO     app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:635 Starting to update US stock names from yfinance...
ERROR    app.data.fetchers.stock_fetchers.us_stock_fetcher:us_stock_fetcher.py:682 Error updating US stock names from yfinance: object of type 'Mock' has no len()
Traceback (most recent call last):
  File "/Users/apple/code/ChronoRetrace/backend/app/data/fetchers/stock_fetchers/us_stock_fetcher.py", line 648, in update_stock_names_from_yfinance
    logger.info(f"Found {len(us_stocks)} US stocks to update names")
TypeError: object of type 'Mock' has no len()
______ TestGetAllStocksList.test_get_all_stocks_list_a_share_empty_cache _______
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:38 Stock list for A_share is empty. Attempting to refresh.
______ TestGetAllStocksList.test_get_all_stocks_list_us_stock_empty_cache ______
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:38 Stock list for US_stock is empty. Attempting to refresh.
_________ TestGetAllStocksList.test_get_all_stocks_list_unknown_market _________
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:38 Stock list for unknown_market is empty. Attempting to refresh.
_________ TestGetAllStocksList.test_get_all_stocks_list_update_failure _________
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:38 Stock list for A_share is empty. Attempting to refresh.
ERROR    app.data.managers.data_manager:data_manager.py:46 Failed to update stock list for A_share: Update failed
____ TestForceUpdateStockList.test_force_update_stock_list_a_share_success _____
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:55 Force updating stock list for A_share from source.
INFO     app.data.managers.data_manager:data_manager.py:61 Successfully forced update for A_share.
____ TestForceUpdateStockList.test_force_update_stock_list_us_stock_success ____
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:55 Force updating stock list for US_stock from source.
INFO     app.data.managers.data_manager:data_manager.py:61 Successfully forced update for US_stock.
_____ TestForceUpdateStockList.test_force_update_stock_list_unknown_market _____
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:55 Force updating stock list for unknown_market from source.
INFO     app.data.managers.data_manager:data_manager.py:61 Successfully forced update for unknown_market.
____ TestForceUpdateStockList.test_force_update_stock_list_a_share_failure _____
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:55 Force updating stock list for A_share from source.
ERROR    app.data.managers.data_manager:data_manager.py:63 Failed to force update stock list for A_share: Update failed
____ TestForceUpdateStockList.test_force_update_stock_list_us_stock_failure ____
------------------------------ Captured log call -------------------------------
INFO     app.data.managers.data_manager:data_manager.py:55 Force updating stock list for US_stock from source.
ERROR    app.data.managers.data_manager:data_manager.py:63 Failed to force update stock list for US_stock: Update failed
___________ TestDataDeduplicationService.test_batch_deduplicate_data ___________
------------------------------ Captured log call -------------------------------
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 4 条，去重后 2 条
_________ TestDataQualityIntegration.test_async_processing_integration _________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
________ TestDataQualityIntegration.test_complete_data_quality_workflow ________
------------------------------ Captured log call -------------------------------
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 28 条，去重后 22 条
INFO     app.infrastructure.logging_service:logging_service.py:579 [validation] 处理了 28 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
______ TestDataQualityIntegration.test_concurrent_processing_integration _______
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
_______ TestDataQualityIntegration.test_data_quality_metrics_collection ________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.logging_service:logging_service.py:579 [quality_check] 数据质量检查完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
___________ TestDataQualityIntegration.test_end_to_end_data_pipeline ___________
------------------------------ Captured log call -------------------------------
INFO     app.data.quality.deduplication_service:deduplication_service.py:466 批量去重完成: 原始数据 28 条，去重后 22 条
INFO     app.infrastructure.logging_service:logging_service.py:579 [pipeline] 数据质量管道执行完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
__________ TestDataQualityIntegration.test_error_handling_integration __________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
________ TestDataQualityIntegration.test_error_recovery_and_resilience _________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
_____ TestDataQualityIntegration.test_memory_management_during_processing ______
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
_____ TestDataQualityIntegration.test_performance_optimization_integration _____
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 28 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
____________________ TestCacheService.test_clear_by_pattern ____________________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.cache.cache_service:cache_service.py:427 Cleared cache pattern: stock:*, deleted: 2
__________________ TestCacheService.test_health_check_success __________________
------------------------------ Captured log call -------------------------------
ERROR    app.infrastructure.cache.cache_service:cache_service.py:370 Failed to set cache for key health_check_test: object bool can't be used in 'await' expression
__________________ TestCacheService.test_health_check_failure __________________
------------------------------ Captured log call -------------------------------
ERROR    app.infrastructure.cache.cache_service:cache_service.py:370 Failed to set cache for key health_check_test: object bool can't be used in 'await' expression
___________________ TestCacheWarmingService.test_warm_cache ____________________
------------------------------ Captured log call -------------------------------
ERROR    app.infrastructure.cache.cache_warming:cache_warming.py:879 预热股票信息失败: object bool can't be used in 'await' expression
ERROR    app.infrastructure.cache.cache_warming:cache_warming.py:879 预热股票信息失败: object bool can't be used in 'await' expression
ERROR    app.infrastructure.cache.cache_warming:cache_warming.py:879 预热股票信息失败: object bool can't be used in 'await' expression
ERROR    app.infrastructure.cache.cache_warming:cache_warming.py:879 预热股票信息失败: object bool can't be used in 'await' expression
ERROR    app.infrastructure.cache.cache_warming:cache_warming.py:879 预热股票信息失败: object bool can't be used in 'await' expression
ERROR    app.infrastructure.cache.cache_warming:cache_warming.py:879 预热股票信息失败: object bool can't be used in 'await' expression
ERROR    app.infrastructure.cache.cache_warming:cache_warming.py:879 预热股票信息失败: object bool can't be used in 'await' expression
ERROR    app.infrastructure.cache.cache_warming:cache_warming.py:879 预热股票信息失败: object bool can't be used in 'await' expression
ERROR    app.infrastructure.cache.cache_warming:cache_warming.py:879 预热股票信息失败: object bool can't be used in 'await' expression
ERROR    app.infrastructure.cache.cache_warming:cache_warming.py:879 预热股票信息失败: object bool can't be used in 'await' expression
____________ TestCacheWarmingService.test_incremental_update_stocks ____________
------------------------------ Captured log call -------------------------------
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:631 Successfully cached stock info for 000001.SZ
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:681 Successfully cached daily data for 000001.SZ
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:631 Successfully cached stock info for 000002.SZ
DEBUG    app.infrastructure.cache.cache_warming:cache_warming.py:681 Successfully cached daily data for 000002.SZ
______________ TestPerformanceMonitor.test_monitor_initialization ______________
------------------------------ Captured log setup ------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:144 性能监控已启动
______________ TestPerformanceMonitor.test_collect_system_metrics ______________
------------------------------ Captured log setup ------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:144 性能监控已启动
______________ TestPerformanceMonitor.test_record_cache_hit_miss _______________
------------------------------ Captured log setup ------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:144 性能监控已启动
________________ TestPerformanceMonitor.test_record_api_metric _________________
------------------------------ Captured log setup ------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:144 性能监控已启动
________________ TestPerformanceMonitor.test_metrics_collection ________________
------------------------------ Captured log setup ------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:144 性能监控已启动
________________ TestPerformanceMonitor.test_get_cache_summary _________________
------------------------------ Captured log setup ------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:144 性能监控已启动
________________ TestPerformanceMonitor.test_clear_old_metrics _________________
------------------------------ Captured log setup ------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:144 性能监控已启动
_________________ TestPerformanceMonitor.test_start_monitoring _________________
------------------------------ Captured log setup ------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:144 性能监控已启动
_________________ TestPerformanceMonitor.test_stop_monitoring __________________
------------------------------ Captured log setup ------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:144 性能监控已启动
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:153 性能监控已停止
__________________ TestPerformanceMonitor.test_export_metrics __________________
------------------------------ Captured log setup ------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:144 性能监控已启动
____ TestPerformanceMonitorIntegration.test_monitor_integration_with_cache _____
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:144 性能监控已启动
_______ TestPerformanceMonitorIntegration.test_metrics_retention_policy ________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.monitoring.performance_monitor:performance_monitor.py:144 性能监控已启动
____________________ TestMemoryManager.test_memory_monitor _____________________
------------------------------ Captured log call -------------------------------
WARNING  app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:113 内存使用率过高: 40.6%
______ TestPerformanceMonitorDecorator.test_performance_monitor_exception ______
------------------------------ Captured log call -------------------------------
ERROR    backend.tests.unit.app.infrastructure.performance.test_performance_optimization_service:performance_optimization_service.py:197 函数 test_function_with_error 执行失败: 测试异常
_______ TestPerformanceMonitorDecorator.test_performance_monitor_success _______
------------------------------ Captured log call -------------------------------
INFO     backend.tests.unit.app.infrastructure.performance.test_performance_optimization_service:performance_optimization_service.py:187 函数 test_function 执行完成: 耗时 0.10s, 内存变化 -0.09MB
__________ TestPerformanceOptimizationService.test_async_process_data __________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
________ TestPerformanceOptimizationService.test_batch_deduplicate_data ________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_deduplicate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
____________ TestPerformanceOptimizationService.test_batch_validate ____________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 10 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 2, 处理 5 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
_____ TestPerformanceOptimizationService.test_cache_management_integration _____
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
__________ TestPerformanceOptimizationService.test_cleanup_resources ___________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
_____ TestPerformanceOptimizationService.test_concurrent_processing_safety _____
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 5 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.02MB
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 5 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 -0.01MB
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 5 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 -0.02MB
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
_____ TestPerformanceOptimizationService.test_error_handling_in_processing _____
------------------------------ Captured log call -------------------------------
ERROR    app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:302 批量校验失败: 模拟错误
ERROR    app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:302 批量校验失败: 模拟错误
ERROR    app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:302 批量校验失败: 模拟错误
ERROR    app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:302 批量校验失败: 模拟错误
ERROR    app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:302 批量校验失败: 模拟错误
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 5 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
________ TestPerformanceOptimizationService.test_get_performance_report ________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
____ TestPerformanceOptimizationService.test_memory_management_integration _____
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
_____ TestPerformanceOptimizationService.test_optimization_recommendations _____
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
__________ TestPerformanceOptimizationService.test_parallel_validate ___________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.31MB
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
___ TestPerformanceOptimizationService.test_performance_metrics_calculation ____
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
___ TestPerformanceOptimizationService.test_performance_with_different_modes ___
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:308 完成批次 1, 处理 10 条记录
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.05MB
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
_________ TestPerformanceOptimizationService.test_sequential_validate __________
------------------------------ Captured log call -------------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:187 函数 batch_validate_data 执行完成: 耗时 0.00s, 内存变化 +0.00MB
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
---------------------------- Captured log teardown -----------------------------
INFO     app.infrastructure.performance.performance_optimization_service:performance_optimization_service.py:643 资源清理完成
________________________________ test_read_main ________________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/ "HTTP/1.1 200 OK"
______________________________ test_health_check _______________________________
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
__________________ TestConnectionManager.test_connect_client ___________________
------------------------------ Captured log call -------------------------------
INFO     app.websocket.connection_manager:connection_manager.py:74 客户端 test_client_001 连接成功，用户ID: None
_________________ TestConnectionManager.test_disconnect_client _________________
------------------------------ Captured log call -------------------------------
INFO     app.websocket.connection_manager:connection_manager.py:74 客户端 test_client_001 连接成功，用户ID: None
INFO     app.websocket.connection_manager:connection_manager.py:116 客户端 test_client_001 连接已断开
__________________ TestConnectionManager.test_send_to_client ___________________
------------------------------ Captured log call -------------------------------
INFO     app.websocket.connection_manager:connection_manager.py:74 客户端 test_client_001 连接成功，用户ID: None
________________ TestConnectionManager.test_subscribe_to_topic _________________
------------------------------ Captured log call -------------------------------
INFO     app.websocket.connection_manager:connection_manager.py:74 客户端 test_client_001 连接成功，用户ID: None
INFO     app.websocket.connection_manager:connection_manager.py:152 客户端 test_client_001 订阅主题 stock.AAPL.1m
______________ TestConnectionManager.test_unsubscribe_from_topic _______________
------------------------------ Captured log call -------------------------------
INFO     app.websocket.connection_manager:connection_manager.py:74 客户端 test_client_001 连接成功，用户ID: None
INFO     app.websocket.connection_manager:connection_manager.py:152 客户端 test_client_001 订阅主题 stock.AAPL.1m
INFO     app.websocket.connection_manager:connection_manager.py:192 客户端 test_client_001 取消订阅主题 stock.AAPL.1m
________________ TestConnectionManager.test_broadcast_to_topic _________________
------------------------------ Captured log call -------------------------------
INFO     app.websocket.connection_manager:connection_manager.py:74 客户端 subscriber_0 连接成功，用户ID: None
INFO     app.websocket.connection_manager:connection_manager.py:152 客户端 subscriber_0 订阅主题 stock.AAPL.1m
INFO     app.websocket.connection_manager:connection_manager.py:74 客户端 subscriber_1 连接成功，用户ID: None
INFO     app.websocket.connection_manager:connection_manager.py:152 客户端 subscriber_1 订阅主题 stock.AAPL.1m
____________ TestConnectionManager.test_multiple_clients_same_topic ____________
------------------------------ Captured log call -------------------------------
INFO     app.websocket.connection_manager:connection_manager.py:74 客户端 client_0 连接成功，用户ID: None
INFO     app.websocket.connection_manager:connection_manager.py:152 客户端 client_0 订阅主题 stock.AAPL.1m
INFO     app.websocket.connection_manager:connection_manager.py:74 客户端 client_1 连接成功，用户ID: None
INFO     app.websocket.connection_manager:connection_manager.py:152 客户端 client_1 订阅主题 stock.AAPL.1m
INFO     app.websocket.connection_manager:connection_manager.py:74 客户端 client_2 连接成功，用户ID: None
INFO     app.websocket.connection_manager:connection_manager.py:152 客户端 client_2 订阅主题 stock.AAPL.1m
______ TestConnectionManager.test_client_disconnect_removes_subscriptions ______
------------------------------ Captured log call -------------------------------
INFO     app.websocket.connection_manager:connection_manager.py:74 客户端 test_client_001 连接成功，用户ID: None
INFO     app.websocket.connection_manager:connection_manager.py:152 客户端 test_client_001 订阅主题 stock.AAPL.1m
INFO     app.websocket.connection_manager:connection_manager.py:152 客户端 test_client_001 订阅主题 stock.GOOGL.1m
INFO     app.websocket.connection_manager:connection_manager.py:152 客户端 test_client_001 订阅主题 crypto.BTC.1m
INFO     app.websocket.connection_manager:connection_manager.py:116 客户端 test_client_001 连接已断开
---------------------------- Captured log teardown -----------------------------
INFO     app.main:main.py:202 测试环境下应用关闭。
================================ tests coverage ================================
______________ coverage: platform darwin, python 3.10.13-final-0 _______________

Name                                                                         Stmts   Miss  Cover   Missing
----------------------------------------------------------------------------------------------------------
backend/app/analytics/api/endpoints.py                                         171     39    77%   28, 70, 74-82, 115, 121-123, 128-130, 155-158, 163-166, 186-207, 225-226, 274, 278, 293
backend/app/analytics/backtest/backtester.py                                   149     32    79%   115, 197-205, 230, 277, 293-381, 394-395
backend/app/analytics/backtest/signal_generator.py                             163     85    48%   40-52, 83-84, 93-121, 128-172, 194, 208-209, 215-243, 251, 255, 257, 281-289, 296-304, 309-324
backend/app/analytics/models.py                                                 33      0   100%
backend/app/analytics/schemas/strategy_response.py                              39      0   100%
backend/app/analytics/schemas/strategy_schema.py                                50      1    98%   85
backend/app/analytics/schemas/technical_analysis.py                             14      0   100%
backend/app/analytics/screener/screener_service.py                              88     36    59%   33, 77, 86-92, 100-114, 123-139, 147, 159, 165, 168-173, 183-188
backend/app/analytics/services/strategy_service.py                              64     30    53%   43, 53-63, 67-73, 124-127, 133, 143-146, 152-155, 159-162
backend/app/analytics/services/technical_analysis_service.py                    42     35    17%   13-55
backend/app/api/v1/a_industries.py                                              41     20    51%   18-22, 41-43, 55-77
backend/app/api/v1/admin.py                                                    164    120    27%   40-46, 88-188, 204-241, 253-257, 269-291, 302-322, 332-343, 355-376, 388-417, 428-463
backend/app/api/v1/asset_backtest.py                                            59     41    31%   44-64, 89-109, 126-143, 157-172
backend/app/api/v1/asset_config.py                                             149    113    24%   40-53, 59-62, 69-81, 89-99, 105-111, 128-147, 153-156, 162-166, 174-184, 199-216, 222-226, 240-255, 263-267, 282-299, 307-311
backend/app/api/v1/asset_screener.py                                            45     30    33%   43-65, 82-99, 113-128
backend/app/api/v1/auth.py                                                     138    107    22%   46-101, 112-152, 167-197, 215-220, 226, 238-255, 264-279, 292-312, 320-327, 338-358
backend/app/api/v1/backtest.py                                                  36     13    64%   26, 55-75
backend/app/api/v1/cache.py                                                     87     50    43%   68-109, 120-136, 150-180, 198-226, 239-257
backend/app/api/v1/cached_stocks.py                                            135     97    28%   39-43, 55-60, 80-89, 100-124, 136-169, 180-197, 208-225, 235-240, 251-260, 273-283, 292-306, 326-327
backend/app/api/v1/commodities.py                                               40      4    90%   31, 89-91
backend/app/api/v1/crypto.py                                                    16      0   100%
backend/app/api/v1/data_quality.py                                              70     46    34%   27-59, 74-108, 126-172, 181-212, 225-249
backend/app/api/v1/futures.py                                                   60      8    87%   83, 96-101, 107
backend/app/api/v1/health.py                                                   106     79    25%   32-46, 50-68, 72-80, 84-99, 103-133, 137-172, 202-216, 236-261
backend/app/api/v1/monitoring.py                                               155     99    36%   85-87, 98-151, 167-221, 232-280, 298-324, 340-356, 372-407, 425-455
backend/app/api/v1/options.py                                                   56      8    86%   69, 71, 73, 75, 77, 97-99
backend/app/api/v1/screener.py                                                  18     10    44%   22-34
backend/app/api/v1/stocks.py                                                    98     64    35%   35-46, 59-76, 83, 103-136, 149-154, 167-186, 197-213, 224-243
backend/app/api/v1/users.py                                                     13      2    85%   17, 29
backend/app/api/v1/watchlist.py                                                194    121    38%   102-135, 145-205, 214-257, 276-311, 331-382, 401-432, 444-505, 524-554, 572-600, 611-646
backend/app/api/v1/websocket.py                                                197    153    22%   50-53, 66-73, 101-102, 106-234, 245-257, 277-285, 307-328, 343-364, 381-397, 411-431, 447-449, 454-458, 467-484
backend/app/core/config.py                                                      83      4    95%   117-119, 124
backend/app/core/middleware.py                                                 194     88    55%   36-37, 41, 62, 67, 80, 87-101, 143-146, 152-176, 181-189, 193-215, 245, 257-258, 281-282, 301, 331-333, 347-357, 363-371, 375-387, 391-397, 421
backend/app/core/security.py                                                   128     98    23%   27-50, 58-78, 83-87, 93-113, 120, 127, 140-158, 167-170, 184-206, 211-237, 245-261, 270-278
backend/app/data/fetchers/a_industries_fetcher.py                              190     93    51%   22, 31, 57-60, 63, 65, 86-89, 94-113, 125-128, 133-135, 153-159, 167-172, 177, 182, 205-206, 215-216, 224, 228-231, 236-237, 273-302, 307-379
backend/app/data/fetchers/commodity_fetcher.py                                  54     46    15%   19-127
backend/app/data/fetchers/crypto_fetcher.py                                     56      0   100%
backend/app/data/fetchers/futures_fetcher.py                                   157    140    11%   24-128, 144-167, 173-191, 204-340
backend/app/data/fetchers/options_fetcher.py                                    84     74    12%   17-28, 35-88, 97-204
backend/app/data/fetchers/stock_fetchers/a_share_fetcher.py                    253    121    52%   51-161, 178-181, 200-211, 220-223, 299, 335, 379-383, 391-426, 436-537
backend/app/data/fetchers/stock_fetchers/us_stock_fetcher.py                   259    108    58%   86-89, 156, 162, 187-244, 408-413, 430-432, 445, 447-450, 482-485, 492, 539-543, 548-578, 583-606, 611-624, 645-646, 659-660, 671-673
backend/app/data/managers/data_manager.py                                      167     71    57%   169, 185-186, 204-212, 219-246, 251-285, 290-315, 331, 345, 354, 366-395
backend/app/data/managers/data_utils.py                                         12      0   100%
backend/app/data/managers/database_admin.py                                     18      4    78%   35-38
backend/app/data/managers/database_writer.py                                   145     43    70%   23, 45-51, 61-65, 73, 78, 83, 119, 144-149, 155-159, 173, 182-183, 198-201, 236-240, 257-258, 267-272, 281, 302-307, 313-317, 341-342
backend/app/data/quality/deduplication_service.py                              330    101    69%   120-140, 167, 179, 193, 269-274, 337-338, 413, 429, 448-449, 508-521, 540-543, 551-561, 567-595, 630, 637, 639, 644-645, 650, 665, 673-680, 687-696, 702-714, 721, 723, 728, 734-748, 764-782
backend/app/data/quality/quality_manager.py                                    190     43    77%   242-307, 319, 339-341, 361, 383-385, 393-401, 417, 436-440, 449-456, 469-470, 495, 512-514
backend/app/data/quality/validation_service.py                                 228     20    91%   204-205, 237, 286, 305, 355, 397-398, 437, 488, 498-499, 606-608, 615-620
backend/app/infrastructure/cache/cache_service.py                              224    117    48%   98, 121, 136-142, 158-168, 183-191, 207-219, 230-231, 243-245, 277-294, 305-326, 347, 349-351, 387-389, 405-408, 429-431, 467-469, 495-497, 505, 518-547, 553-554, 558-565, 596-639
backend/app/infrastructure/cache/cache_warming.py                              310    139    55%   63-129, 182, 225, 232-234, 244-280, 290-317, 327-353, 404-407, 465-469, 482-533, 546-571, 583-588, 707-709, 725, 742-746, 776-778, 790, 799, 822-824, 831-833, 873, 877, 911-912, 917-919, 949-950, 968, 981, 991
backend/app/infrastructure/cache/memory_cache.py                               201     99    51%   36, 81, 89-100, 104-107, 127-130, 156, 172, 179-181, 192-197, 208-218, 222-225, 233-245, 264-271, 297-300, 308-309, 313-316, 372-373, 400, 417-420, 434-438, 446-455, 480-506
backend/app/infrastructure/cache/middleware.py                                 155    155     0%   6-427
backend/app/infrastructure/cache/redis_manager.py                              237    112    53%   79, 106, 113, 135, 161-179, 222-224, 238-239, 243-244, 261-265, 290, 295, 302-304, 321-323, 344-346, 359-361, 373-379, 390-394, 409-416, 424-442, 451-452, 460-466, 476-478, 489, 505-507, 518-522, 526-528, 553-585
backend/app/infrastructure/database/index_optimization.py                      145    145     0%   1-460
backend/app/infrastructure/database/init_db.py                                 140    121    14%   22-25, 29-36, 40-64, 68-96, 100-125, 129-171, 175-211, 215-262, 274-275, 280-281, 286-287
backend/app/infrastructure/database/migration_manager.py                       203    171    16%   44-50, 54-57, 61-83, 87-98, 102-110, 114-122, 126-195, 199-229, 233-256, 260-298, 302-306, 317-361, 366-424, 430
backend/app/infrastructure/database/migrations.py                              122    122     0%   1-374
backend/app/infrastructure/database/models.py                                  390      0   100%
backend/app/infrastructure/database/session.py                                  31      8    74%   17, 19, 21-24, 32, 57-58
backend/app/infrastructure/error_handling_service.py                           148     68    54%   79-80, 94-100, 109-116, 123-129, 136-143, 212-229, 249-259, 277-287, 293-321, 334-343, 347-357, 361-379, 383-405, 409-438, 442-446, 463, 475
backend/app/infrastructure/logging_service.py                                  229    112    51%   105-108, 123, 131-142, 162-184, 244, 267-285, 320-338, 365-393, 417-456, 470-505, 536-547, 554-557, 600-602, 606-639
backend/app/infrastructure/monitoring/middleware.py                            128     37    71%   121-123, 127-144, 170-172, 220, 222, 231-234, 246-247, 260-261, 268-269, 330-331, 343-344, 355-361, 382-388
backend/app/infrastructure/monitoring/performance_monitor.py                   240     66    72%   167-169, 222-223, 294, 365, 382, 392-393, 405-438, 444-453, 469-492, 516-517, 522-524, 541-558, 596-617
backend/app/infrastructure/performance/performance_optimization_service.py     322     62    81%   150, 247, 260, 269-273, 293, 343-345, 369-370, 410-413, 440-464, 477-503, 515-523, 550-551, 564, 570-580, 590-591, 645-646
backend/app/jobs/update_daily_metrics.py                                       232    150    35%   64-66, 88-90, 116-313, 334-337, 343, 375-376, 386-389, 395-498, 508-528
backend/app/schemas/annual_earnings.py                                          13      0   100%
backend/app/schemas/asset_config.py                                            194      0   100%
backend/app/schemas/asset_types.py                                              35      4    89%   133, 138, 143-144
backend/app/schemas/auth_schemas.py                                            133     27    80%   28-30, 35-43, 99-101, 106-114, 133-135
backend/app/schemas/backtest.py                                                106      9    92%   85-92, 97-99
backend/app/schemas/commodity.py                                                 5      0   100%
backend/app/schemas/corporate_action.py                                         15      0   100%
backend/app/schemas/fundamental.py                                              23      0   100%
backend/app/schemas/industry.py                                                 10      0   100%
backend/app/schemas/screener.py                                                 64      0   100%
backend/app/schemas/stock.py                                                    52      0   100%
backend/app/services/auth_service.py                                            84     53    37%   23-25, 37, 41, 47-57, 61-65, 71-77, 83-95, 107-124, 128-138, 142-152, 156, 160-165, 169-175
backend/app/services/backtest_service.py                                        19     19     0%   6-128
backend/app/services/screener_service.py                                        33     16    52%   54-89, 110-137, 154, 183, 212, 234, 249, 265
backend/app/services/stock_service.py                                          166    134    19%   71-88, 104-127, 149-189, 212-236, 249-270, 287-306, 323-342, 355-377, 389-419, 427-441, 449-480
backend/app/websocket/connection_manager.py                                    214    104    51%   56, 88-90, 108-109, 118-126, 141-142, 166-168, 207-209, 231-235, 241-267, 301-302, 316, 341-344, 348, 364-441, 489-506
backend/app/websocket/data_stream_service.py                                   256    227    11%   26-42, 48-55, 61-78, 90-123, 135-163, 173-224, 240-255, 270-314, 329-342, 357-370, 382-396, 408-422, 434-445, 458-477, 487-498, 504-542, 551, 560-577, 587-603
backend/app/websocket/message_handler.py                                       104     86    17%   21-24, 40-66, 76-99, 109-125, 137-147, 159-175, 187-193, 205-250, 263-275, 284, 293
----------------------------------------------------------------------------------------------------------
TOTAL                                                                        10221   4860    52%
Coverage HTML written to dir htmlcov
FAIL Required test coverage of 80% not reached. Total coverage: 52.45%
=========================== short test summary info ============================
PASSED backend/tests/integration/analytics/test_strategy_backtest_integration.py::TestStrategyBacktestIntegration::test_strategy_creation_and_backtest_integration
PASSED backend/tests/integration/analytics/test_strategy_backtest_integration.py::TestStrategyBacktestIntegration::test_service_layer_integration
PASSED backend/tests/integration/analytics/test_strategy_backtest_integration.py::TestStrategyBacktestIntegration::test_complete_workflow_with_mock_data
PASSED backend/tests/integration/test_admin.py::test_clear_cache_success
PASSED backend/tests/integration/test_admin.py::test_clear_cache_database_error
PASSED backend/tests/integration/test_admin.py::test_clear_cache_redis_error
PASSED backend/tests/integration/test_admin.py::test_clear_cache_empty_database_result
PASSED backend/tests/integration/test_admin.py::test_clear_cache_large_deletion_numbers
PASSED backend/tests/integration/test_cache_integration.py::TestCacheServiceIntegration::test_cache_service_basic_operations
PASSED backend/tests/integration/test_cache_integration.py::TestCacheServiceIntegration::test_cache_expiration
PASSED backend/tests/integration/test_cache_integration.py::TestCacheServiceIntegration::test_cache_pattern_operations
PASSED backend/tests/integration/test_cache_integration.py::TestCacheWarmingIntegration::test_stock_info_warming
PASSED backend/tests/integration/test_cache_integration.py::TestCacheWarmingIntegration::test_hot_stocks_warming
PASSED backend/tests/integration/test_cache_integration.py::TestCacheWarmingIntegration::test_incremental_update
PASSED backend/tests/integration/test_cache_integration.py::TestCacheWarmingIntegration::test_cache_warming_with_force_refresh
PASSED backend/tests/integration/test_cache_integration.py::TestPerformanceMonitoringIntegration::test_cache_operations_monitoring
PASSED backend/tests/integration/test_cache_integration.py::TestPerformanceMonitoringIntegration::test_api_performance_monitoring
PASSED backend/tests/integration/test_cache_integration.py::TestPerformanceMonitoringIntegration::test_metrics_summary_generation
PASSED backend/tests/integration/test_cache_integration.py::TestFullSystemIntegration::test_complete_cache_workflow
PASSED backend/tests/integration/test_cache_integration.py::TestFullSystemIntegration::test_cache_performance_under_load
PASSED backend/tests/integration/test_cache_integration.py::TestFullSystemIntegration::test_cache_consistency_after_updates
PASSED backend/tests/integration/test_screener_integration.py::TestScreenerIntegration::test_screen_stocks_no_conditions
PASSED backend/tests/integration/test_screener_integration.py::TestScreenerIntegration::test_screen_stocks_with_pe_filter
PASSED backend/tests/integration/test_screener_integration.py::TestScreenerIntegration::test_screen_stocks_with_market_cap_filter
PASSED backend/tests/integration/test_screener_integration.py::TestScreenerIntegration::test_screen_stocks_pagination
PASSED backend/tests/integration/test_screener_integration.py::TestScreenerIntegration::test_screen_stocks_multiple_conditions
PASSED backend/tests/integration/test_services.py::test_update_stock_list_from_akshare
PASSED backend/tests/integration/test_services.py::test_update_us_stock_list
PASSED backend/tests/integration/test_services.py::test_clear_all_financial_data
PASSED backend/tests/integration/test_services.py::test_store_stock_data_insert
PASSED backend/tests/integration/test_services.py::test_store_stock_data_upsert
PASSED backend/tests/integration/test_services.py::test_store_corporate_actions
PASSED backend/tests/integration/test_services.py::test_store_fundamental_data
PASSED backend/tests/integration/test_services.py::test_store_annual_earnings
PASSED backend/tests/integration/test_services.py::test_fetch_from_db
PASSED backend/tests/integration/test_services.py::test_fetch_from_db_when_data_is_fresh
PASSED backend/tests/integration/test_services.py::test_fetch_from_api_when_db_stale
PASSED backend/tests/integration/test_services.py::test_fetch_us_stock_directly_from_api
PASSED backend/tests/integration/test_services.py::test_fetch_minute_data_bypasses_db
PASSED backend/tests/integration/test_update_daily_metrics.py::TestCalculateTechnicalMetrics::test_calculate_technical_metrics_success
PASSED backend/tests/integration/test_update_daily_metrics.py::TestCalculateTechnicalMetrics::test_calculate_technical_metrics_empty_dataframe
PASSED backend/tests/integration/test_update_daily_metrics.py::TestCalculateTechnicalMetrics::test_calculate_technical_metrics_insufficient_data
PASSED backend/tests/integration/test_update_daily_metrics.py::TestCalculateTechnicalMetrics::test_calculate_technical_metrics_with_date_column
PASSED backend/tests/integration/test_update_daily_metrics.py::TestCalculateTechnicalMetrics::test_calculate_technical_metrics_with_nan_values
PASSED backend/tests/integration/test_update_daily_metrics.py::TestFetchAShareFundamentals::test_fetch_a_share_fundamentals_success
PASSED backend/tests/integration/test_update_daily_metrics.py::TestFetchAShareFundamentals::test_fetch_a_share_fundamentals_exception_handling
PASSED backend/tests/integration/test_update_daily_metrics.py::TestUpdateMetricsForMarket::test_update_metrics_for_market_success
PASSED backend/tests/integration/test_update_daily_metrics.py::TestUpdateMetricsForMarket::test_update_metrics_for_market_no_data
PASSED backend/tests/integration/test_update_daily_metrics.py::TestUpdateMetricsForMarket::test_update_metrics_for_market_update_existing
PASSED backend/tests/integration/test_update_daily_metrics.py::TestUpdateMetricsForMarket::test_update_metrics_for_market_exception_handling
PASSED backend/tests/integration/test_update_daily_metrics.py::TestIntegration::test_full_workflow
PASSED backend/tests/integration/test_websocket_error.py::test_websocket_rapid_connections
PASSED backend/tests/integration/test_websocket_error.py::test_websocket_connection_without_client_id
PASSED backend/tests/integration/test_websocket_stress.py::test_websocket_connection_lifecycle
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestStrategyAPI::test_create_strategy_success
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestStrategyAPI::test_create_strategy_invalid_data
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestStrategyAPI::test_get_all_strategies
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestStrategyAPI::test_get_strategy_by_id
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestStrategyAPI::test_get_strategy_not_found
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestStrategyAPI::test_update_strategy
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestStrategyAPI::test_delete_strategy
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestBacktestAPI::test_get_all_backtest_results
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestBacktestAPI::test_get_backtest_result_by_id
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestBacktestAPI::test_get_backtest_result_not_found
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestBacktestExecution::test_run_backtest_success
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestBacktestExecution::test_run_backtest_strategy_not_found
PASSED backend/tests/unit/analytics/test_api_endpoints.py::TestBacktestExecution::test_run_backtest_invalid_parameters
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestStrategyModels::test_strategy_model_creation
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestStrategyModels::test_backtest_result_model_creation
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestStrategySchema::test_strategy_definition_validation
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestStrategySchema::test_invalid_interval_validation
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestStrategyService::test_create_strategy
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestStrategyService::test_get_user_strategies
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestBacktestEngine::test_engine_initialization
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestBacktestEngine::test_data_preprocessing
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestBacktestEngine::test_portfolio_value_update
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestBacktestEngine::test_performance_metrics_calculation
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestBacktestEngine::test_max_drawdown_calculation
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestSignalGenerator::test_sma_calculation
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestSignalGenerator::test_rsi_calculation
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestSignalGenerator::test_condition_evaluation
PASSED backend/tests/unit/analytics/test_strategy_backtest.py::TestSignalGenerator::test_strategy_templates
PASSED backend/tests/unit/app/api/v1/test_a_industries.py::test_overview_em_with_fallback
PASSED backend/tests/unit/app/api/v1/test_a_industries.py::test_overview_ths_provider
PASSED backend/tests/unit/app/api/v1/test_backtest_api.py::test_run_grid_backtest_success
PASSED backend/tests/unit/app/api/v1/test_backtest_api.py::test_run_grid_backtest_value_error
PASSED backend/tests/unit/app/api/v1/test_backtest_api.py::test_run_grid_backtest_unexpected_error
PASSED backend/tests/unit/app/api/v1/test_backtest_api.py::test_run_grid_backtest_missing_required_fields
PASSED backend/tests/unit/app/api/v1/test_backtest_api.py::test_run_grid_backtest_invalid_date_format
PASSED backend/tests/unit/app/api/v1/test_backtest_api.py::test_run_grid_backtest_end_date_before_start_date
PASSED backend/tests/unit/app/api/v1/test_backtest_api.py::test_run_grid_backtest_invalid_date_range
PASSED backend/tests/unit/app/api/v1/test_backtest_api.py::test_run_grid_backtest_large_grid_levels
PASSED backend/tests/unit/app/api/v1/test_commodities.py::test_get_commodity_data_success
PASSED backend/tests/unit/app/api/v1/test_commodities.py::test_get_commodity_data_not_found
PASSED backend/tests/unit/app/api/v1/test_commodities.py::test_get_commodity_list_success[asyncio]
PASSED backend/tests/unit/app/api/v1/test_commodities.py::test_get_commodity_list_akshare_fails[asyncio]
PASSED backend/tests/unit/app/api/v1/test_commodities.py::test_get_commodity_list_success[trio]
PASSED backend/tests/unit/app/api/v1/test_commodities.py::test_get_commodity_list_akshare_fails[trio]
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_read_top_cryptos_success
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_read_top_cryptos_not_found
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_read_crypto_history_success
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_read_crypto_history_not_found
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_get_top_cryptos_success
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_get_top_cryptos_no_data
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_get_top_cryptos_missing_data_key
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_get_top_cryptos_request_exception
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_aggregate_ohlcv_daily_interval
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_aggregate_ohlcv_weekly_interval
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_aggregate_ohlcv_monthly_interval
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_aggregate_ohlcv_empty_data
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_aggregate_ohlcv_invalid_interval
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_get_crypto_ohlcv_daily_success
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_get_crypto_ohlcv_weekly_success
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_get_crypto_ohlcv_monthly_success
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_get_crypto_ohlcv_no_data
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_get_crypto_ohlcv_missing_data_structure
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_get_crypto_ohlcv_request_exception
PASSED backend/tests/unit/app/api/v1/test_crypto.py::test_get_crypto_ohlcv_interval_limit_adjustment
PASSED backend/tests/unit/app/api/v1/test_futures.py::test_get_futures_data_success
PASSED backend/tests/unit/app/api/v1/test_futures.py::test_get_futures_data_not_found
PASSED backend/tests/unit/app/api/v1/test_futures.py::test_get_futures_list_success
PASSED backend/tests/unit/app/api/v1/test_futures.py::test_get_futures_list_akshare_fails
PASSED backend/tests/unit/app/api/v1/test_options.py::test_get_option_expirations_success
PASSED backend/tests/unit/app/api/v1/test_options.py::test_get_option_expirations_not_found
PASSED backend/tests/unit/app/api/v1/test_options.py::test_get_option_chain_success
PASSED backend/tests/unit/app/api/v1/test_options.py::test_get_option_chain_failure
PASSED backend/tests/unit/app/api/v1/test_options.py::test_get_options_data_success
PASSED backend/tests/unit/app/api/v1/test_options.py::test_get_options_data_empty
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestBaostockSession::test_baostock_session_success
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestBaostockSession::test_baostock_session_login_failure
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestBaostockQueryWithRetry::test_baostock_query_success_first_attempt
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestBaostockQueryWithRetry::test_baostock_query_network_error_retry
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestBaostockQueryWithRetry::test_baostock_query_data_mismatch_handling
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestBaostockQueryWithRetry::test_baostock_query_empty_data
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestBaostockQueryWithRetry::test_baostock_query_circuit_breaker
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestFetchAnnualNetProfit::test_fetch_annual_net_profit_success
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestFetchAnnualNetProfit::test_fetch_annual_net_profit_no_data
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestFetchAnnualNetProfit::test_fetch_annual_net_profit_invalid_profit_value
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestFetchAnnualNetProfit::test_fetch_annual_net_profit_symbol_conversion
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestUpdateStockListFromAkshare::test_update_stock_list_success
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestUpdateStockListFromAkshare::test_update_stock_list_market_failure
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestUpdateStockListFromAkshare::test_update_stock_list_column_fallback
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestUpdateStockListFromAkshare::test_update_stock_list_etf_suffix_detection
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_a_share_fetcher.py::TestUpdateStockListFromAkshare::test_update_stock_list_all_markets_fail
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestConvertTsCodeToYfinance::test_convert_sh_suffix
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestConvertTsCodeToYfinance::test_convert_no_suffix
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestConvertTsCodeToYfinance::test_convert_sz_suffix
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestFetchFromYfinance::test_fetch_from_yfinance_success
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestFetchFromYfinance::test_fetch_from_yfinance_empty_response
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestFetchFromYfinance::test_fetch_from_yfinance_multiindex_columns
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestFetchFromYfinance::test_fetch_from_yfinance_weekly_interval
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestFetchFromYfinance::test_fetch_from_yfinance_monthly_interval
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestFetchFromYfinance::test_fetch_from_yfinance_invalid_interval
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestFetchFromYfinance::test_fetch_from_yfinance_missing_adj_close
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestFetchFromYfinance::test_fetch_from_yfinance_nan_dates_handling
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestFetchFromYfinance::test_fetch_from_yfinance_symbol_conversion
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestUpdateUsStockList::test_update_us_stock_list_success
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestUpdateUsStockList::test_update_us_stock_list_sp500_failure
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestUpdateUsStockList::test_update_us_stock_list_all_failures
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestUpdateUsStockList::test_update_us_stock_list_empty_lists
PASSED backend/tests/unit/app/data/fetchers/stock_fetchers/test_us_stock_fetcher.py::TestUpdateUsStockList::test_update_us_stock_list_duplicate_symbols
PASSED backend/tests/unit/app/data/fetchers/test_data_fetcher.py::TestGetAllStocksList::test_get_all_stocks_list_a_share_empty_cache
PASSED backend/tests/unit/app/data/fetchers/test_data_fetcher.py::TestGetAllStocksList::test_get_all_stocks_list_a_share_with_cache
PASSED backend/tests/unit/app/data/fetchers/test_data_fetcher.py::TestGetAllStocksList::test_get_all_stocks_list_us_stock_empty_cache
PASSED backend/tests/unit/app/data/fetchers/test_data_fetcher.py::TestGetAllStocksList::test_get_all_stocks_list_unknown_market
PASSED backend/tests/unit/app/data/fetchers/test_data_fetcher.py::TestGetAllStocksList::test_get_all_stocks_list_update_failure
PASSED backend/tests/unit/app/data/fetchers/test_data_fetcher.py::TestForceUpdateStockList::test_force_update_stock_list_a_share_success
PASSED backend/tests/unit/app/data/fetchers/test_data_fetcher.py::TestForceUpdateStockList::test_force_update_stock_list_us_stock_success
PASSED backend/tests/unit/app/data/fetchers/test_data_fetcher.py::TestForceUpdateStockList::test_force_update_stock_list_unknown_market
PASSED backend/tests/unit/app/data/fetchers/test_data_fetcher.py::TestForceUpdateStockList::test_force_update_stock_list_a_share_failure
PASSED backend/tests/unit/app/data/fetchers/test_data_fetcher.py::TestForceUpdateStockList::test_force_update_stock_list_us_stock_failure
PASSED backend/tests/unit/app/data/managers/test_data_utils.py::test_calculate_ma_with_sufficient_data
PASSED backend/tests/unit/app/data/managers/test_data_utils.py::test_calculate_ma_with_insufficient_data
PASSED backend/tests/unit/app/data/managers/test_data_utils.py::test_calculate_ma_with_minimal_data
PASSED backend/tests/unit/app/data/managers/test_data_utils.py::test_calculate_ma_empty_dataframe
PASSED backend/tests/unit/app/data/managers/test_data_utils.py::test_calculate_ma_missing_close_column
PASSED backend/tests/unit/app/data/managers/test_data_utils.py::test_calculate_ma_with_nan_values
PASSED backend/tests/unit/app/data/managers/test_data_utils.py::test_calculate_ma_preserves_original_data
PASSED backend/tests/unit/app/data/managers/test_data_utils.py::test_calculate_ma_with_string_data
PASSED backend/tests/unit/app/data/managers/test_data_utils.py::test_calculate_ma_edge_case_exactly_ma_period
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_batch_deduplicate_data
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_calculate_similarity
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_concurrent_processing
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_edge_cases
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_find_database_duplicates
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_find_duplicates_exact_match
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_find_duplicates_in_list
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_find_duplicates_partial_match
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_generate_data_hash
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_generate_deduplication_report
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_get_duplicate_statistics
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_identify_duplicate_type
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_memory_efficiency
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_performance_with_large_dataset
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_remove_database_duplicates
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_remove_duplicates_keep_first
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_remove_duplicates_keep_highest_quality
PASSED backend/tests/unit/app/data/quality/test_data_deduplication_service.py::TestDataDeduplicationService::test_remove_duplicates_keep_last
PASSED backend/tests/unit/app/data/quality/test_data_quality_integration.py::TestDataQualityIntegration::test_async_processing_integration
PASSED backend/tests/unit/app/data/quality/test_data_quality_integration.py::TestDataQualityIntegration::test_complete_data_quality_workflow
PASSED backend/tests/unit/app/data/quality/test_data_quality_integration.py::TestDataQualityIntegration::test_concurrent_processing_integration
PASSED backend/tests/unit/app/data/quality/test_data_quality_integration.py::TestDataQualityIntegration::test_data_quality_metrics_collection
PASSED backend/tests/unit/app/data/quality/test_data_quality_integration.py::TestDataQualityIntegration::test_end_to_end_data_pipeline
PASSED backend/tests/unit/app/data/quality/test_data_quality_integration.py::TestDataQualityIntegration::test_error_handling_integration
PASSED backend/tests/unit/app/data/quality/test_data_quality_integration.py::TestDataQualityIntegration::test_error_recovery_and_resilience
PASSED backend/tests/unit/app/data/quality/test_data_quality_integration.py::TestDataQualityIntegration::test_memory_management_during_processing
PASSED backend/tests/unit/app/data/quality/test_data_quality_integration.py::TestDataQualityIntegration::test_performance_optimization_integration
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_batch_validate_data
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_calculate_quality_score
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_edge_cases
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_get_validation_rules
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_log_validation_result
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_performance_with_large_dataset
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_change_percent_invalid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_change_percent_valid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_date_invalid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_date_valid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_price_invalid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_price_relationships_invalid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_price_relationships_valid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_price_valid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_stock_code_invalid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_stock_code_valid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_stock_data_complete_invalid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_stock_data_complete_valid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_volume_invalid
PASSED backend/tests/unit/app/data/quality/test_data_validation_service.py::TestDataValidationService::test_validate_volume_valid
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheService::test_get_cache_miss
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheService::test_get_cache_hit
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheService::test_set_cache
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheService::test_delete_cache
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheService::test_exists_cache
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheService::test_clear_by_pattern
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheService::test_get_cache_stats
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheService::test_health_check_success
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheService::test_health_check_failure
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheKeyManager::test_stock_info_key
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheKeyManager::test_stock_data_key
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheKeyManager::test_filter_result_key
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheKeyManager::test_user_session_key
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheKeyManager::test_api_cache_key
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheKeyManager::test_key_with_hash
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheWarmingService::test_warm_cache
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheWarmingService::test_get_hot_stocks
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheWarmingService::test_incremental_update_stocks
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheWarmingService::test_get_warming_stats
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheWarmingService::test_is_healthy
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheWarmingService::test_warm_specific_stocks
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheIntegration::test_cache_workflow
PASSED backend/tests/unit/app/infrastructure/cache/test_cache_service.py::TestCacheIntegration::test_cache_performance
PASSED backend/tests/unit/app/infrastructure/database/test_db_session.py::test_session_local_creation
PASSED backend/tests/unit/app/infrastructure/database/test_db_session.py::test_base_declarative_base
PASSED backend/tests/unit/app/infrastructure/database/test_db_session.py::test_engine_configuration
PASSED backend/tests/unit/app/infrastructure/database/test_db_session.py::test_get_db_generator
PASSED backend/tests/unit/app/infrastructure/database/test_db_session.py::test_get_db_session_cleanup
PASSED backend/tests/unit/app/infrastructure/database/test_db_session.py::test_get_db_is_generator
PASSED backend/tests/unit/app/infrastructure/database/test_db_session.py::test_session_local_autocommit_setting
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMetric::test_performance_metric_creation
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMetric::test_performance_metric_to_dict
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestCacheStats::test_cache_stats_creation
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestCacheStats::test_cache_stats_hit_rate
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestCacheStats::test_cache_stats_zero_requests
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestAPIMetrics::test_api_metrics_creation
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitor::test_monitor_initialization
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitor::test_collect_system_metrics
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitor::test_record_cache_hit_miss
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitor::test_record_api_metric
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitor::test_metrics_collection
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitor::test_get_cache_summary
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitor::test_clear_old_metrics
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitor::test_start_monitoring
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitor::test_stop_monitoring
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitor::test_export_metrics
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestMonitorPerformanceDecorator::test_async_function_monitoring
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestMonitorPerformanceDecorator::test_sync_function_monitoring
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestMonitorPerformanceDecorator::test_function_with_exception
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitorIntegration::test_global_monitor_instance
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitorIntegration::test_monitor_integration_with_cache
PASSED backend/tests/unit/app/infrastructure/monitoring/test_performance_monitor.py::TestPerformanceMonitorIntegration::test_metrics_retention_policy
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestMemoryManager::test_check_memory_usage
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestMemoryManager::test_force_garbage_collection
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestMemoryManager::test_is_memory_available
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestMemoryManager::test_memory_monitor
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestCacheManager::test_cache_clear
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestCacheManager::test_cache_eviction
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestCacheManager::test_cache_operations
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestCacheManager::test_hit_rate_calculation
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceMonitorDecorator::test_performance_monitor_exception
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceMonitorDecorator::test_performance_monitor_success
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_async_process_data
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_batch_deduplicate_data
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_batch_validate
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_cache_management_integration
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_cleanup_resources
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_concurrent_processing_safety
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_error_handling_in_processing
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_get_performance_report
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_memory_management_integration
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_optimization_recommendations
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_parallel_validate
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_performance_metrics_calculation
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_performance_with_different_modes
PASSED backend/tests/unit/app/infrastructure/performance/test_performance_optimization_service.py::TestPerformanceOptimizationService::test_sequential_validate
PASSED backend/tests/unit/app/services/test_screener_service.py::TestScreenerService::test_get_operator_expression
PASSED backend/tests/unit/app/services/test_screener_service.py::TestScreenerService::test_screen_stocks_no_conditions
PASSED backend/tests/unit/app/services/test_screener_service.py::TestScreenerService::test_screen_stocks_with_pe_filter
PASSED backend/tests/unit/app/services/test_screener_service.py::TestScreenerService::test_screen_stocks_pagination
PASSED backend/tests/unit/app/test_main.py::test_read_main
PASSED backend/tests/unit/app/test_main.py::test_health_check
PASSED backend/tests/unit/app/websocket/test_websocket_manager.py::TestConnectionManager::test_connect_client
PASSED backend/tests/unit/app/websocket/test_websocket_manager.py::TestConnectionManager::test_disconnect_client
PASSED backend/tests/unit/app/websocket/test_websocket_manager.py::TestConnectionManager::test_send_to_client
PASSED backend/tests/unit/app/websocket/test_websocket_manager.py::TestConnectionManager::test_send_to_nonexistent_client
PASSED backend/tests/unit/app/websocket/test_websocket_manager.py::TestConnectionManager::test_subscribe_to_topic
PASSED backend/tests/unit/app/websocket/test_websocket_manager.py::TestConnectionManager::test_unsubscribe_from_topic
PASSED backend/tests/unit/app/websocket/test_websocket_manager.py::TestConnectionManager::test_broadcast_to_topic
PASSED backend/tests/unit/app/websocket/test_websocket_manager.py::TestConnectionManager::test_multiple_clients_same_topic
PASSED backend/tests/unit/app/websocket/test_websocket_manager.py::TestConnectionManager::test_client_disconnect_removes_subscriptions
PASSED backend/tests/unit/app/websocket/test_websocket_manager.py::TestConnectionManager::test_get_connection_stats
PASSED backend/tests/unit/app/websocket/test_websocket_manager.py::TestConnectionManager::test_get_topic_subscribers
FAILED backend/tests/integration/analytics/test_strategy_backtest_integration.py::TestErrorHandlingIntegration::test_invalid_strategy_definition
FAILED backend/tests/integration/analytics/test_strategy_backtest_integration.py::TestErrorHandlingIntegration::test_insufficient_data_for_indicators
FAILED backend/tests/integration/test_services.py::test_fetch_from_api_when_db_empty
FAILED backend/tests/integration/test_websocket_basic.py::test_websocket_subscription
FAILED backend/tests/integration/test_websocket_basic.py::test_websocket_connection_only
FAILED backend/tests/integration/test_websocket_error.py::test_websocket_invalid_json
FAILED backend/tests/integration/test_websocket_error.py::test_websocket_invalid_message_type
FAILED backend/tests/integration/test_websocket_error.py::test_websocket_malformed_subscribe
FAILED backend/tests/integration/test_websocket_error.py::test_websocket_large_message
FAILED backend/tests/integration/test_websocket_error.py::test_websocket_concurrent_subscriptions
FAILED backend/tests/integration/test_websocket_fix.py::test_single_connection
FAILED backend/tests/integration/test_websocket_fix.py::test_multiple_connections
FAILED backend/tests/integration/test_websocket_stress.py::test_websocket_multiple_connections
FAILED backend/tests/integration/test_websocket_stress.py::test_websocket_message_burst
FAILED backend/tests/integration/test_websocket_stress.py::test_websocket_concurrent_operations
FAILED backend/tests/integration/test_websocket_stress.py::test_websocket_long_running_connection
FAILED backend/tests/integration/test_websocket_subscription.py::test_subscription
FAILED backend/tests/integration/test_websocket_subscription.py::test_ping - ...
FAILED backend/tests/unit/analytics/test_strategy_backtest.py::TestBacktestEngine::test_trade_execution_buy
FAILED backend/tests/unit/analytics/test_strategy_backtest.py::TestBacktestEngine::test_trade_execution_sell
20 failed, 320 passed in 44.25s
